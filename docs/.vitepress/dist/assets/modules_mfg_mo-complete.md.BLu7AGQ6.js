import{_ as i,c as a,o as t,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"完工入库与结案 (MO Complete) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/mfg/mo-complete.md","filePath":"modules/mfg/mo-complete.md"}'),e={name:"modules/mfg/mo-complete.md"};function n(h,s,o,r,p,k){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="完工入库与结案-mo-complete-开发者详尽指南" tabindex="-1">完工入库与结案 (MO Complete) - 开发者详尽指南 <a class="header-anchor" href="#完工入库与结案-mo-complete-开发者详尽指南" aria-label="Permalink to &quot;完工入库与结案 (MO Complete) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>完工入库（Completion）是制造流程的“终点线”，也是财务核算的“起跑线”。开发者必须理解：这不仅仅是将库存数量加 1，更涉及<strong>WIP 结转、质量判定、成本差异挤入</strong>以及<strong>需求关闭</strong>的复杂逻辑。</p><hr><h2 id="_1-完工申报与质量判定-declaration-inspection" tabindex="-1">1. 完工申报与质量判定 (Declaration &amp; Inspection) <a class="header-anchor" href="#_1-完工申报与质量判定-declaration-inspection" aria-label="Permalink to &quot;1. 完工申报与质量判定 (Declaration &amp; Inspection)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“明明还没检完，仓库就给入库了，结果发货发了次品”</strong>。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>质量锁 (Quality Gate)</strong>: <ul><li>开发者需实现“报检-检验-入库”的严格流水线。</li><li><strong>逻辑</strong>: <code>IF (Item.Is_Inspection_Required == True AND MO_Report.Inspect_Status != &#39;Qualified&#39;) THEN BLOCK_INVENTORY_IN</code>。</li></ul></li><li><strong>自动触发入库</strong>: <ul><li>对于免检物料，开发者应提供“一键完工”接口，同时完成汇报与入库事务。</li><li><strong>事务处理</strong>: 必须确保 MO 状态更新与库存增加的原子性。</li></ul></li></ul><h3 id="postgresql-实现建议" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>原子事务控制</strong>: 使用 <code>BEGIN</code> ... <code>COMMIT</code> 包裹申报与入库逻辑，利用 <code>EXCEPTION</code> 捕获库存不足或状态冲突，确保数据一致性。</li><li><strong>行级锁 (FOR UPDATE)</strong>: 在更新 MO 状态前，使用 <code>SELECT * FROM MO WHERE ID = ? FOR UPDATE</code> 锁定记录，防止并发完工导致的数据错乱。</li><li><strong>触发器校验</strong>: 可在 <code>inventory_transaction</code> 表上设置 <code>BEFORE INSERT</code> 触发器，强制校验关联 MO 的检验状态，作为数据库层的最后一道防线。</li></ul><hr><h2 id="_2-在制品-wip-结转与清理-wip-clearing" tabindex="-1">2. 在制品 (WIP) 结转与清理 (WIP Clearing) <a class="header-anchor" href="#_2-在制品-wip-结转与清理-wip-clearing" aria-label="Permalink to &quot;2. 在制品 (WIP) 结转与清理 (WIP Clearing)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“订单入库了，但车间里还剩了 3 个螺丝没用完，账上挂着一笔烂账”。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>余料自动退库/核销</strong>: <ul><li>在 MO 结案（Close）时，开发者需扫描 <code>MO_Component_List</code>。</li><li><strong>逻辑</strong>: <code>Remaining_Qty = Issued_Qty - Standard_Required_Qty</code>。</li><li><strong>处理</strong>: 提示用户进行“余料退库”或自动生成“损耗核销凭证”。</li></ul></li><li><strong>WIP 清零算法</strong>: <ul><li>开发者需将该 MO 对应的 <code>WIP_Account</code> 余额全额结转至 <code>Finished_Goods_Inventory_Account</code>。</li></ul></li></ul><h3 id="postgresql-实现建议-1" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-1" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>批量物料处理</strong>: 使用 <code>INSERT INTO ... SELECT</code> 结合 <code>JOIN</code> 一次性生成所有余料的核销或退库草案，减少应用层循环调用。</li><li><strong>JSONB 存储 WIP 详情</strong>: 将 MO 的组件消耗快照存储在 <code>JSONB</code> 字段中，方便后续进行成本追溯和差异分析。</li><li><strong>窗口函数计算差异</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> component_id, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       issued_qty, </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(issued_qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OVER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PARTITION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_id) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_issued</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_material_issue;</span></span></code></pre></div></li></ul><hr><h2 id="_3-生产订单结案逻辑-mo-closing" tabindex="-1">3. 生产订单结案逻辑 (MO Closing) <a class="header-anchor" href="#_3-生产订单结案逻辑-mo-closing" aria-label="Permalink to &quot;3. 生产订单结案逻辑 (MO Closing)&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“订单都入库一年了，居然还能往里面领料”</strong>。</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>硬性结案约束</strong>: <ul><li>结案后，开发者必须在所有相关的增删改 API 中增加拦截：<code>IF (MO.Status == &#39;Closed&#39;) THEN REJECT</code>。</li></ul></li><li><strong>成本结平校验</strong>: <ul><li>开发者在执行结案事务前，必须校验：<code>SUM(Input_Cost) - SUM(Output_Value) ≈ 0</code>。</li><li>如果差异超过阈值，必须强制要求用户录入“差异原因代码”。</li></ul></li></ul><h3 id="postgresql-实现建议-2" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-2" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>行级安全策略 (RLS)</strong>: 对已结案的 MO 及其关联表应用 RLS 策略，直接在数据库层禁止 <code>UPDATE</code> 和 <code>INSERT</code>。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_closed_readonly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_issue_record</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INSERT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CHECK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> production_order </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Closed&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li><li><strong>布尔索引优化</strong>: 对 <code>status</code> 字段建立部分索引（Partial Index），加速对进行中订单的查询。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_active_mo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> production_order (id) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Closed&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_4-关键绩效指标-kpi-tracking" tabindex="-1">4. 关键绩效指标 (KPI Tracking) <a class="header-anchor" href="#_4-关键绩效指标-kpi-tracking" aria-label="Permalink to &quot;4. 关键绩效指标 (KPI Tracking)&quot;">​</a></h2><h3 id="企业痛点-3" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-3" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“老板想知道这个月的生产合格率和按期完工率，系统算不出来”。</p><h3 id="开发算法" tabindex="-1">开发算法 <a class="header-anchor" href="#开发算法" aria-label="Permalink to &quot;开发算法&quot;">​</a></h3><ul><li><strong>直通率 (FPY)</strong>: <code>FPY = (一次性合格量 / 总申报量) * 100%</code>。</li><li><strong>按期完工率</strong>: <code>On_Time_Rate = (Actual_Finish_Date &lt;= Plan_Finish_Date ? 1 : 0)</code>。</li><li><strong>成本偏差率</strong>: <code>Cost_Variance = (实际成本 - 标准成本) / 标准成本</code>。</li></ul><h3 id="postgresql-实现建议-3" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-3" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>物化视图 (Materialized View)</strong>: 对于复杂的 KPI 计算（如 FPY），建议使用物化视图定时刷新，避免实时查询对生产库造成的压力。</li><li><strong>时序数据处理</strong>: 利用 PG 的 <code>DATE_TRUNC</code> 进行按月/按周的 KPI 聚合分析。</li><li><strong>自定义聚合</strong>: 使用 <code>FILTER</code> 子句简化 SQL 编写：<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> actual_date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plan_date) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> on_time_rate</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_completion;</span></span></code></pre></div></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>多单位处理</strong>: 完工申报单位与入库单位不一致时的浮点数精度处理。</li><li>[ ] <strong>倒冲物料</strong>: 完工入库时，是否成功触发了“拉式（Pull）”物料的自动扣减？</li><li>[ ] <strong>反审核控制</strong>: 如果成品已经销售出库，是否禁止了完工入库单的反审核？</li><li>[ ] <strong>批次/序列号</strong>: 入库时是否强制要求生成或录入生产批次号？</li></ul>`,38)])])}const c=i(e,[["render",n]]);export{g as __pageData,c as default};
