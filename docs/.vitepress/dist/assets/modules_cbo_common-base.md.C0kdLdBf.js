import{_ as i,c as a,o as n,ae as t}from"./chunks/framework.CDjunVez.js";const c=JSON.parse('{"title":"公共基础 (Common Base) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/cbo/common-base.md","filePath":"modules/cbo/common-base.md"}'),e={name:"modules/cbo/common-base.md"};function l(h,s,r,o,k,p){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="公共基础-common-base-开发者详尽指南" tabindex="-1">公共基础 (Common Base) - 开发者详尽指南 <a class="header-anchor" href="#公共基础-common-base-开发者详尽指南" aria-label="Permalink to &quot;公共基础 (Common Base) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>公共基础模块（CBO-Base）是整个 ERP 系统的“基石”。在涉及币种、期间、税制等核心逻辑时，开发者必须利用数据库的<strong>强类型约束</strong>和<strong>范围校验</strong>特性，确保业务数据的绝对严谨。</p><hr><h2 id="_1-币种与汇率-currency-exchange-rate" tabindex="-1">1. 币种与汇率 (Currency &amp; Exchange Rate) <a class="header-anchor" href="#_1-币种与汇率-currency-exchange-rate" aria-label="Permalink to &quot;1. 币种与汇率 (Currency &amp; Exchange Rate)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>全球化企业每天都在处理不同币种。汇率是随时间波动的，采购、付款等不同时点的汇率差异会产生“汇兑损益”。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>金额存储</strong>: 必须同时存储 <code>Amount_TC</code> (交易币) 和 <code>Amount_BC</code> (本位币)。</li><li><strong>精度陷阱</strong>: <ul><li>严禁使用 <code>float</code> 或 <code>real</code>。</li><li><strong>技术实现建议</strong>: 必须使用 PostgreSQL 的 <code>numeric(20, 8)</code> 或更高精度类型。在进行本外币转换时，应在数据库函数或 Service 层统一处理舍入逻辑（Rounding）。</li></ul></li><li><strong>汇率时效</strong>: <ul><li><strong>技术实现建议</strong>: 汇率表推荐使用 <code>daterange</code> 记录有效期。这配合<strong>排除约束 (Exclusion Constraints)</strong> 可以确保同一币种对在同一时间内只有一条有效汇率。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 在数据库层强制汇率有效期不重叠</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currency_rate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CONSTRAINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rate_time_no_overlap </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXCLUDE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gist (from_currency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, to_currency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, validity_period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp;);</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_2-会计日历-accounting-calendar" tabindex="-1">2. 会计日历 (Accounting Calendar) <a class="header-anchor" href="#_2-会计日历-accounting-calendar" aria-label="Permalink to &quot;2. 会计日历 (Accounting Calendar)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>财务期间（Period）不一定等同于自然月。财务结账后，必须严禁任何业务单据倒填到已关闭的期间。</p><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>状态控制</strong>: 期间分为 <code>Open</code>（可录入）、<code>Closed</code>（已关账）、<code>Future</code>（预开）。</li><li><strong>期间判定</strong>: 所有业务单据必须根据其“业务日期”反查对应的 <code>PeriodID</code>。</li><li><strong>技术实现建议</strong>: <ul><li>使用 <code>daterange</code> 存储期间的起止时间。</li><li>编写数据库函数 <code>fn_get_period(org_id, busi_date)</code>，利用索引快速定位日期所属期间。</li><li>利用 PostgreSQL 的 <strong>Check 约束</strong> 或 <strong>Trigger</strong> 强制校验：当单据日期所属期间状态为 <code>Closed</code> 时，禁止 <code>INSERT</code> 或 <code>UPDATE</code>。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用 daterange 快速查找所属期间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> period_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> acc_calendar </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :org_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> period_range @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :busi_date::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_3-税制与税率-taxation" tabindex="-1">3. 税制与税率 (Taxation) <a class="header-anchor" href="#_3-税制与税率-taxation" aria-label="Permalink to &quot;3. 税制与税率 (Taxation)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>同一个物料，卖给内贸、外贸或作为礼品赠送，其计税逻辑完全不同。</p><h3 id="开发规范-2" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-2" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>计税平账</strong>: 必须满足 <code>不含税价 + 税额 = 含税价</code>。由于舍入差异，最后一行明细通常需要“尾差配平”。</li><li><strong>灵活配置</strong>: 税制规则应支持动态扩展。</li><li><strong>技术实现建议</strong>: <ul><li>使用 <code>JSONB</code> 存储复杂的计税公式或阶梯税率，利用 <code>jsonb_path_query</code> 实现动态计税引擎。</li><li>核心税率表同样建议使用 <code>daterange</code> 管理政策有效期，防止税率跳变导致的计算错误。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用 JSONB 存储计税逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">data-&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;rate&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tax_amount </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tax_rules </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tax_code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :tax_code;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_4-开发者-checklist" tabindex="-1">4. 开发者 Checklist <a class="header-anchor" href="#_4-开发者-checklist" aria-label="Permalink to &quot;4. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>精度对齐</strong>: 数据库金额字段是否全部定义为 <code>numeric</code> 类型？</li><li>[ ] <strong>时段重叠</strong>: 汇率和期间表是否使用了 <code>EXCLUDE</code> 约束防止时间重叠？</li><li>[ ] <strong>期间强校验</strong>: 在单据保存逻辑中，是否调用了期间状态校验函数？</li><li>[ ] <strong>尾差处理</strong>: 单据合计逻辑是否包含了含税/不含税的尾差配平算法？</li><li>[ ] <strong>附件策略</strong>: 附件存储是否根据文件大小采用了 Bytea/S3 分层存储策略？</li><li>[ ] <strong>性能</strong>: 涉及大量汇率转换的报表，是否使用了数据库端的连接缓存或物化视图？</li></ul><hr><h2 id="_5-附件存储方案-attachment-storage" tabindex="-1">5. 附件存储方案 (Attachment Storage) <a class="header-anchor" href="#_5-附件存储方案-attachment-storage" aria-label="Permalink to &quot;5. 附件存储方案 (Attachment Storage)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>ERP 系统中存在海量的扫描件、图纸和合同。如果全部存入数据库，会导致备份极其缓慢；如果全部存入文件系统，则难以保证事务一致性和安全性。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>物理存储架构</strong>: <ul><li><strong>核心原则</strong>: 数据库仅存储元数据，物理文件剥离。</li><li><strong>推荐方案</strong>: 全量使用 <strong>兼容 S3 的对象存储 (如 MinIO, OSS, S3)</strong>。</li><li><strong>例外场景 (Bytea)</strong>: 仅允许 &lt; 64KB 的超小型缩略图或临时签名存入数据库 <code>bytea</code> 字段，以减少网络往返。</li></ul></li><li><strong>一致性保证</strong>: <ul><li>采用“先落库、后上传”的模式。</li><li>清理逻辑：利用数据库触发器或定时任务，对比 <code>ObjectKey</code> 与实际文件，清理失效的孤儿文件。</li></ul></li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 附件元数据表设计</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sys_attachment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id uuid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ref_doc_id uuid, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 关联单据 ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    file_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    storage_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- &#39;D&#39;: DB (Small), &#39;S&#39;: S3 (Standard)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s3_bucket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s3_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    file_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    content_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul>`,30)])])}const g=i(e,[["render",l]]);export{c as __pageData,g as default};
