import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"销售执行 (Sales Process) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/sales-process.md","filePath":"modules/scm/sales-process.md"}'),l={name:"modules/scm/sales-process.md"};function h(e,s,k,r,p,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="销售执行-sales-process-开发者详尽指南" tabindex="-1">销售执行 (Sales Process) - 开发者详尽指南 <a class="header-anchor" href="#销售执行-sales-process-开发者详尽指南" aria-label="Permalink to &quot;销售执行 (Sales Process) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>销售执行是企业的“现金流入口”。在 ERP 开发中，销售订单（SO）是整个系统的<strong>第一动力源</strong>。它不仅是一张单据，其产生的数据涟漪会扩散到生产（MO）、采购（PO）和物流（Logistics）。开发者必须利用 PostgreSQL 的<strong>高并发控制</strong>和<strong>复杂查询能力</strong>，确保销售链条的严密性。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>变更失控</strong>：客户频繁改单，找不到最初的承诺交期和价格。</td><td style="text-align:left;"><strong>全量版本快照</strong>：禁止原地修改已核准单据，变更即升版（V1-&gt;V2），并使用 <code>JSONB</code> 固化历史。</td></tr><tr><td style="text-align:left;"><strong>库存抢夺</strong>：热门商品被多个销售员同时下单，导致“超卖”。</td><td style="text-align:left;"><strong>原子化库存锁定</strong>：利用 <code>SELECT ... FOR UPDATE</code> 结合 <code>SKIP LOCKED</code> 实现高性能、无冲突的库存抢占。</td></tr><tr><td style="text-align:left;"><strong>退货套利</strong>：客户按高价退货，但原单其实是打折买的。</td><td style="text-align:left;"><strong>原单强制溯源</strong>：RMA（退货）必须强关联原 SO 行，系统自动锁定单价，防止人为篡改。</td></tr><tr><td style="text-align:left;"><strong>回款风险</strong>：大客户信用已击穿，销售员却依然能录单出货。</td><td style="text-align:left;"><strong>事务级信用拦截</strong>：在 SO 审核事务中嵌入信用检查函数，确保“校验-锁定-扣减”原子化。</td></tr></tbody></table><hr><h2 id="_1-销售订单的需求驱动与版本化-demand-revision" tabindex="-1">1. 销售订单的需求驱动与版本化 (Demand &amp; Revision) <a class="header-anchor" href="#_1-销售订单的需求驱动与版本化-demand-revision" aria-label="Permalink to &quot;1. 销售订单的需求驱动与版本化 (Demand &amp; Revision)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>客户今天改数量，明天改交期。系统必须记录每一次变更。</p><h3 id="开发逻辑-版本演进-revision" tabindex="-1">开发逻辑：版本演进 (Revision) <a class="header-anchor" href="#开发逻辑-版本演进-revision" aria-label="Permalink to &quot;开发逻辑：版本演进 (Revision)&quot;">​</a></h3><ol><li><strong>禁止原地修改</strong>: 已核准的 SO 只能通过“变更”按钮修改。</li><li><strong>快照归档</strong>: 变更前，系统自动将当前版本存入 <code>sales_order_history</code>。</li><li><strong>版本自增</strong>: 主表 <code>version</code> 字段递增。</li></ol><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>快照存档</strong>: 利用 PostgreSQL 的 <code>to_jsonb(sales_order.*)</code> 快速生成快照。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 变更保存时的原子操作</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_order_history (so_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">snapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, to_jsonb(sales_order.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_order </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_order </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Draft&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COMMIT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_2-智能出货与库存锁定-shipping-allocation" tabindex="-1">2. 智能出货与库存锁定 (Shipping &amp; Allocation) <a class="header-anchor" href="#_2-智能出货与库存锁定-shipping-allocation" aria-label="Permalink to &quot;2. 智能出货与库存锁定 (Shipping &amp; Allocation)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>在高并发销售环境下，必须防止多个销售员抢夺同一批库存。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>硬预留 (Hard Allocation)</strong>: 订单核准时，必须锁定相应货位的库存，将其状态标记为 <code>Reserved</code>。</li><li><strong>拼单策略</strong>: 同一送货地址的多个 SO 行应自动聚合生成一张出货申请单。</li></ul><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>并发锁定</strong>: 使用 <code>FOR UPDATE SKIP LOCKED</code>。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 抢占式库存预留</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target_bins </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_bin_stock </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> available_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :needed_qty</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SKIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LOCKED</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_bin_stock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reserved_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reserved_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :needed_qty </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target_bins);</span></span></code></pre></div></li></ul><hr><h2 id="_3-rma-退货闭环与原单追溯-return-management" tabindex="-1">3. RMA 退货闭环与原单追溯 (Return Management) <a class="header-anchor" href="#_3-rma-退货闭环与原单追溯-return-management" aria-label="Permalink to &quot;3. RMA 退货闭环与原单追溯 (Return Management)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>退货不能只是简单的库存增加，必须严格追溯原单价格。</p><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>原单强关联</strong>: RMA 必须强制引用原销售订单 ID 和行 ID。</li><li><strong>价格锁定</strong>: 系统自动带出原单成交价，并在 UI 上置灰（Read-only）。</li></ul><h3 id="技术实现建议-2" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-2" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>LATERAL JOIN 溯源</strong>: 实时查询该客户历史订单中该料品的最近成交价。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- RMA 录入时自动匹配原单</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> so</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">order_no</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">price</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty_shipped</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_order_line sol</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_order so </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">so_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> so</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> so</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">customer_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :cust_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> so</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">approved_time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DESC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_4-信用控制与拦截-credit-control" tabindex="-1">4. 信用控制与拦截 (Credit Control) <a class="header-anchor" href="#_4-信用控制与拦截-credit-control" aria-label="Permalink to &quot;4. 信用控制与拦截 (Credit Control)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>信用控制是销售的最后一道防线。</p><h3 id="开发逻辑" tabindex="-1">开发逻辑 <a class="header-anchor" href="#开发逻辑" aria-label="Permalink to &quot;开发逻辑&quot;">​</a></h3><ul><li><strong>实时拦截</strong>: 信用计算逻辑应在数据库存储过程中封装。</li><li><strong>拦截点</strong>: <code>保存</code>时仅提示（Warning），<code>提交/审核</code>时强拦截（Error）。</li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>事务隔离</strong>: 库存锁定是否使用了 <code>FOR UPDATE</code>？在高并发场景下是否测试过死锁风险？</li><li>[ ] <strong>高精度</strong>: 所有的折扣计算、税金计算是否使用了 <code>numeric</code> 类型？</li><li>[ ] <strong>幂等性</strong>: 对接电商平台的订单接口是否使用了外部订单号（ExtOrderNo）配合唯一约束？</li><li>[ ] <strong>性能</strong>: 复杂的销售看板是否利用了 PostgreSQL 的 <strong>物料化视图 (Materialized Views)</strong>？</li><li>[ ] <strong>扩展性</strong>: 销售订单的自定义扩展属性是否使用了 <code>JSONB</code> 存储？</li><li>[ ] <strong>反审核拦截</strong>: 销售订单若已生成出货单或发票，是否在后端代码级禁止了弃审操作？</li></ul>`,39)])])}const E=i(l,[["render",h]]);export{g as __pageData,E as default};
