# VMI 业务管理 (VMI) - 开发者详尽指南

## 概述
VMI（Vendor Managed Inventory）在采购端体现为**“先用后付”**。开发者必须理解：这不仅是单据的堆叠，更是对**结算时点、结算价格、差异对账**的精密控制。

---

## 1. VMI 协议与规则定义 (VMI Agreement)

### 企业痛点
**“同样的料，有些供应商要求入库 30 天后必须结算，有些是领用就结，开发者如果写死了逻辑，合同就没法执行”**。

### 开发逻辑点
- **多维结算策略 (Settlement Policy)**: 
    - 开发者需在 VMI 协议中设计 `Trigger_Type` 字段。
    - **PG 实现建议**: 使用 **JSONB** 存储复杂的协议规则（如：阶梯式库龄结算、特定日期范围的优惠策略），利用其灵活性应对多变的商务合同。
- **价格快照**: 
    - VMI 结算价格是按“到货时”还是“结算时”？
    - **PG 实现建议**: 利用 PostgreSQL 的 **`numeric`** 类型确保存储的价格快照具有极高的精度，并使用 **`daterange`** 管理协议价格的有效期。

---

## 2. 自动消耗与补账引擎 (Consumption Engine)

### 企业痛点
“车间领了 5 个螺丝，我得手动去开采购单、入库单、报账单，一天干几百次，要累死人”。

### 开发逻辑点
- **后台补单任务 (Auto-Fulfillment)**: 
    - 开发者需实现一个监听 `WIP_Issue` 事件的处理器。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`NOTIFY / LISTEN`** 或 **逻辑解码 (Logical Decoding)** 机制。当领料事务提交时，自动触发异步补单进程，避免阻塞主业务流程。
- **事务一致性**: 
    - 开发者必须确保领料出库与 VMI 补账的一致性。
    - **PG 实现建议**: 使用 **两阶段提交 (2PC)** 或将关联操作封装在同一个 **数据库事务 (Transaction)** 中，利用 **`SAVEPOINT`** 实现精细化的部分失败回滚。

---

## 3. VMI 对账与红字冲销 (Reconciliation)

### 企业痛点
**“退货时麻烦大了，VMI 已经结过账的货要退回供应商，怎么冲账？”**。

### 开发逻辑点
- **红字关联逻辑**: 
    - 开发者需实现 `VMI_Return_Process`。
    - **PG 实现建议**: 使用 **`UUID`** 或 **递归 CTE** 建立原单与红字单之间的深层关联链条，确保在复杂的多次部分退货场景下，依然能准确计算剩余可退额度。
- **差异调整**: 
    - 开发者需提供 `VMI_Price_Adjustment` 接口。
    - **PG 实现建议**: 利用 **窗口函数 (Window Functions)** 快速对比协议调价前后的所有未结算行，并批量生成补差单据。

---

## 4. 供应商协同看板 (Supplier Portal)

### 企业痛点
“供应商不知道我用了多少货，天天打电话来问”。

### 开发逻辑点
- **消耗透明化**: 
    - 开发者需为供应商门户提供 `Consumption_Query_API`。
    - **PG 实现建议**: 启用 **行级安全 (RLS)** 确保供应商通过 API 只能访问属于其自身的 VMI 消耗记录，无需在代码层编写繁琐的权限过滤。
- **自动对账确认**: 
    - 开发者可设计“供应商电子对账”流程。
    - **PG 实现建议**: 使用 **JSON Schema 校验** 对供应商上传的电子对账单进行结构化验证，确保数据导入的准确性。

---

## 5. 开发者 Checklist

- [ ] **高精度计算**: 涉及结算金额的计算是否统一使用 **`numeric`**？
- [ ] **数据安全**: 敏感的价格协议是否通过 **RLS** 进行了严格的权限控制？
- [ ] **性能优化**: 对 VMI 消耗流水表是否建立了基于 `(supplier_id, settle_status)` 的 **部分索引 (Partial Index)**？
- [ ] **审计追踪**: 是否利用 **`JSONB`** 记录了结算规则变更的历史快照？
