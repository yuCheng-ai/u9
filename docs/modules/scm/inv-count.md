# 库存盘点与差异处理 - 开发者详尽指南

## 概述
盘点（Stock Count）是 ERP 系统数据的“校准仪”。开发者必须解决的核心问题是：**如何在不停止业务的情况下，完成实物与账面数据的精准核对**。这涉及到复杂的“静态快照”与“动态差异”平衡。

---

## 1. 静态快照与动态盘点 (Snapshots)

### 企业痛点
**“盘点时不能发货，整个工厂停工等我盘库”**。

### 开发逻辑点
- **账面快照 (Account Snapshot)**: 
    - 开发者需实现“一键冻结账面数”功能。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`CREATE TABLE ... AS SELECT`** 或 **`INSERT INTO ... SELECT`** 快速创建静态快照表。对于极大规模数据，可以使用 **`COPY`** 命令提高备份效率。
- **差异平衡逻辑**: 
    - 盘点期间发生的收发货记录，开发者不应直接修改快照，而是记录在 `Inventory_Transaction_After_Snapshot` 中。
    - **PG 实现建议**: 使用 **窗口函数 (Window Functions)** 结合时间戳，自动回溯盘点时刻的精确余额，而无需物理锁定仓库。
    ```sql
    -- 回溯特定时间点的库存余额
    SELECT item_id, SUM(change_qty) FILTER (WHERE trans_time <= '2023-10-01 08:00:00') as snapshot_balance
    FROM inventory_transactions
    GROUP BY item_id;
    ```

---

## 2. 盘点差异的自动化处理 (Variance Handling)

### 企业痛点
“盘亏了 10 个，我得手动开 10 个出库单，还得写原因，太麻烦”。

### 开发逻辑点
- **自动对冲单据**: 
    - 开发者需提供“差异审批通过后自动记账”接口。
    - **PG 实现建议**: 将盘点单及其生成的入/出库单据封装在同一个 **数据库事务 (Transaction)** 中，利用 **`SAVEPOINT`** 实现复杂的错误回滚逻辑，确保库存与财务单据的一致性。
- **差异分析扩展**:
    - **PG 实现建议**: 使用 **JSONB** 存储盘点过程中的异常记录（如：破损图片路径、现场备注、复核人轨迹），方便后续审计且不增加主表字段压力。

---

## 3. 周期盘点算法 (Cycle Counting)

### 企业痛点
**“我不知道哪些物料该盘了，全靠仓库管理员心情”**。

### 开发算法
- **ABC 分类驱动**: 
    - A 类（贵重）: 每月盘点。
    - B 类: 每季盘点。
    - C 类: 每年盘点。
- **调度引擎**: 
    - 开发者需编写一个 Job，每天根据 `Item.Last_Count_Date` 和 `ABC_Class` 自动产生 `Suggested_Count_Task`。
    - **PG 实现建议**: 使用 **`pg_cron`** 扩展直接在数据库层级调度盘点任务生成逻辑，减少对外部中间件的依赖。

---

## 4. 盲盘与实盘逻辑 (Blind Count)

### 企业痛点
“仓库员偷懒，直接按系统显示的数字填盘点表”。

### 开发逻辑点
- **盲盘控制 (Blind Count)**: 
    - 开发者需在 UI 或 PDA 接口中增加 `Is_Blind_Count` 参数。
- **并发安全性**:
    - **PG 实现建议**: 在执行差异过账时，使用 **`SELECT ... FOR UPDATE`** 锁定 `inventory_balance` 相关行，防止在记账瞬间发生并行的收发货事务导致数据失准。
- **审计追踪**:
    - **PG 实现建议**: 利用 PostgreSQL 的 **`Trigger`** 自动记录盘点单状态变更历史到 `audit_log` 表中，记录 `OLD` 和 `NEW` 值的差异。

---

## 5. 开发者 Checklist

- [ ] **多租户数据隔离**: 是否已配置 **RLS (Row-Level Security)** 确保不同组织的盘点单物理隔离？
- [ ] **数值精度**: 盘点差异计算是否统一使用 **`numeric`** 类型以避免浮点数精度丢失？
- [ ] **PDA 集成**: 接口是否支持连续扫描条码并自动累加实盘数量？
- [ ] **历史追溯**: 是否保存了盘点前的原始快照和盘点后的修正轨迹？
