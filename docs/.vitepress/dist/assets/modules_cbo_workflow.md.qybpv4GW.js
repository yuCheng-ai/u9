import{_ as i,c as a,o as n,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"业务流与工作流引擎 (Workflow & Flow) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/cbo/workflow.md","filePath":"modules/cbo/workflow.md"}'),t={name:"modules/cbo/workflow.md"};function h(e,s,k,p,r,o){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="业务流与工作流引擎-workflow-flow-开发者详尽指南" tabindex="-1">业务流与工作流引擎 (Workflow &amp; Flow) - 开发者详尽指南 <a class="header-anchor" href="#业务流与工作流引擎-workflow-flow-开发者详尽指南" aria-label="Permalink to &quot;业务流与工作流引擎 (Workflow &amp; Flow) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>工作流（Workflow）和业务流（Business Flow）是 ERP 的“血液循环系统”。开发者必须分清两者：<strong>工作流负责决策逻辑</strong>（谁来审），<strong>业务流负责执行逻辑</strong>（单据如何流转）。开发者应利用数据库的<strong>递归查询</strong>、<strong>事务一致性</strong>和<strong>异步通知</strong>特性，构建高效、可追溯的流程引擎。</p><hr><h2 id="_1-业务流-单据的链式转换-business-flow" tabindex="-1">1. 业务流：单据的链式转换 (Business Flow) <a class="header-anchor" href="#_1-业务流-单据的链式转换-business-flow" aria-label="Permalink to &quot;1. 业务流：单据的链式转换 (Business Flow)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“录入即生成”。销售员录入订单，审核后系统应自动在仓库生成出货单。这要求上、下游单据在数据和状态上保持强一致性。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><pre><code>- **事务保证**: 必须在同一个数据库事务内完成下游创建与上游回写。
- **元数据映射**: 使用 \`JSONB\` 存储单据间的字段映射规则（Mapping Rules），实现动态的字段转换逻辑。
- **变更追踪**: 利用 PostgreSQL 的 **Logical Decoding** 监听单据变更，实现非核心链条单据（如统计类单据）的异步自动生成。
- **示例代码**:
  \`\`\`sql
  -- 使用 JSONB 定义单据映射规则
  -- 销售订单的 \`Qty\` 映射到出库单的 \`PlanQty\`
  SELECT (mapping-&gt;&gt;&#39;source_field&#39;) as src, (mapping-&gt;&gt;&#39;target_field&#39;) as dest
  FROM flow_mapping WHERE flow_id = :id;
  \`\`\`
</code></pre><hr><h2 id="_2-工作流-审批决策与状态机-approval-workflow" tabindex="-1">2. 工作流：审批决策与状态机 (Approval Workflow) <a class="header-anchor" href="#_2-工作流-审批决策与状态机-approval-workflow" aria-label="Permalink to &quot;2. 工作流：审批决策与状态机 (Approval Workflow)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“审批逻辑天天变”。今天经理审，明天总监审，且审批条件（如金额、毛利）极度复杂。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>规则去代码化</strong>: 严禁在 Java/C# 代码中写 <code>if (amount &gt; 5000)</code>。所有审批分支应由表达式引擎驱动。</li><li><strong>层级关系查询</strong>: 审批流常需查找“发起人的主管”或“分管副总”。</li><li><strong>技术实现建议</strong>: <ul><li><strong>递归组织架构</strong>: 利用 PostgreSQL 的 <strong>Recursive CTE (递归公用表表达式)</strong>，一句话查询出 HR 组织树中的所有汇报对象。</li><li><strong>状态控制</strong>: 使用数据库 <strong>枚举类型 (ENUM)</strong> 或状态码字段，配合 <strong>Check 约束</strong>，强制保证单据只能在合法的状态间流转。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 递归查询汇报链条</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> subordinates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id, supervisor_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> employee </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :start_emp</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">supervisor_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> employee e</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> subordinates s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">supervisor_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> subordinates;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_3-性能与一致性-审计与通知-audit-notify" tabindex="-1">3. 性能与一致性：审计与通知 (Audit &amp; Notify) <a class="header-anchor" href="#_3-性能与一致性-审计与通知-audit-notify" aria-label="Permalink to &quot;3. 性能与一致性：审计与通知 (Audit &amp; Notify)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>大型集团每天有上万笔审批。系统必须记录每一跳的详细轨迹，并实时通知移动端审批人。</p><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>全轨迹审计</strong>: 记录每一步的操作人、意见、耗时及单据快照。</li><li><strong>快照保存</strong>: 审批时的单据关键信息应持久化，防止事后修改导致审计失效。</li><li><strong>技术实现建议</strong>: <ul><li><strong>快照存储</strong>: 使用 <code>JSONB</code> 字段存储审批时的单据完整快照（Snapshot），即便后续表结构变更，审计历史依然可读。</li><li><strong>实时推送</strong>: 利用 PostgreSQL 的 <strong>NOTIFY/LISTEN</strong> 机制。当审批任务生成时，数据库直接触发异步通知，由 WebSocket 或消息网关推送至用户手机。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 记录单据审批快照</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wf_audit_log (doc_id, node_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">snapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :doc_id, :node_id, to_jsonb(sales_order.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_order </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :doc_id;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_4-严谨性校验-反审核与全链路弃审-consistency" tabindex="-1">4. 严谨性校验：反审核与全链路弃审 (Consistency) <a class="header-anchor" href="#_4-严谨性校验-反审核与全链路弃审-consistency" aria-label="Permalink to &quot;4. 严谨性校验：反审核与全链路弃审 (Consistency)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><ul><li><strong>幂等性</strong>: 防止重复点击导致的多次审批执行。</li><li><strong>全链路弃审 (Un-approve)</strong>: 当单据已产生下游业务（如销售订单已生成发货单）时，系统需支持“一键反审核”或“逆序弃审”。</li></ul><h3 id="开发规范-2" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-2" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>逆序依赖检查</strong>: <ul><li>严禁直接修改单据状态。</li><li>弃审时必须递归检查所有下游单据的状态。如果下游单据已审核或已执行，必须先弃审下游，否则拦截操作。</li></ul></li><li><strong>幂等设计</strong>: 所有的审批操作必须携带唯一 <code>RequestID</code> 或 <code>Version</code> 标识。</li></ul><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>递归依赖探测</strong>: 利用数据库视图或专门的 <code>doc_links</code> 表记录单据溯源关系。</li><li><strong>原子性操作</strong>: 整个弃审链条必须在一个分布式事务（或 Saga 模式）中完成。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 递归检查下游单据是否可弃审</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downstream_docs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target_id, target_type, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> doc_links </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :current_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">target_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">target_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> doc_links l </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downstream_docs d </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">target_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downstream_docs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Draft&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Cancelled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 如果 count &gt; 0，则禁止弃审当前单据</span></span></code></pre></div></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>递归查询</strong>: 审批链条寻找主管逻辑是否使用了 <code>WITH RECURSIVE</code> 以提升性能？</li><li>[ ] <strong>快照审计</strong>: 审批历史是否包含了 <code>JSONB</code> 格式的单据快照？</li><li>[ ] <strong>状态机校验</strong>: 数据库层是否通过 <code>CHECK</code> 约束或状态枚举限制了非法的状态跳转？</li><li>[ ] <strong>实时性</strong>: 是否利用了 <code>NOTIFY</code> 或消息队列实现审批任务的秒级通知？</li><li>[ ] <strong>幂等处理</strong>: 审批接口是否通过 <code>version</code> 字段或唯一请求标识防止了重复提交？</li></ul>`,32)])])}const E=i(t,[["render",h]]);export{g as __pageData,E as default};
