import{_ as i,c as a,o as e,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"云服务集成 (Cloud Services) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/sys/cloud.md","filePath":"modules/sys/cloud.md"}'),t={name:"modules/sys/cloud.md"};function o(n,s,r,h,d,c){return e(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="云服务集成-cloud-services-开发者详尽指南" tabindex="-1">云服务集成 (Cloud Services) - 开发者详尽指南 <a class="header-anchor" href="#云服务集成-cloud-services-开发者详尽指南" aria-label="Permalink to &quot;云服务集成 (Cloud Services) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>ERP 不再是一个孤岛。云服务集成是 ERP 的“外交官”，负责将内部业务逻辑延伸到互联网。开发者必须理解：云集成不仅仅是调用一个 API，更涉及<strong>网络稳定性、身份互认、以及异构数据的同步一致性</strong>。</p><hr><h2 id="_1-电子税务与发票云-e-tax-invoice-cloud" tabindex="-1">1. 电子税务与发票云 (E-Tax &amp; Invoice Cloud) <a class="header-anchor" href="#_1-电子税务与发票云-e-tax-invoice-cloud" aria-label="Permalink to &quot;1. 电子税务与发票云 (E-Tax &amp; Invoice Cloud)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“财务每天要手工开几百张票，还得一张张去税局网站核销，效率低且容易错”</strong>。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>开票触发器</strong>: <ul><li>开发者需在销售出库或结算核准时，自动构造 <code>Tax_Invoice_Payload</code>。</li><li><strong>逻辑</strong>: <code>JSON_Request -&gt; Tax_Cloud_Gateway -&gt; Return_Invoice_Number</code>。</li></ul></li><li><strong>状态回写</strong>: <ul><li>开票成功后，开发者必须将税控系统的“发票号码”和“开票状态”回写到 ERP 的 <code>AR_Invoice</code> 表中。</li></ul></li><li><strong>电子档案存储</strong>: <ul><li>开发者需实现一个 <code>PDF_Downloader</code>，将税局返回的电子发票 PDF 自动挂载到 ERP 的单据附件中。</li></ul></li></ul><h3 id="postgresql-实现建议" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>JSONB 构造与解析</strong>: 利用 PG 的 <code>jsonb_build_object</code> 函数直接在 SQL 层构造发票请求报文，并利用 <code>JSONB</code> 字段存储税局返回的完整原始响应，方便后期排查审计。</li><li><strong>NOTIFY/LISTEN 异步触发</strong>: 结算单审核后发出 <code>NOTIFY invoice_request</code>，后台任务捕获通知并执行云开票逻辑，实现业务与集成的物理隔离。</li><li><strong>触发器维护状态</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TRIGGER</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> update_invoice_status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AFTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OF invoice_no </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ar_invoice</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EACH </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ROW</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXECUTE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log_invoice_event();</span></span></code></pre></div></li></ul><hr><h2 id="_2-友云采-数字化采购协同-supplier-collaboration" tabindex="-1">2. 友云采：数字化采购协同 (Supplier Collaboration) <a class="header-anchor" href="#_2-友云采-数字化采购协同-supplier-collaboration" aria-label="Permalink to &quot;2. 友云采：数字化采购协同 (Supplier Collaboration)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“采购员在 ERP 里下完单，还得在微信上发给供应商，供应商送没送货、到哪了，ERP 里全看不见”。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>单据双向同步</strong>: <ul><li><strong>ERP -&gt; 云端</strong>: PO 核准时，自动通过 <code>Cloud_Bus</code> 推送到友云采平台。</li><li><strong>云端 -&gt; ERP</strong>: 供应商在平台填写的 ASN（送货通知），自动在 ERP 生成 <code>ASN_Document</code>。</li></ul></li><li><strong>身份联邦 (SSO)</strong>: <ul><li>开发者需实现 OAuth2 或 OpenID 协议，确保企业用户从 ERP 点击按钮即可免密跳转到云采购平台。</li></ul></li></ul><h3 id="postgresql-实现建议-1" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-1" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>外部数据源 (postgres_fdw)</strong>: 如果云端中间库也是 PostgreSQL，可以使用 <code>postgres_fdw</code> 将其映射为本地外部表，像操作本地数据一样同步 ASN 信息。</li><li><strong>行级安全策略 (RLS)</strong>: 在同步表中应用 RLS，确保不同供应商的数据在数据库层实现逻辑隔离，防止越权访问。</li><li><strong>GIN 索引优化</strong>: 对存储 ASN 详情的 <code>JSONB</code> 字段建立 <code>GIN</code> 索引，加速对物料号、批次等关键信息的检索。</li></ul><hr><h2 id="_3-集成安全性与容错-security-resilience" tabindex="-1">3. 集成安全性与容错 (Security &amp; Resilience) <a class="header-anchor" href="#_3-集成安全性与容错-security-resilience" aria-label="Permalink to &quot;3. 集成安全性与容错 (Security &amp; Resilience)&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“云服务宕机了，我的 ERP 跟着卡死，或者单据丢了”</strong>。</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>异步消息队列 (MQ)</strong>: <ul><li>开发者严禁在主业务线程同步调用外部云接口。</li><li><strong>推荐做法</strong>: 业务单据保存 -&gt; 写入本地 <code>Outbox</code> 表 -&gt; 后台线程异步发送 -&gt; 收到确认后标记 <code>Sent</code>。</li></ul></li><li><strong>重试机制 (Retry Policy)</strong>: <ul><li>开发者需实现“指数退避”重试逻辑（1s, 2s, 4s...），处理暂时的网络抖动。</li></ul></li><li><strong>幂等校验 (Idempotency)</strong>: <ul><li>每一个上云的单据必须携带全局唯一的 <code>Request_ID</code>，防止网络重试导致云端产生重复记录。</li></ul></li></ul><h3 id="postgresql-实现建议-2" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-2" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>SKIP LOCKED 并发处理</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cloud_outbox </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Pending&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SKIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LOCKED </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div>多个后台 Worker 进程使用 <code>SKIP LOCKED</code> 语法并行抓取待发送任务，既能保证任务不重复，又能实现极高的吞吐量。</li><li><strong>自定义序列号 (UUID)</strong>: 强制使用 <code>UUID</code> 作为 <code>Request_ID</code>，并利用 PG 原生的 <code>uuid</code> 类型存储，确保全局唯一性。</li><li><strong>pg_cron 定时重试</strong>: 利用 <code>pg_cron</code> 插件定期扫描发送失败且未达到最大重试次数的任务，自动触发重试流程。</li></ul><hr><h2 id="_4-开发者-checklist" tabindex="-1">4. 开发者 Checklist <a class="header-anchor" href="#_4-开发者-checklist" aria-label="Permalink to &quot;4. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>密钥管理</strong>: 严禁在代码中硬编码 <code>API_Key</code> 和 <code>Secret</code>，必须存储在 ERP 的 <code>System_Vault</code> 或环境变量中。</li><li>[ ] <strong>日志追踪</strong>: 所有的云调用必须记录 <code>Cloud_Log</code>，包含：请求参数、返回结果、耗时、HTTP 状态码。</li><li>[ ] <strong>白名单</strong>: ERP 服务器是否已经放行了云服务商的 IP 范围？</li><li>[ ] <strong>限流保护</strong>: 开发者需在出口处增加 <code>Rate_Limiter</code>，防止短时间内大量调用导致被云端封禁。</li></ul>`,30)])])}const u=i(t,[["render",o]]);export{g as __pageData,u as default};
