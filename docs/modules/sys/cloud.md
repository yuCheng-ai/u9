# 云服务集成 (Cloud Services) - 开发者详尽指南

## 概述
ERP 不再是一个孤岛。云服务集成是 ERP 的“外交官”，负责将内部业务逻辑延伸到互联网。开发者必须理解：云集成不仅仅是调用一个 API，更涉及**网络稳定性、身份互认、以及异构数据的同步一致性**。

---

## 1. 电子税务与发票云 (E-Tax & Invoice Cloud)

### 企业痛点
**“财务每天要手工开几百张票，还得一张张去税局网站核销，效率低且容易错”**。

### 开发逻辑点
- **开票触发器**: 
    - 开发者需在销售出库或结算核准时，自动构造 `Tax_Invoice_Payload`。
    - **逻辑**: `JSON_Request -> Tax_Cloud_Gateway -> Return_Invoice_Number`。
- **状态回写**: 
    - 开票成功后，开发者必须将税控系统的“发票号码”和“开票状态”回写到 ERP 的 `AR_Invoice` 表中。
- **电子档案存储**: 
    - 开发者需实现一个 `PDF_Downloader`，将税局返回的电子发票 PDF 自动挂载到 ERP 的单据附件中。

---

## 2. 友云采：数字化采购协同 (Supplier Collaboration)

### 企业痛点
“采购员在 ERP 里下完单，还得在微信上发给供应商，供应商送没送货、到哪了，ERP 里全看不见”。

### 开发逻辑点
- **单据双向同步**: 
    - **ERP -> 云端**: PO 核准时，自动通过 `Cloud_Bus` 推送到友云采平台。
    - **云端 -> ERP**: 供应商在平台填写的 ASN（送货通知），自动在 ERP 生成 `ASN_Document`。
- **身份联邦 (SSO)**: 
    - 开发者需实现 OAuth2 或 OpenID 协议，确保企业用户从 ERP 点击按钮即可免密跳转到云采购平台。

---

## 3. 集成安全性与容错 (Security & Resilience)

### 企业痛点
**“云服务宕机了，我的 ERP 跟着卡死，或者单据丢了”**。

### 开发逻辑点
- **异步消息队列 (MQ)**: 
    - 开发者严禁在主业务线程同步调用外部云接口。
    - **推荐做法**: 业务单据保存 -> 写入本地 `Outbox` 表 -> 后台线程异步发送 -> 收到确认后标记 `Sent`。
- **重试机制 (Retry Policy)**: 
    - 开发者需实现“指数退避”重试逻辑（1s, 2s, 4s...），处理暂时的网络抖动。
- **幂等校验 (Idempotency)**: 
    - 每一个上云的单据必须携带全局唯一的 `Request_ID`，防止网络重试导致云端产生重复记录。

---

## 4. 开发者 Checklist

- [ ] **密钥管理**: 严禁在代码中硬编码 `API_Key` 和 `Secret`，必须存储在 ERP 的 `System_Vault` 或环境变量中。
- [ ] **日志追踪**: 所有的云调用必须记录 `Cloud_Log`，包含：请求参数、返回结果、耗时、HTTP 状态码。
- [ ] **白名单**: ERP 服务器是否已经放行了云服务商的 IP 范围？
- [ ] **限流保护**: 开发者需在出口处增加 `Rate_Limiter`，防止短时间内大量调用导致被云端封禁。
