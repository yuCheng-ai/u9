# 可用量检查与交付承诺 (Sales ATP) - 开发者详尽指南

## 概述
对于销售来说，ATP（Available To Promise）是**“信任的基石”**。开发者必须理解：销售 ATP 不仅仅是查查库存，它是对**未来生产能力、物流在途、以及多订单抢占逻辑**的实时模拟。

---

## 1. 销售订单的实时 ATP 校验 (Real-time Check)

### 企业痛点
**“客户在电话里下单，销售员不敢答应交货期，因为不知道下周有没有货”**。

### 开发逻辑点
- **插入式检查**: 
    - 开发者需在销售订单（SO）行录入时，实时调用 `ATP_Calculation_Service`。
    - **逻辑**: `IF (Order_Qty > ATP[Required_Date]) THEN 弹出“建议交期”面板`。
- **模拟分配**: 
    - 开发者需实现一个“沙箱分配”逻辑。在订单未保存前，临时锁定 ATP 额度 5 分钟（类似电影票锁座），防止在录入过程中被其他销售抢走。

---

## 2. 需求优先级与资源抢占 (Priority & Allocation)

### 企业痛点
“小客户先下了一单，把大客户预留的库存给占了，导致大客户流失”。

### 开发逻辑点
- **客户分级模型**: 
    - 开发者需在 ATP 引擎中引入 `Customer_Rank` 因子。
    - **分配算法**: 
        - 1. 按照 `Grade A -> Grade B -> Grade C` 的顺序扫描需求。
        - 2. 在库存不足时，开发者需支持“强制抢占”逻辑（由管理员触发），将低优先级订单的预留释放给高优先级订单。
- **公平分配算法 (Fair Share)**: 
    - 对于短缺物资，开发者可实现“按比例分配”：每个客户都分到需求量的 50%，而不是让第一个人拿走全部。

---

## 3. CTP：基于能力的承诺 (Capable To Promise)

### 企业痛点
**“仓库没货了，但我不知道工厂现在赶工能不能在 3 天内做出来”**。

### 开发逻辑点
- **CTP 穿透逻辑**: 
    - 如果 ATP 检查失败，开发者需自动调用 `APS_Simulation_API`。
    - **计算逻辑**: 
        - 1. 自动展开 BOM。
        - 2. 检查关键原材料的供应。
        - 3. 检查工作中心（Work Center）的剩余产能。
        - 4. 返回“最早可产出日期”。
- **开发注意**: 这是一个重量级计算，开发者必须采用异步回调（Callback）机制，防止前端界面卡死。

---

## 4. 订单改期与 ATP 重排 (Order Rescheduling)

### 企业痛点
“大客户突然要求提前一周交货，我得知道这会影响哪些其他客户”。

### 开发逻辑点
- **影响分析引擎**: 
    - 开发者需实现 `What-if` 分析。
    - **逻辑**: 当 A 订单日期改变时，重新运行全量 `Supply_Demand_Balancing`，并输出“受影响订单清单”。
- **自动通知**: 
    - 开发者需集成 `Notification_Service`，当订单交期因为后端波动（如生产延期）而发生变化时，自动发邮件/短信给对应的销售员。

---

## 5. 开发者 Checklist

- [ ] **性能**: ATP 查询发生在销售录单的高频时段，必须使用内存索引。
- [ ] **分布式锁**: 跨组织抢占库存时，必须使用分布式锁防止超卖。
- [ ] **物流偏移**: ATP 计算是否考虑了从工厂到客户的 `Shipping_Lead_Time`？
- [ ] **多单位**: 销售单位（箱）与基本单位（个）的换算是否会产生舍入误差导致的 ATP 失准？
