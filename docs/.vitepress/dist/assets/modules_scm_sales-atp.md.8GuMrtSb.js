import{_ as i,c as a,o as t,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"可用量检查与交付承诺 (Sales ATP) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/sales-atp.md","filePath":"modules/scm/sales-atp.md"}'),n={name:"modules/scm/sales-atp.md"};function e(h,s,r,p,k,o){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="可用量检查与交付承诺-sales-atp-开发者详尽指南" tabindex="-1">可用量检查与交付承诺 (Sales ATP) - 开发者详尽指南 <a class="header-anchor" href="#可用量检查与交付承诺-sales-atp-开发者详尽指南" aria-label="Permalink to &quot;可用量检查与交付承诺 (Sales ATP) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>对于销售来说，ATP（Available To Promise）是**“信任的基石”<strong>。在 ERP 开发中，销售 ATP 不仅仅是查询库存，它是对</strong>未来产能、在途物资以及多订单抢占逻辑<strong>的实时模拟。开发者必须利用 PostgreSQL 的</strong>时序处理能力**、<strong>窗口函数</strong>和<strong>并发控制</strong>，构建一个高性能、高准确性的交付承诺引擎。</p><hr><h2 id="_1-实时-atp-校验与软预留-real-time-check" tabindex="-1">1. 实时 ATP 校验与软预留 (Real-time Check) <a class="header-anchor" href="#_1-实时-atp-校验与软预留-real-time-check" aria-label="Permalink to &quot;1. 实时 ATP 校验与软预留 (Real-time Check)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“录单即承诺”。销售员在录入 SO 行时，系统必须在毫秒级告知该日期是否有货。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>插入式检查</strong>: 在单据行失去焦点时，自动触发 ATP 计算。</li><li><strong>模拟锁座 (Soft Reservation)</strong>: 在订单未最终保存前，临时锁定 ATP 额度。</li><li><strong>锁座超时与生命周期管理 (Lifecycle Management)</strong>: <ul><li><strong>自动释放</strong>: 系统默认设置 15-30 分钟有效期（可配置）。利用 <code>pg_cron</code> 定期清理 <code>expire_at &lt; now()</code> 的记录。</li><li><strong>手动清理</strong>: 提供“预留清理工作台”，允许计划员针对长期未转订单的预留（如大客户预留）进行手动释放。</li><li><strong>状态闭环</strong>: <ul><li><code>Active</code>: 预留中。</li><li><code>Consumed</code>: 已转正式订单，预留转为正式库存占用。</li><li><code>Expired</code>: 超时自动释放。</li><li><code>Released</code>: 手动释放。</li></ul></li><li><strong>技术实现建议</strong>: <ul><li>在 <code>atp_reservation</code> 表中增加 <code>status</code> 和 <code>expire_at</code> 字段。</li><li><strong>并发控制</strong>: 利用 <code>SELECT ... FOR UPDATE SKIP LOCKED</code> 锁定特定批次的“虚拟额度”，确保多个销售员同时下单时不产生超卖，且能快速跳过已锁定的额度。</li></ul></li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 锁座记录示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> atp_reservation (item_id, qty, expire_at)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (:item_id, :qty, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;10 min&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_2-需求优先级与资源抢占-priority-allocation" tabindex="-1">2. 需求优先级与资源抢占 (Priority &amp; Allocation) <a class="header-anchor" href="#_2-需求优先级与资源抢占-priority-allocation" aria-label="Permalink to &quot;2. 需求优先级与资源抢占 (Priority &amp; Allocation)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>当库存不足时，优先保障 Grade A 级客户，甚至需要“强制夺取”已分配给低优先级订单的额度。</p><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>优先级模型</strong>: 引入 <code>Customer_Rank</code> 和 <code>Order_Priority</code> 权重。</li><li><strong>自动/手动重排</strong>: 支持定期自动重排（Rescheduling）或管理员手动调整分配。</li><li><strong>技术实现建议</strong>: <ul><li><strong>分配算法</strong>: 使用 <strong>CTE (公用表表达式)</strong> 构建多级分配逻辑。第一层分配 A 类需求，第二层分配剩余资源给 B 类，依此类推。</li><li><strong>范围查询优化</strong>: 利用 <code>daterange</code> 存储供应/需求窗口，通过 <code>&amp;&amp;</code> 操作符快速判定需求日期是否落在供应覆盖范围内。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用 daterange 判定有效期</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_price_list </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :item_id </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> validity_period &amp;&amp; daterange(current_date, current_date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_3-ctp-基于能力的承诺-capable-to-promise" tabindex="-1">3. CTP：基于能力的承诺 (Capable To Promise) <a class="header-anchor" href="#_3-ctp-基于能力的承诺-capable-to-promise" aria-label="Permalink to &quot;3. CTP：基于能力的承诺 (Capable To Promise)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“仓库没货，但工厂现在赶工能不能在 3 天内交货？”。这需要穿透库存，直接计算生产能力。</p><h3 id="开发规范-2" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-2" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>CTP 穿透</strong>: ATP 失败时，自动触发虚拟 BOM 展开与产能负荷检查。</li><li><strong>异步响应</strong>: 这是一个重量级计算，应通过消息或长连接通知结果。</li><li><strong>技术实现建议</strong>: <ul><li><strong>递归 BOM 展开</strong>: 利用 PostgreSQL 的 <strong>Recursive CTE</strong> 进行多层 BOM 实时展开，检查关键原材料的供应（PO ATP）。</li><li><strong>产能模拟</strong>: 将工作中心（Work Center）的负荷数据存储为 <code>JSONB</code> 数组，利用数据库的并行查询能力快速寻找可插入的“生产空档”。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 递归展开 BOM 检查物料供应</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_tree </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id, component_id, qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :root_item</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">component_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INNER JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_tree bt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">component_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">component_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">atp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_tree bt </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_atp_view atp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">component_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> atp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_4-影响分析与-what-if-模拟-impact-analysis" tabindex="-1">4. 影响分析与“What-if”模拟 (Impact Analysis) <a class="header-anchor" href="#_4-影响分析与-what-if-模拟-impact-analysis" aria-label="Permalink to &quot;4. 影响分析与“What-if”模拟 (Impact Analysis)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“大客户订单提前，我想知道这会挤掉哪些小客户的货”。</p><h3 id="开发规范-3" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-3" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>模拟沙箱</strong>: 在不改变生产数据库的情况下，模拟资源重分配的结果。</li><li><strong>自动通知机制</strong>: 受影响的订单应自动标识“延期风险”，并通知销售员。</li><li><strong>技术实现建议</strong>: <ul><li><strong>物料化视图 (Materialized View)</strong>: 对于非实时的 ATP 预览，使用物料化视图预计算每日汇总数据，通过 <code>REFRESH MATERIALIZED VIEW CONCURRENTLY</code> 保证查询性能。</li><li><strong>差异比对</strong>: 使用 <code>JSONB</code> 存储模拟前后的分配快照，通过 <code>jsonb_each</code> 对比发现受影响的订单 ID 列表。</li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>性能</strong>: ATP 计算是否避免了在循环中进行 SQL 查询？是否利用了窗口函数进行单次扫描？</li><li>[ ] <strong>换算精度</strong>: 销售单位与基本单位的换算是否使用了 <code>numeric</code>，并考虑了“最后一行补差”逻辑？</li><li>[ ] <strong>清理逻辑</strong>: 软预留（锁座）的过期自动清理机制是否已通过数据库 <strong>Cron 任务</strong> 或消息队列实现？</li><li>[ ] <strong>时区处理</strong>: 跨国组织的交货期计算是否统一使用了 <code>timestamptz</code>？</li><li>[ ] <strong>索引优化</strong>: 供应需求表是否针对 <code>item_id</code> 和 <code>plan_date</code> 建立了复合索引？</li></ul>`,30)])])}const E=i(n,[["render",e]]);export{g as __pageData,E as default};
