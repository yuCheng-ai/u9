import{_ as a,c as s,o as t,ae as r}from"./chunks/framework.CDjunVez.js";const p=JSON.parse('{"title":"采购询比价与价格控制 - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/pur-price.md","filePath":"modules/scm/pur-price.md"}'),o={name:"modules/scm/pur-price.md"};function e(l,i,n,h,d,g){return t(),s("div",null,[...i[0]||(i[0]=[r(`<h1 id="采购询比价与价格控制-开发者详尽指南" tabindex="-1">采购询比价与价格控制 - 开发者详尽指南 <a class="header-anchor" href="#采购询比价与价格控制-开发者详尽指南" aria-label="Permalink to &quot;采购询比价与价格控制 - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>采购价格是企业的“利润源泉”。开发者必须理解：价格不是一个静态的字段，而是一个<strong>受供应商、批量、有效期、币种、税率</strong>多维控制的动态模型。</p><hr><h2 id="_1-价格表引擎-price-list-engine" tabindex="-1">1. 价格表引擎 (Price List Engine) <a class="header-anchor" href="#_1-价格表引擎-price-list-engine" aria-label="Permalink to &quot;1. 价格表引擎 (Price List Engine)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“同样的零件，买 10 个和买 1000 个价格不一样，开发者如果只写一个单价字段，业务员就得天天改价格”</strong>。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>分级价格模型 (Tiered Pricing)</strong>: <ul><li>开发者需支持 <code>Price_Break</code> 逻辑。</li><li><strong>PG 实现建议</strong>: 使用 <strong>JSONB</strong> 存储分级阶梯价，避免为每个物料创建过多的关联行，并利用 <code>-&gt;&gt;</code> 操作符进行快速检索。</li></ul></li><li><strong>有效期过滤</strong>: <ul><li>所有的价格获取接口必须强制传入 <code>Date</code> 参数。</li><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的 <strong><code>daterange</code></strong> 类型和 <strong><code>GIST</code> 索引</strong> 实现极其高效的有效期重叠检查。</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 检查价格有效期是否重叠</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pur_price_list </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXCLUDE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gist (supplier_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, validity_range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp;);</span></span></code></pre></div></li><li><strong>币种与税率转换</strong>: <ul><li>开发者需自动处理汇率换算。</li><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的 <strong><code>numeric</code></strong> 类型进行高精度计算，防止在处理 6-8 位单价小数时出现舍入误差。</li></ul></li></ul><hr><h2 id="_2-询比价逻辑-quotation-comparison" tabindex="-1">2. 询比价逻辑 (Quotation &amp; Comparison) <a class="header-anchor" href="#_2-询比价逻辑-quotation-comparison" aria-label="Permalink to &quot;2. 询比价逻辑 (Quotation &amp; Comparison)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“我想看过去三年这个零件的价格走势，系统里只能看当前的”。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>价格足迹 (Price Trace)</strong>: <ul><li>开发者需维护 <code>Price_History</code> 表。</li><li><strong>PG 实现建议</strong>: 使用 <strong>窗口函数 (Window Functions)</strong> 实现价格走势分析（如：同比、环比、移动平均价）。</li></ul></li><li><strong>多维度比价算法</strong>: <ul><li>开发者需实现一个“最优选商引擎”。</li><li><strong>PG 实现建议</strong>: 使用 <strong>自定义聚合函数 (Custom Aggregates)</strong> 或 <strong>存储过程 (PL/pgSQL)</strong> 将多维评分逻辑封装在数据库端，提高计算响应速度。</li></ul></li></ul><hr><h2 id="_3-采购合同与框架协议-contract-control" tabindex="-1">3. 采购合同与框架协议 (Contract Control) <a class="header-anchor" href="#_3-采购合同与框架协议-contract-control" aria-label="Permalink to &quot;3. 采购合同与框架协议 (Contract Control)&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“签了 100 万的框架协议，结果下采购单下了 120 万，系统也没拦截”</strong>。</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>执行进度监控</strong>: <ul><li>开发者需在 <code>Contract_Header</code> 维护执行进度。</li><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的 <strong>咨询锁 (Advisory Locks)</strong> 在采购单审核瞬间锁定合同额度，防止高并发下的“超卖/超买”现象。</li></ul></li><li><strong>强控逻辑</strong>: <ul><li>在采购单（PO）审核 API 中增加拦截。</li><li><strong>PG 实现建议</strong>: 使用 <strong>触发器 (Triggers)</strong> 自动更新合同已执行金额，并在超过上限时抛出 <code>EXCEPTION</code> 强制事务回滚。</li></ul></li></ul><hr><h2 id="_4-价格预警与反舞弊-price-audit" tabindex="-1">4. 价格预警与反舞弊 (Price Audit) <a class="header-anchor" href="#_4-价格预警与反舞弊-price-audit" aria-label="Permalink to &quot;4. 价格预警与反舞弊 (Price Audit)&quot;">​</a></h2><h3 id="企业痛点-3" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-3" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“采购员私自把价格调高了 10%，财务根本发现不了”。</p><h3 id="开发逻辑点-3" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-3" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>价格偏离度检查</strong>: <ul><li>开发者需在 PO 保存前对比。</li><li><strong>PG 实现建议</strong>: 使用 <strong>LATERAL JOIN</strong> 快速获取每个 Item 的最新三笔采购单价并计算平均偏离度。</li></ul></li><li><strong>最低价锁定</strong>: <ul><li>开发者可配置 <code>Is_Lowest_Price_Only</code> 开关。</li><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的 <strong><code>CHECK</code> 约束</strong> 结合自定义函数，在数据库层级强制执行最低价校验。</li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>多租户隔离</strong>: 是否通过 <strong>RLS</strong> 确保不同事业部的采购价格表物理隔离？</li><li>[ ] <strong>高频查询优化</strong>: 是否对常用的 <code>(supplier_id, item_id, validity_range)</code> 组合建立了 <strong>GIST</strong> 或 <strong>BRIN</strong> 索引？</li><li>[ ] <strong>供应商黑名单</strong>: 询价单接口是否自动过滤了黑名单中的供应商？</li><li>[ ] <strong>审计记录</strong>: 是否利用 <strong><code>JSONB</code></strong> 存储了价格调整的所有原始参数（包含当时的汇率、批量、税率快照）？</li></ul>`,30)])])}const u=a(o,[["render",e]]);export{p as __pageData,u as default};
