import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const o=JSON.parse('{"title":"VMI 库存与第三方代管 - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/inv-vmi.md","filePath":"modules/scm/inv-vmi.md"}'),h={name:"modules/scm/inv-vmi.md"};function l(e,s,k,p,r,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="vmi-库存与第三方代管-开发者详尽指南" tabindex="-1">VMI 库存与第三方代管 - 开发者详尽指南 <a class="header-anchor" href="#vmi-库存与第三方代管-开发者详尽指南" aria-label="Permalink to &quot;VMI 库存与第三方代管 - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>VMI（Vendor Managed Inventory）和第三方代管库存是“物理位置”与“所有权”分离的典型场景。开发者必须解决的核心逻辑是：<strong>如何在库存表里区分“谁的货”以及“谁来付钱”</strong>。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>资金占用假象</strong>：货在仓库里，但权属归供应商。若不区分，财务报表会虚增资产。</td><td style="text-align:left;"><strong>权属隔离维度 (Ownership Dimension)</strong>：在库存主表 <code>inv_onhand</code> 中增加 <code>owner_type</code>（自有/供应商）和 <code>owner_id</code> 字段，作为主键或索引的核心维度。</td></tr><tr><td style="text-align:left;"><strong>消耗结算滞后</strong>：生产领用了 VMI 的料，却忘了给供应商结算。</td><td style="text-align:left;"><strong>消耗触发引擎 (Consumption_Trigger)</strong>：在库存扣减（领料出库）的原子事务中，自动识别 <code>owner_type = &#39;Supplier&#39;</code>，并同步插入“待结算 VMI 记录表（v_vmi_settle_pending）”。</td></tr><tr><td style="text-align:left;"><strong>委外库存“失控”</strong>：原材料发给委外商加工，库存查不到，MRP 还会重复买。</td><td style="text-align:left;"><strong>虚拟外委仓 (Subcontracting_Wh)</strong>：为每个委外商建立虚拟仓库。发料即为“调拨（Transfer）”，库存所有权仍为“自有”，确保 MRP 计算时可用。</td></tr><tr><td style="text-align:left;"><strong>对账“罗生门”</strong>：供应商说用了 100 个，系统说用了 80 个。</td><td style="text-align:left;"><strong>三方快照对账 (Snapshot_Reconciliation)</strong>：定期生成 VMI 库存流水快照，并利用 <code>JSONB</code> 记录每一笔消耗的原始单据（MO/SO）ID，确保账账相符。</td></tr></tbody></table><hr><h2 id="_1-供应商寄售逻辑-consignment-management" tabindex="-1">1. 供应商寄售逻辑 (Consignment Management) <a class="header-anchor" href="#_1-供应商寄售逻辑-consignment-management" aria-label="Permalink to &quot;1. 供应商寄售逻辑 (Consignment Management)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“货在我的仓库里，但我只有在用掉它的时候才产生财务负债”。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>库存双维度查询</strong>: 开发者必须确保库存查询接口支持按权属聚合。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查询自有库存 vs 寄售库存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  item_id, </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> owner_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Self&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self_qty,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> owner_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Supplier&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vmi_qty</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_onhand </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id;</span></span></code></pre></div></li></ul><hr><h2 id="_2-消耗即结算机制-consumption-to-pay" tabindex="-1">2. 消耗即结算机制 (Consumption-to-Pay) <a class="header-anchor" href="#_2-消耗即结算机制-consumption-to-pay" aria-label="Permalink to &quot;2. 消耗即结算机制 (Consumption-to-Pay)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>生产车间从 VMI 货位领走 10 个轴承，系统应立即感知并准备付款。</p><h3 id="开发逻辑-同步捕获与异步结算" tabindex="-1">开发逻辑：同步捕获与异步结算 <a class="header-anchor" href="#开发逻辑-同步捕获与异步结算" aria-label="Permalink to &quot;开发逻辑：同步捕获与异步结算&quot;">​</a></h3><ul><li><strong>同步记录</strong>: 在 <code>BeforeUpdate</code> 触发器中捕获 VMI 扣减。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 捕获 VMI 消耗的触发器逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OLD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">owner_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Supplier&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OLD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">THEN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vmi_settle_pending (item_id, vendor_id, qty, source_doc_id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OLD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OLD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">owner_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OLD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), :current_doc_id);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_3-外委加工库存可见性-subcontracting-visibility" tabindex="-1">3. 外委加工库存可见性 (Subcontracting Visibility) <a class="header-anchor" href="#_3-外委加工库存可见性-subcontracting-visibility" aria-label="Permalink to &quot;3. 外委加工库存可见性 (Subcontracting Visibility)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>原材料在委外商厂里，仍是企业的资产，应参与 MRP 计算。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>调拨即监控</strong>: 原材料发往委外商不走“出库”，走“库间调拨”。</li><li><strong>MRP 逻辑</strong>: MRP 引擎在计算可用量时，必须包含 <code>wh_type = &#39;Subcontracting&#39;</code> 的仓库。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- MRP 可用量计算（包含委外仓）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> available_qty </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_onhand </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wh_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cfg_warehouse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_mrp_included </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true);</span></span></code></pre></div></li></ul><hr><h2 id="_4-vmi-对账与差异处理-reconciliation" tabindex="-1">4. VMI 对账与差异处理 (Reconciliation) <a class="header-anchor" href="#_4-vmi-对账与差异处理-reconciliation" aria-label="Permalink to &quot;4. VMI 对账与差异处理 (Reconciliation)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>月末与供应商对账，处理损益差异。</p><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>快照比对</strong>: 使用 PostgreSQL 的 <code>EXCEPT</code> 或 <code>FULL JOIN</code> 对比系统记录与供应商报表。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 对账差异发现</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COALESCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">vendor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">total_consumed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sys_qty,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  vendor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">total_consumed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vendor_qty,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">total_consumed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> vendor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">total_consumed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> diff</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_vmi_consumed_summary sys</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FULL JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vendor_report_table vendor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> vendor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>权属标识</strong>: <code>inv_onhand</code> 表是否已包含 <code>owner_type</code> 和 <code>owner_id</code> 字段？</li><li>[ ] <strong>结算触发</strong>: 所有的出库单据（领料单、销售出库）是否都实现了 VMI 消耗识别逻辑？</li><li>[ ] <strong>高精度结算</strong>: 结算单价是否取自最新的“寄售协议价”并使用 <code>numeric(24,12)</code> 计算？</li><li>[ ] <strong>反审核拦截</strong>: 若 VMI 记录已生成结算单，则对应的领料单是否已被锁定？</li><li>[ ] <strong>MRP 兼容</strong>: MRP 存储过程是否正确处理了委外仓和寄售仓的逻辑开关？</li><li>[ ] <strong>库龄分析</strong>: 寄售库存的库龄计算是否从“入库日”开始，而非“结算日”？</li><li>[ ] <strong>库存分配</strong>: 自动分配逻辑（ATP）是否支持配置“优先消耗 VMI 库存”策略？</li></ul>`,33)])])}const g=i(h,[["render",l]]);export{o as __pageData,g as default};
