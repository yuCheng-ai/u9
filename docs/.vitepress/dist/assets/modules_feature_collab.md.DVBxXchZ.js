import{_ as i,c as a,o as l,ae as n}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"组织间协同 (Collaboration) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/feature/collab.md","filePath":"modules/feature/collab.md"}'),t={name:"modules/feature/collab.md"};function h(e,s,k,r,p,o){return l(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="组织间协同-collaboration-开发者详尽指南" tabindex="-1">组织间协同 (Collaboration) - 开发者详尽指南 <a class="header-anchor" href="#组织间协同-collaboration-开发者详尽指南" aria-label="Permalink to &quot;组织间协同 (Collaboration) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>组织间协同是 U9 的“皇冠上的明珠”。开发者必须理解：协同不是简单的单据拷贝，而是<strong>跨法人实体的分布式业务事务</strong>。每一个协同动作都涉及两个或多个组织的账簿同步、实物移动以及内部结算。</p><hr><h2 id="_1-内部购销协同-自动对账的基石-internal-buy-sell" tabindex="-1">1. 内部购销协同：自动对账的基石 (Internal Buy/Sell) <a class="header-anchor" href="#_1-内部购销协同-自动对账的基石-internal-buy-sell" aria-label="Permalink to &quot;1. 内部购销协同：自动对账的基石 (Internal Buy/Sell)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“总公司卖货，工厂发货，两边财务月底对账发现差了 100 万，查了半个月才发现是汇率和单价录入不一致”</strong>。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>单据镜像生成 (Mirroring)</strong>: <ul><li>开发者需实现 <code>Auto_Document_Bridge</code>。</li><li><strong>逻辑</strong>: 当 A 组织核准 <code>Internal_Purchase_Order</code> 时，触发插件在 B 组织自动生成 <code>Internal_Sales_Order</code>。</li><li><strong>关键键值</strong>: 必须在两张单据上保存 <code>Source_Document_GUID</code>，作为后续所有关联查询的唯一索引。</li></ul></li><li><strong>状态强一致性</strong>: <ul><li>开发者需确保：B 组织 <code>Shipment</code> (发货) 后，系统通过 <code>Cross_Org_Service</code> 自动在 A 组织执行 <code>Receipt</code> (收货)。</li></ul></li><li><strong>技术实现建议</strong>: <ul><li>利用 PostgreSQL 的 <strong>Logical Decoding</strong> 或 <strong>Trigger + NOTIFY</strong> 机制。当 A 组织单据核准时，数据库触发器发送通知，异步服务监听通知并执行跨组织抛单。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用 NOTIFY 触发异步协同任务</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> notify_collab_bridge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trigger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PERFORM pg_notify(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;collab_task&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, json_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;source_org&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">org_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;doc_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;doc_type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;IPO&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    RETURN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NEW;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_2-直运协同-物流与所有权分离-drop-shipping" tabindex="-1">2. 直运协同：物流与所有权分离 (Drop Shipping) <a class="header-anchor" href="#_2-直运协同-物流与所有权分离-drop-shipping" aria-label="Permalink to &quot;2. 直运协同：物流与所有权分离 (Drop Shipping)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“货直接从工厂发给客户了，中间销售公司的库存账怎么平？财务怎么挂账？”。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>逻辑库存节点 (Logical Inventory)</strong>: <ul><li>开发者需处理“所有权转移”逻辑。</li><li><strong>单据流</strong>: <ul><li><ol><li>B 组织（工厂）生成 <code>Drop_Ship_Shipment</code>。</li></ol></li><li><ol start="2"><li>系统自动触发 A 组织（销售公司）的 <code>Virtual_Receipt</code> 和 <code>Virtual_Shipment</code>。</li></ol></li></ul></li></ul></li><li><strong>价差处理</strong>: <ul><li>A 卖给客户 100 元，B 卖给 A 80 元。开发者需确保 A 组织的凭证上正确反映这 20 元的内部利润。</li></ul></li><li><strong>技术实现建议</strong>: <ul><li>使用 <strong>UNLOGGED TABLE</strong> 处理临时的、仅用于计算的虚拟库存对冲数据，提升高并发直运场景下的写入性能。</li><li>使用 <code>JSONB</code> 存储直运链路中的多级分润协议，方便动态调整。</li></ul></li></ul><hr><h2 id="_3-跨组织委外协同-cross-org-subcontracting" tabindex="-1">3. 跨组织委外协同 (Cross-Org Subcontracting) <a class="header-anchor" href="#_3-跨组织委外协同-cross-org-subcontracting" aria-label="Permalink to &quot;3. 跨组织委外协同 (Cross-Org Subcontracting)&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“A 工厂把零件发给 B 工厂加工，这在系统里到底是生产订单还是采购订单？”</strong>。</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>双重身份映射</strong>: <ul><li>开发者需将 B 组织映射为 A 组织的 <code>Internal_Supplier</code>。</li><li><strong>开发逻辑</strong>: <ul><li>A 组织：下达 <code>Subcontract_MO</code>。</li><li>B 组织：自动生成 <code>Standard_MO</code>。</li></ul></li></ul></li><li><strong>物料追溯</strong>: <ul><li>开发者必须实现跨组织的 <code>Lot_Traceability</code>。确保 A 组织发出的批次号在 B 组织加工后，能正确带回给 A 组织。</li></ul></li><li><strong>技术实现建议</strong>: <ul><li>利用 PostgreSQL 的 <strong>Recursive CTE</strong> 实现跨组织的批次全生命周期追溯，穿透组织边界。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 跨组织递归追溯物料批次</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cross_org_trace </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_id, org_id, parent_lot_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :target_lot</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lot_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">org_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_lot_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_master l</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cross_org_trace t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lot_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_lot_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cross_org_trace;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_4-内部交易价格与结算-internal-pricing" tabindex="-1">4. 内部交易价格与结算 (Internal Pricing) <a class="header-anchor" href="#_4-内部交易价格与结算-internal-pricing" aria-label="Permalink to &quot;4. 内部交易价格与结算 (Internal Pricing)&quot;">​</a></h2><h3 id="企业痛点-3" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-3" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“内部价格经常变，每次都要两边同时改，太痛苦了”。</p><h3 id="开发逻辑点-3" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-3" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>全局价表模型</strong>: <ul><li>开发者需支持 <code>Inter-Company_Price_List</code>。</li><li><strong>取价优先级</strong>: 1. 协议特定价 -&gt; 2. 成本加成价 -&gt; 3. 标准转让价。</li></ul></li><li><strong>自动对账引擎</strong>: <ul><li>开发者需构建一个 <code>Unmatched_Internal_Transaction_View</code>，实时扫描 A 组织已收货但 B 组织未发货，或金额不一致的异常。</li></ul></li><li><strong>技术实现建议</strong>: <ul><li>使用 <strong>Materialized View (物料化视图)</strong> 定期刷新内部交易对账结果，降低实时查询对核心库的压力。</li><li>利用 <strong>Postgres_fdw</strong> (Foreign Data Wrapper) 如果不同组织的数据分布在不同的数据库实例上，实现跨实例的联邦查询对账。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建物料化视图加速内部对账</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MATERIALIZED VIEW mv_internal_reconcile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">doc_no</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buy_amt, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sell_amt</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> purchase_order a</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_order b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">src_guid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">guid</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_internal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>分布式事务</strong>: 跨组织单据生成必须使用 <code>TransactionScope</code> 或 <code>Two-Phase Commit</code>，防止 A 生成了但 B 没生成。</li><li>[ ] <strong>汇率一致性</strong>: 跨币种协同（如香港公司卖给深圳工厂）时，开发者是否使用了统一的 <code>Corporate_Exchange_Rate</code>？</li><li>[ ] <strong>取消与回滚</strong>: B 组织的销售订单取消时，开发者必须强制检查并同步取消 A 组织的采购订单。</li><li>[ ] <strong>税务合规</strong>: 内部交易是否正确生成了增值税/关税凭证？</li><li>[ ] <strong>性能</strong>: 协同插件应尽量采用异步消息队列处理，避免由于对方组织数据库死锁导致当前组织操作卡死。</li></ul>`,30)])])}const E=i(t,[["render",h]]);export{g as __pageData,E as default};
