# 客供档案与信用控制 (Partner & Credit) - 开发者详尽指南

## 概述
合作伙伴（Partner）是企业价值链的延伸。在开发逻辑中，合作伙伴不只是一个“通讯录”，它是**风控引擎**的核心输入。开发者必须处理好“同一实体多角色”的逻辑，并确保信用拦截在分布式环境下依然可靠。

---

## 1. 角色化模型：一实体多角色 (Entity-Role Model)

### 企业痛点
有些大型集团既是你的客户（买你的成品），又是你的供应商（卖你原材料）。如果开发者将客户表和供应商表物理分离，业务员就无法看到这个实体的**全口径对账单**（即：我欠他多少，他欠我多少，能否抵消）。

### 开发逻辑点
- **实体层 (Entity)**: 存储物理属性（统一社会信用代码、开户行、法人代表）。
- **角色层 (Role)**: 存储业务属性。
    - `CustomerRole`: 关联信用额度、销售价表、收货地址。
    - `SupplierRole`: 关联采购结算方式、品质免检标识、发货地址。
- **开发注意**: 在 UI 设计上，应提供“一键转供应商/客户”功能，避免重复录入基础信息。在查询时，应支持按“社会信用代码”进行全局去重。

---

## 2. 严密的信用控制 (Credit Control Logic)

### 企业痛点
**“货发出去了，钱收不回来”**。这是老板最怕的事。信用控制必须是**强拦截**，而非简单的弹窗提示。

### 核心算法
- **信用占用额度 = 未发货订单金额 + 已发货未开票金额 + 已开票未收款金额（应收账款）**。
- **可用额度 = 信用总额度 - 信用占用额度**。

### 开发逻辑点
- **高并发下的额度扣减**: 在审核销售订单时，必须采用**数据库行锁**或**分布式锁**对信用额度进行“预占”。严禁先读取再计算后更新（会有并发超卖风险）。
- **拦截点挂载 (Hooking)**:
    - `SO_SAVE`: 提示性警告。
    - `SO_SUBMIT`: 强拦截（禁止提交）。
    - `SHIP_SUBMIT`: 最终拦截（防止业务员私自发货）。
- **特批流程**: 开发者需实现“信用特批”工作流。当额度不足时，允许发起申请，由财务总监审批后产生一次性“临时额度”。

---

## 3. 结算协议与收付款规则 (Payment Terms)

### 企业痛点
结算规则极其复杂：30% 订金，60% 到货款，10% 质保金（一年后付）。如果开发者只给一个 `PayDays` 字段，根本没法用。

### 开发逻辑点
- **支付计划模板 (Payment Schedule)**:
    - 支持按比例（3:6:1）或按固定金额分期。
    - 支持按特定事件触发（下单日、发货日、开票日）。
- **自动逾期计算**: 开发者需写一个定时任务（Batch Job），每天凌晨根据结算协议计算单据的 `DueDate`（到期日），并更新 `OverdueStatus`。

---

## 4. 合作伙伴准入与黑名单 (Access Control)

### 企业痛点
供应商资质过期（如：医疗器械许可证），如果继续采购会面临巨大合规风险。

### 开发逻辑点
- **有效期校验**: 档案中必须包含 `Certificate_Expiry_Date`。
- **硬编码校验**: 在所有采购类 API 入口，必须校验 `Supplier.Status == 'Active' && Today < Expiry_Date`。

---

## 5. 开发者 Checklist

- [ ] **事务一致性**: 信用额度回滚逻辑是否覆盖了单据删除、反审核等所有场景？
- [ ] **地址库管理**: 一个客户有多个收货地址，开发者必须实现 `IsDefault` 逻辑，并支持经纬度存储（用于物流计算）。
- [ ] **敏感数据脱敏**: 合作伙伴的银行卡号、手机号在非财务界面是否做了脱敏显示？
- [ ] **性能监控**: 信用计算涉及大量关联查询（应收、订单、出货），必须使用索引优化或增量统计表。
