# MRP/MPS 运算与平衡 - 开发者详尽指南

## 概述
MRP（物料需求计划）是 ERP 的“中央处理器”。开发者必须理解：MRP 的本质是**时间维度的供需对冲**。它的核心逻辑是：在正确的时间，准备正确数量的正确物料。

---

## 1. 核心算法：净需求计算 (Net Requirement Logic)

### 企业痛点
**“算多了是库存，算少了是停工”**。

### 开发逻辑点
- **供需对冲公式**: 
    - `净需求 = (毛需求 + 安全库存) - (现有库存 + 预计入库 - 预计出库 - 已分配量)`。
    - **开发注意**: 开发者在编写 SQL 或存储过程时，必须考虑“预计入库（PO/MO）”的可靠性。如果 PO 已逾期，是否还应计入供给？（建议增加 `逾期天数` 过滤参数）。
- **时间桶 (Time Bucket)**: 
    - 开发者需将需求按天、周或月进行归并。
    - **逻辑**: `Requirement_Date = MIN(Demand_Date)`。

---

## 2. 计划方案与多版本模拟 (Simulation)

### 企业痛点
“我想看看如果下个月订单翻倍，我的原材料够不够，但不敢直接在正式环境算”。

### 开发逻辑点
- **沙箱隔离**: 
    - 开发者需设计 `MRP_Plan_ID`。
    - 所有的计算结果（建议单）都必须带有 `Plan_ID`，以便用户可以同时运行多个方案进行对比，而不影响正式生产。
- **快照机制**: 
    - MRP 开始前，开发者需抓取当前的库存、BOM 和订单快照。
    - **性能优化**: 避免计算过程中因数据变动导致的“不平衡”问题。

---

## 3. 批量规则与舍入逻辑 (Lot Sizing)

### 企业痛点
“我只需要 1.5 颗螺丝，系统给我开了个 1.5 的采购建议，供应商不卖”。

### 开发算法
- **舍入逻辑**: 
    - 开发者必须在物料主档读取 `Lot_Size` (批量) 和 `Minimum_Order_Qty` (起订量)。
    - **逻辑**: `Final_Qty = CEIL(Net_Qty / Lot_Size) * Lot_Size`。
- **期间合并 (Period Grouping)**: 
    - 开发者需实现“按期间汇总”：将未来 7 天的需求合并为一个采购建议，以降低采购成本。

---

## 4. 计划输出：建议单与例外消息 (Action Messages)

### 企业痛点
**“MRP 算完给了我 1 万条建议，我根本不知道先看哪个”**。

### 开发逻辑点
- **例外消息分级 (Exceptions)**: 
    - 开发者需自动识别并标记异常单据：
        - `Cancel`: 需求已取消，建议取消 PO。
        - `Expedite`: 需求提前，建议催货。
        - `Defer`: 需求推迟，建议延期。
- **建议单转正式单**: 
    - 提供“批量转化”接口。
    - **开发注意**: 转化时需再次校验库存快照，防止重复下单。

---

## 5. 开发者 Checklist

- [ ] **递归深度**: BOM 展开是否处理了 LLC（低层码），防止先算子件后算父件？
- [ ] **性能**: MRP 是典型的 CPU/内存密集型任务。是否使用了内存表（Memory Table）或并行计算？
- [ ] **日历校验**: 所有的日期计算（提前期偏移）是否跳过了“工厂日历”中的非工作日？
- [ ] **幂等性**: 同一个计划方案重复运行，是否能正确覆盖旧的建议数据？
