import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const E=JSON.parse('{"title":"ECN 工程变更 (ECN) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/mfg/ecn.md","filePath":"modules/mfg/ecn.md"}'),l={name:"modules/mfg/ecn.md"};function e(h,s,k,p,r,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="ecn-工程变更-ecn-开发者详尽指南" tabindex="-1">ECN 工程变更 (ECN) - 开发者详尽指南 <a class="header-anchor" href="#ecn-工程变更-ecn-开发者详尽指南" aria-label="Permalink to &quot;ECN 工程变更 (ECN) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>工程变更（ECN/ECR）是制造企业的“手术刀”。开发者必须意识到：ECN 不只是修改一张表，它是一系列<strong>连锁反应的触发器</strong>。如果逻辑不严密，会导致生产线领错料、库存呆滞或成品报废。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>变更“断层”</strong>：BOM 改了，但正在生产的订单（MO）还在按老图纸领料。</td><td style="text-align:left;"><strong>WIP 自动刷新引擎 (WIP_Refresh)</strong>：ECN 审核后，利用递归 CTE 扫描所有“未完工”的 MO，对比新旧 BOM 差异并强制更新备料明细。</td></tr><tr><td style="text-align:left;"><strong>版本冲突</strong>：同一料品在短时间内发生多次变更，导致生效日期重叠。</td><td style="text-align:left;"><strong>DateRange 排他约束</strong>：利用 PostgreSQL 的 <code>EXCLUDE</code> 约束，确保同一物料的变更周期在时间轴上绝对互斥。</td></tr><tr><td style="text-align:left;"><strong>追溯断链</strong>：出了质量问题，查不到当时生产时到底用的是哪一个 ECN 版本。</td><td style="text-align:left;"><strong>单据结构固化 (Structure Snapshot)</strong>：在 MO 生成时，将当时的 BOM 结构以 <code>JSONB</code> 格式物理固化到订单中，拒绝动态关联。</td></tr><tr><td style="text-align:left;"><strong>影响范围不明</strong>：改一个螺丝，不知道哪些产成品用到了它。</td><td style="text-align:left;"><strong>递归向上反查 (Where-Used Analysis)</strong>：实现极速的 BOM 向上递归，一键列出所有受影响的顶层物料及关联的在途采购单/生产单。</td></tr></tbody></table><hr><h2 id="_1-变更范围与冲突检测-impact-analysis" tabindex="-1">1. 变更范围与冲突检测 (Impact Analysis) <a class="header-anchor" href="#_1-变更范围与冲突检测-impact-analysis" aria-label="Permalink to &quot;1. 变更范围与冲突检测 (Impact Analysis)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p><strong>“改了一个螺丝，结果 100 个订单都要重算”</strong>。开发者必须自动识别受影响的范围。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>递归向上反查</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 向上递归查找受影响的所有父项及顶层产成品</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> impact_tree </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 初始行：直接引用该组件的父项</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_item_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> component_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :changed_item</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 递归行：父项的父项</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> impact_tree it </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">component_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_item_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT DISTINCT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> impact_tree;</span></span></code></pre></div></li></ul><hr><h2 id="_2-在制品-wip-的刷新策略-wip-handling" tabindex="-1">2. 在制品 (WIP) 的刷新策略 (WIP Handling) <a class="header-anchor" href="#_2-在制品-wip-的刷新策略-wip-handling" aria-label="Permalink to &quot;2. 在制品 (WIP) 的刷新策略 (WIP Handling)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>变更发生时，生产线上还有 50 个半成品。系统必须自动对比 MO 现有备料（mo_item_list）与新 BOM 的差异。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>差异对比算法</strong>: 使用 <code>EXCEPT</code> 运算符。</li><li><strong>原子化更新</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 找出需要增加的物料（新 BOM 有，但 MO 备料没有）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> component_id, qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_new_bom </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EXCEPT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id, qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_item_list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :mo_id;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 找出需要删除的物料（MO 备料有，但新 BOM 已删除）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_item_list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :mo_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_picked </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> false</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EXCEPT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> component_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_new_bom;</span></span></code></pre></div></li></ul><hr><h2 id="_3-版本断点与排他控制-concurrency-exclusion" tabindex="-1">3. 版本断点与排他控制 (Concurrency &amp; Exclusion) <a class="header-anchor" href="#_3-版本断点与排他控制-concurrency-exclusion" aria-label="Permalink to &quot;3. 版本断点与排他控制 (Concurrency &amp; Exclusion)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>防止两个 ECN 同时修改同一个 BOM 导致数据错乱。</p><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>排他约束</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 确保同一 Item 的 ECN 生效时间不重叠</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ecn_header </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXCLUDE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gist (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  valid_period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li><li><strong>建议锁</strong>: 在执行 BOM 物理更新（从 ECN 写入 BOM 表）时，必须使用 <code>pg_advisory_xact_lock(item_id)</code>。</li></ul><hr><h2 id="_4-严谨性校验-变更闭环-closing-the-loop" tabindex="-1">4. 严谨性校验：变更闭环 (Closing the Loop) <a class="header-anchor" href="#_4-严谨性校验-变更闭环-closing-the-loop" aria-label="Permalink to &quot;4. 严谨性校验：变更闭环 (Closing the Loop)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>ECN 审核通过了，但旧料的采购单还没取消，仓库还在发旧料。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>联动操作</strong>: ECN 审核事务内必须包含： <ol><li><strong>BOM 升版</strong>: 物理更新 <code>bom</code> 表。</li><li><strong>呆滞预警</strong>: 将被替换的旧料（Old_Part）标记为 <code>obsolete_status = &#39;Pending_Clearance&#39;</code>。</li><li><strong>任务下发</strong>: 向采购模块发送“旧料 PO 取消建议”，向仓库发送“旧料封存任务”。</li></ol></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>递归性能</strong>: 大规模 BOM（万级以上）的反查性能是否通过复合索引 <code>(component_id, parent_item_id)</code> 优化？</li><li>[ ] <strong>时间重叠</strong>: 是否通过 <code>EXCLUDE</code> 约束防止了同一物料的 ECN 生效日期重叠？</li><li>[ ] <strong>MO 联动</strong>: ECN 审核后，是否触发了“受影响 MO 备料自动刷新”逻辑？</li><li>[ ] <strong>版本快照</strong>: MO 生产时，是否将 BOM 结构固化到了 <code>mo_bom_snapshot</code> (JSONB) 字段中？</li><li>[ ] <strong>物料呆滞</strong>: 变更导致不再使用的旧料，是否自动触发了呆滞库存分析？</li><li>[ ] <strong>反审核拦截</strong>: 如果 ECN 已被某个 MO 执行了刷新，是否在后端禁止了 ECN 的弃审？</li></ul>`,33)])])}const g=i(l,[["render",e]]);export{E as __pageData,g as default};
