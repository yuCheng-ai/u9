import{_ as i,c as a,o as t,ae as h}from"./chunks/framework.CDjunVez.js";const E=JSON.parse('{"title":"标准成本与差异分析 (Standard Costing) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/fi/cost-std.md","filePath":"modules/fi/cost-std.md"}'),l={name:"modules/fi/cost-std.md"};function n(k,s,e,p,r,d){return t(),a("div",null,[...s[0]||(s[0]=[h(`<h1 id="标准成本与差异分析-standard-costing-开发者详尽指南" tabindex="-1">标准成本与差异分析 (Standard Costing) - 开发者详尽指南 <a class="header-anchor" href="#标准成本与差异分析-standard-costing-开发者详尽指南" aria-label="Permalink to &quot;标准成本与差异分析 (Standard Costing) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>标准成本（Standard Costing）是企业的“财务预算”。开发者需要构建一套能够模拟、计算并对比的系统。其核心不在于记录一个数值，而在于<strong>差异的实时捕捉</strong>。</p><hr><h2 id="_1-标准成本的卷积逻辑-cost-rollup" tabindex="-1">1. 标准成本的卷积逻辑 (Cost Rollup) <a class="header-anchor" href="#_1-标准成本的卷积逻辑-cost-rollup" aria-label="Permalink to &quot;1. 标准成本的卷积逻辑 (Cost Rollup)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“算一个成品的标准成本要半天”</strong>。BOM 结构复杂，物料成千上万，人工维护标准成本是不可能的。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>物料清单 (BOM) 穿透</strong>: 开发者需实现递归算法，提取料品主档中的“标准采购价”，结合 BOM 中的“标准用量”，以及工艺路线（Routing）中的“标准费率”和“标准工时”。</li><li><strong>卷积引擎</strong>: <ul><li><code>标准成本 = Σ(子件标准用量 * 子件标准单价) + (标准工时 * 标准费率)</code>。</li></ul></li><li><strong>模拟功能 (What-if Analysis)</strong>: 开发者应设计“草稿成本”与“正式成本”。允许用户在不改变现有系统的情况下，模拟原材料上涨 5% 对成品成本的影响。</li></ul><h3 id="postgresql-实现建议" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>递归 CTE 卷积</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> std_cost_rollup </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id, parent_id, std_price </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_raw_material </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">child</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">std_price</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">usage_qty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_master i </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_struct b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> std_cost_rollup child </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">child_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> child</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  GROUP BY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div>利用递归 CTE 在数据库层直接完成多级成本卷积，大幅减少网络传输开销。</li><li><strong>物化视图存储快照</strong>: 将每个版本的标准成本存储在物化视图中，既能保证查询性能，又方便进行跨版本的成本对比分析。</li></ul><hr><h2 id="_2-差异分析-三差异法-variance-analysis" tabindex="-1">2. 差异分析：三差异法 (Variance Analysis) <a class="header-anchor" href="#_2-差异分析-三差异法-variance-analysis" aria-label="Permalink to &quot;2. 差异分析：三差异法 (Variance Analysis)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“成本超标了，但不知道是买贵了还是用多了”</strong>。如果开发者只给一个总额差异，管理层根本没法追责。</p><h3 id="核心公式" tabindex="-1">核心公式 <a class="header-anchor" href="#核心公式" aria-label="Permalink to &quot;核心公式&quot;">​</a></h3><p>开发者必须在代码中实现以下拆解逻辑：</p><ol><li><strong>材料价格差异 (PPV)</strong>: <code>(实际单价 - 标准单价) * 实际采购数量</code>。</li><li><strong>材料用量差异</strong>: <code>(实际用量 - 标准用量) * 标准单价</code>。</li><li><strong>人工/制造费率差异</strong>: <code>(实际费率 - 标准费率) * 实际工时</code>。</li></ol><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>差异埋点</strong>: 差异不是月末算出来的，而是<strong>在业务发生的瞬间</strong>产生的。 <ul><li><em>场景</em>: 采购入库单审核。</li><li><em>逻辑</em>: 开发者需立即对比 <code>PO价格</code> 与 <code>料品标准价</code>，并产生一笔 <code>PPV (Purchase Price Variance)</code> 凭证存入差异表。</li></ul></li></ul><h3 id="postgresql-实现建议-1" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-1" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>触发器实时计算差异</strong>: 在采购入库单和领料单的 <code>AFTER INSERT</code> 触发器中嵌入差异计算逻辑。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">price_variance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">actual_price</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">std_price</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_master i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div>实现“业务发生即产生差异”，为管理层提供秒级的预警能力。</li><li><strong>JSONB 记录差异上下文</strong>: 将产生差异时的标准单价、实际单价、采购员等信息以 <code>JSONB</code> 格式存入差异记录，方便审计追溯。</li></ul><hr><h2 id="_3-成本更新与版本控制" tabindex="-1">3. 成本更新与版本控制 <a class="header-anchor" href="#_3-成本更新与版本控制" aria-label="Permalink to &quot;3. 成本更新与版本控制&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>标准成本一年一定，但年中工艺改进了，怎么更新？</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>版本化管理</strong>: 开发者需设计 <code>CostVersion</code> 表，记录不同年度、不同版本的标准成本。</li><li><strong>库存重估 (Revaluation)</strong>: <ul><li><strong>逻辑重难点</strong>: 当用户更新“标准成本”时，开发者必须自动扫描当前仓库中的所有库存。</li><li><strong>计算</strong>: <code>库存增值/贬值 = (新标准价 - 旧标准价) * 当前库存量</code>。</li><li><strong>财务抛送</strong>: 必须同步生成一笔财务调整凭证，确保库存明细账与总账对齐。</li></ul></li></ul><h3 id="postgresql-实现建议-2" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-2" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>时间范围类型 (DATERANGE)</strong>: 为成本版本表增加 <code>valid_period</code> 字段，利用 <code>daterange</code> 确保不同版本之间的时间连续性且不重叠。</li><li><strong>批量更新优化</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inventory_balance b</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> std_cost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">new_std_cost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    revaluation_amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">new_std_cost</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">std_cost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on_hand_qty</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cost_update_version v</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Approved&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div>利用 <code>UPDATE ... FROM</code> 语法一次性完成全量库存的重估计算，确保数据的一致性。</li><li><strong>咨询锁 (Advisory Locks)</strong>: 在执行库存重估事务期间，使用 <code>pg_advisory_xact_lock</code> 锁定重估过程，防止并发业务单据（如出库）导致的数据冲突。</li></ul><hr><h2 id="_4-开发者-checklist" tabindex="-1">4. 开发者 Checklist <a class="header-anchor" href="#_4-开发者-checklist" aria-label="Permalink to &quot;4. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>低层码应用</strong>: 标准成本卷积是否也遵循了“低层码”顺序，确保底层变动能自动传导至顶层？</li><li>[ ] <strong>异常处理</strong>: 针对“BOM 中有物料但没设标准价”的情况，是否有预警提示？</li><li>[ ] <strong>多币种</strong>: 卷积过程中，如果是进口件，是否使用了正确的“标准汇率”进行折算？</li><li>[ ] <strong>穿透报表</strong>: 报表是否支持从“成品差异”一键点开，看到是哪个子件、哪道工序贡献的差异？</li></ul>`,33)])])}const g=i(l,[["render",n]]);export{E as __pageData,g as default};
