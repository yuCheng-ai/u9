import{_ as i,c as a,o as t,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"实际成本核算 (Actual Costing) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/fi/cost-actual.md","filePath":"modules/fi/cost-actual.md"}'),n={name:"modules/fi/cost-actual.md"};function e(h,s,r,o,k,d){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="实际成本核算-actual-costing-开发者详尽指南" tabindex="-1">实际成本核算 (Actual Costing) - 开发者详尽指南 <a class="header-anchor" href="#实际成本核算-actual-costing-开发者详尽指南" aria-label="Permalink to &quot;实际成本核算 (Actual Costing) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>实际成本（Actual Costing）是 ERP 中逻辑最复杂、计算量最大的模块。它不是简单的“加减法”，而是对企业<strong>价值流</strong>的全面还原。对于开发者来说，这不仅是写 SQL，而是要通过代码实现一个<strong>多级卷积运算引擎</strong>。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>计算“死循环”</strong>：辅助车间（如动力、机修）互相服务，费用摊不过去。</td><td style="text-align:left;"><strong>迭代分配算法（Iterative Method）</strong>：在存储过程中实现多次循环分摊，直到余额小于 0.01 元的精度阈值。</td></tr><tr><td style="text-align:left;"><strong>卷积失序</strong>：BOM 层级深，先算成品还是先算零件？算错了会导致单价剧烈波动。</td><td style="text-align:left;"><strong>低层码（LLC）驱动引擎</strong>：利用递归 CTE 计算 LLC，强制系统按“零件 -&gt; 半成品 -&gt; 成品”的顺序逐层卷积。</td></tr><tr><td style="text-align:left;"><strong>分摊动因僵化</strong>：有的想按工时摊，有的想按产量摊。</td><td style="text-align:left;"><strong>可配置动因引擎</strong>：基于 <code>JSONB</code> 定义分摊因子，支持动态读取 <code>Worker_Hours</code> 或 <code>Output_Qty</code> 作为分摊权重。</td></tr><tr><td style="text-align:left;"><strong>尾差“炸弹”</strong>：四舍五入导致月末总账不平，差一分钱对不上。</td><td style="text-align:left;"><strong>尾差自动补差逻辑</strong>：在最后一张订单结算时，执行 <code>Total - Sum(Previous) = Final</code>，将精度误差强制吸收到最后一行。</td></tr></tbody></table><hr><h2 id="_1-成本域与核算口径-cost-domain" tabindex="-1">1. 成本域与核算口径 (Cost Domain) <a class="header-anchor" href="#_1-成本域与核算口径-cost-domain" aria-label="Permalink to &quot;1. 成本域与核算口径 (Cost Domain)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>有些工厂很大，但财务只想按车间核算成本；有些企业有多个工厂，但想共用一套料品单价。</p><h3 id="开发逻辑" tabindex="-1">开发逻辑 <a class="header-anchor" href="#开发逻辑" aria-label="Permalink to &quot;开发逻辑&quot;">​</a></h3><ul><li><strong>成本域 (Cost Domain)</strong>: 核算的物理/逻辑边界。单价计算必须按 <code>CostDomainID + ItemID</code> 分组。</li></ul><hr><h2 id="_2-费用归集与分摊引擎-allocation-engine" tabindex="-1">2. 费用归集与分摊引擎 (Allocation Engine) <a class="header-anchor" href="#_2-费用归集与分摊引擎-allocation-engine" aria-label="Permalink to &quot;2. 费用归集与分摊引擎 (Allocation Engine)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“100 万电费怎么摊？”、“动力车间和机修车间互相服务怎么摊？”。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>迭代分摊算法</strong>: 预设收敛精度（如 0.01）。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 迭代分摊核心逻辑（伪代码）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHILE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(unallocated_amount) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tmp_dept_costs) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">01</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LOOP</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 执行一轮分摊：将 A 部门费用按比例分给 B/C...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PERFORM fn_execute_allocation_round();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LOOP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_3-多级卷积计算-multi-level-rollup" tabindex="-1">3. 多级卷积计算 (Multi-level Rollup) <a class="header-anchor" href="#_3-多级卷积计算-multi-level-rollup" aria-label="Permalink to &quot;3. 多级卷积计算 (Multi-level Rollup)&quot;">​</a></h2><h3 id="核心算法-低层码-low-level-code" tabindex="-1">核心算法：低层码 (Low Level Code) <a class="header-anchor" href="#核心算法-低层码-low-level-code" aria-label="Permalink to &quot;核心算法：低层码 (Low Level Code)&quot;">​</a></h3><p>开发者必须先计算物料在所有 BOM 中的最低层级。</p><ul><li><strong>计算顺序</strong>: 从低层码大（底层零件）到小（顶层成品）卷积。</li></ul><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>低层码计算</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_levels </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> child_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NULL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">child_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_struct b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_levels bl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">child_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> child_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAX</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">level</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> llc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_levels </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> child_id;</span></span></code></pre></div></li></ul><hr><h2 id="_4-联产品与副产品分摊-joint-products" tabindex="-1">4. 联产品与副产品分摊 (Joint Products) <a class="header-anchor" href="#_4-联产品与副产品分摊-joint-products" aria-label="Permalink to &quot;4. 联产品与副产品分摊 (Joint Products)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>一个生产订单产出 A 产品的同时，顺带产出了 B（副产品）。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>分摊规则</strong>: <ul><li><strong>副产品</strong>: 通常按固定单价（扣除法）从总成本中剔除。</li><li><strong>联产品</strong>: 按市场价值比例分摊剩余成本。</li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>性能优化</strong>: 卷积涉及海量计算，是否使用了 <code>LOCAL TEMPORARY TABLE</code> 缓存中间结果？</li><li>[ ] <strong>异常监控</strong>: 是否捕获了“无单价原材料”异常？核算日志是否清晰记录了每个料品的成本构成（料、工、费）？</li><li>[ ] <strong>数据快照</strong>: 核算开始前是否“封单”？（禁止修改核算月份的收发货单据）。</li><li>[ ] <strong>尾差平衡</strong>: 是否实现了“最后一行自动挤平”逻辑，确保 <code>Input = Output</code>？</li><li>[ ] <strong>精度控制</strong>: 计算过程是否全程使用 <code>numeric(38, 12)</code>？</li><li>[ ] <strong>追溯性</strong>: 分摊后的每一笔凭证是否都保留了 <code>Cost_Center_ID</code> 和 <code>Source_Voucher_ID</code>？</li><li>[ ] <strong>弃审拦截</strong>: 成本已核算的月份，是否强制禁止了该月份内所有单据的反审核？</li></ul>`,34)])])}const c=i(n,[["render",e]]);export{g as __pageData,c as default};
