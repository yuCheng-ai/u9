# 货源管理与配额分配 - 开发者详尽指南

## 概述
货源管理（Sourcing）是采购的“导航系统”。开发者必须理解：货源决定了**“向谁买”**以及**“买多少”**。在高并发的 MRP 运算中，货源逻辑必须是**毫秒级自动判定**的。

---

## 1. 货源清单与优先级逻辑 (Approved Vendor List)

### 企业痛点
**“新来的采购员买错了供应商，买到了没通过质量体系认证的小作坊”**。

### 开发逻辑点
- **AVL 强控逻辑 (Approved Vendor List)**: 
    - 开发者需在所有采购类单据（PR/PO）的 `Item_Change` 事件中增加拦截。
    - **逻辑**: `IF (Supplier NOT IN Get_Approved_Vendors(Item)) THEN REJECT`。
- **有效期管理**: 
    - 货源关系必须有 `StartDate` 和 `EndDate`。
    - **自动失效引擎**: 开发者需写一个 Job，当供应商的 `ISO 证书` 或 `经营执照` 过期时，自动将该货源记录置为 `Disabled`。

---

## 2. 配额比例分配算法 (Quota Allocation)

### 企业痛点
“我们要培养二供（备份供应商），要求 A 供应商占 70%，B 供应商占 30%，但手动算太麻烦，经常算错”。

### 开发算法
- **自动配额逻辑**: 
    - 开发者需在 MRP 建议转 PO 时，调用 `Quota_Split_Engine`。
    - **逻辑**: 
        - 1. 获取该 Item 的所有有效货源及配额。
        - 2. `Calculated_Qty = Total_Requirement * Quota_Percent`。
- **累计差异补偿**: 
    - 开发者需考虑“历史累计量”。如果上一次 A 供应商少发了 10 个，这一次算法应自动补偿给 A，以确保年度总配额达标。

---

## 3. 跨组织货源协同 (Inter-Org Sourcing)

### 企业痛点
**“集团总部定好了供应商，下属工厂还得自己录一遍，效率太低”**。

### 开发逻辑点
- **货源下发机制**: 
    - 开发者需设计“主数据推送”逻辑。
    - **逻辑**: 在集团组织维护的货源，自动 `Publish` 到受影响的所有法人组织。
- **组织特定偏置**: 
    - 开发者需允许工厂组织在继承集团货源的基础上，增加 `Local_Lead_Time`（考虑当地物流差异）。

---

## 4. 供应商评分与货源准入 (Supplier Scorecard)

### 企业痛点
“某个供应商最近老是延迟交货，我们想自动减少他的配额”。

### 开发逻辑点
- **动态评级接口**: 
    - 开发者需提供 `Update_Supplier_Rating` API 给质量和物流模块。
    - **逻辑关联**: `IF (Supplier_Score < 60) THEN 自动将 Quota_Percent 调减 20%`。
- **准入工作流**: 
    - 货源记录的新增必须关联 `Supplier_Audit_Form`（供应商考察单），开发者需在数据库层面强制这种强关联。

---

## 5. 开发者 Checklist

- [ ] **性能**: MRP 运算涉及成千上万个料品的货源判定，该算法必须使用高效的内存缓存。
- [ ] **最小起订量 (MOQ)**: 分配配额时，如果计算结果小于供应商的 MOQ，开发者需实现“向上取整”或“合并至另一供应商”的策略。
- [ ] **独家供应校验**: 如果某个 Item 标记为 `Exclusive`（独家），开发者需禁止添加第二个有效供应商。
- [ ] **审计踪迹**: 货源比例的每一次调整，必须记录 `Old_Quota` 和 `New_Quota` 以及操作人。
