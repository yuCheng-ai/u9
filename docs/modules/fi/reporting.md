# 财务报表与数据穿透 (Financial Reporting) - 开发者详尽指南

## 概述
财务报表（Reporting）是 ERP 系统的“成绩单”。对于开发者来说，报表不只是 UI 上的表格，而是对**亿级数据量的聚合计算**。其核心挑战在于：如何在保证实时性的前提下，实现从汇总数到原始业务单据的**无缝穿透**。

---

## 1. 报表计算引擎：预汇总与缓存

### 企业痛点
**“点开资产负债表要等 1 分钟”**。如果开发者直接在亿级凭证表上执行 `SUM` 和 `GROUP BY`，系统必崩。

### 开发逻辑点
- **余额表 (Balance Table)**: 开发者需设计一套增量更新的余额表。
    - 每当一笔凭证过账，后台 Job 必须实时/近实时更新 `科目 + 期间 + 维度` 的汇总余额。
- **多维聚合**: 
    - 开发者需支持按 `组织`、`部门`、`项目`、`产品线` 等维度进行 OLAP 聚合计算。
- **性能建议**: 采用列式存储或物化视图来加速报表渲染。

### PostgreSQL 实现建议
- **物化视图 (Materialized View)**: 利用 `REFRESH MATERIALIZED VIEW CONCURRENTLY` 在不阻塞查询的情况下更新报表汇总数据。
- **BRIN 索引**: 凭证表数据量巨大且通常按时间顺序插入，使用 `BRIN` 索引代替 `B-Tree` 索引，可以极大节省磁盘空间并加速大范围时间段的扫描查询。
- **列式存储插件 (Citus/Hydra)**: 如果报表性能仍是瓶颈，可以考虑集成 PG 的列式存储扩展，将余额表存储为列式格式，提升聚合查询性能。

---

## 2. 穿透式溯源 (Drill-down Logic)

### 企业痛点
**“利润表里这笔 100 万差旅费是怎么来的？”**。如果不能查到原始单据，报表就是废纸。

### 开发逻辑点
- **全链路追踪码 (TraceID)**: 
    - 业务单据 (GUID) -> 凭证 (VoucherID) -> 报表项 (ReportItemID)。
- **实现方式**: 
    - 在报表 UI 上，开发者需为每个单元格挂载 `OnClick` 事件。
    - 后端接口需支持按 `AccountID + Period + Dimension` 反查出所有的凭证分录。
    - 再通过凭证的 `SourceID` 路由到具体的业务单据详情页（如：费用报销单）。

### PostgreSQL 实现建议
- **JSONB 路径索引 (GIN Index)**: 在凭证行的 `JSONB` 字段中存储多维维度信息（项目、部门、客户等），并建立 `GIN` 索引，实现对任意维度的秒级穿透查询。
- **外键约束与级联导航**: 利用数据库的外键关系确保全链路追踪码的完整性，并通过 `JOIN` 优化提升溯源查询的效率。

---

## 3. 内部往来抵销 (Inter-Company Elimination)

### 企业痛点
集团内 A 卖给 B 100 万。在集团合并报表时，这 100 万收入和 100 万成本必须**抹掉**，否则集团虚增了利润。

### 开发逻辑点
- **对账引擎**: 开发者需实现一个“往来核对表”，自动识别两边不匹配的差额（如：A 已发货，B 未收货）。
- **抵销分录模板**: 
    - 开发者需设计自动化抵销规则。
    - `逻辑: IF (Account == '内部销售收入' && Partner == '成员单位') THEN 生成抵销分录`。

### PostgreSQL 实现建议
- **CTE 递归合并**: 使用 `WITH` 语句构建复杂的合并抵销逻辑。在 SQL 层一次性提取抵销源数据，并生成抵销建议，减少应用层频繁的数据库交互。
- **窗口函数对账**: 
  ```sql
  SELECT source_org, target_org, amount, 
         amount - SUM(amount) OVER(PARTITION BY target_org, source_org) as imbalance
  FROM inter_company_tx;
  ```
  利用窗口函数快速识别集团内部往来的不平项。

---

## 4. 自定义报表平台 (Report Designer)

### 企业痛点
**“财务想改一个公式，就要找开发写半天代码”**。

### 开发逻辑点
- **公式解析器**: 开发者需实现一套类似 Excel 的语法解析。
    - `QC("1001", "2023-01")` 代表取 1001 科目 1 月份的期初余额。
- **模板引擎**: 允许用户上传 Excel 模板，开发者在后端使用 `POI` 或 `EasyExcel` 进行单元格填充。

### PostgreSQL 实现建议
- **自定义 PL/pgSQL 函数库**: 将常用的报表取数公式（如 `QC`, `QM`, `FS`）封装为 PG 的自定义函数。
  ```sql
  SELECT report_item, get_balance('1001', '2023-01') FROM report_config;
  ```
  直接在 SQL 中调用财务公式，极大地简化了报表引擎的开发难度。
- **触发器实时预警**: 在报表配置表上设置触发器，当公式引用了不存在的科目或维度时，立即进行语法校验并报错。

---

## 5. 开发者 Checklist

- [ ] **数据快照**: 报表是否记录了“生成时间”？（防止因为历史数据变动导致报表前后不一致）。
- [ ] **权限控制**: 报表是否实现了行级权限？（例如：华东区经理只能看华东区的报表）。
- [ ] **导出性能**: 导出 10 万行报表时，是否采用了流式输出（Streaming Output）防止 OOM？
- [ ] **差异标记**: 报表是否能自动检测并高亮显示“借贷不平”或“业财不符”的异常单元格？
