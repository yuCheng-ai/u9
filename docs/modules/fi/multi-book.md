# 多账簿核算体系 (Multi-Book) - 开发者详尽指南

## 概述
多账簿（Multi-Book）是解决“财务两张脸”的技术方案。在开发者眼中，这是一种**一写多读（Write Once, Post Multiple）**的架构。它确保了同一笔业务在不同会计准则（CAS, IFRS, US GAAP）下的数据强一致性。

---

## 1. 核心模型：主账簿与调整账簿

### 企业痛点
企业在 A 股上市要按中国准则（CAS），在美股上市要按美国准则（US GAAP）。如果开发者让用户录两遍凭证，财务人员会罢工，且数据极易出错。

### 开发逻辑点
- **账簿分类**:
    - **主账簿 (Primary Ledger)**: 记录所有原始业务凭证。
    - **调整账簿 (Adjustment Ledger)**: 仅记录不同准则之间的“差异分录”。
- **虚拟账簿视图**: 开发者在写查询 SQL 时，必须实现“视图合并”：`GAAP 报表 = 主账簿数据 + 对应 GAAP 的调整账簿数据`。

---

## 2. 差异核算逻辑 (Difference Accounting)

### 企业痛点
中国准则规定研发支出要费用化，但某些准则允许资本化。这会导致资产负债表和损益表完全不同。

### 开发逻辑点
- **单向抛送**: 业务单据（如研发领料）进入 AEP。
- **路由逻辑**: 
    - 路由 A（主账簿）：`借：管理费用，贷：原材料`。
    - 路由 B（IFRS 账簿）：`借：无形资产，贷：原材料`。
- **差异同步**: 开发者需确保当业务单据被弃审时，所有关联账簿中的凭证必须**同步冲销**。

---

## 3. 多本位币与折算 (Currency Translation)

### 企业痛点
越南子公司的本位币是越南盾，但集团总部要求看人民币报表。

### 开发逻辑点
- **折算账簿 (Translation Ledger)**: 这是一个特殊的账簿，其金额是根据汇率动态生成的。
- **开发算法**:
    - 损益类科目：按期间平均汇率折算。
    - 资产负债类科目：按期末即期汇率折算。
    - 实收资本：按历史汇率折算。
- **FCTR (外币报表折算差额)**: 开发者必须处理折算后的借贷不平问题，将差额自动挤入 `FCTR` 科目。

---

## 4. 数据一致性与并发控制

### 企业痛点
如果主账簿过账成功，但由于网络波动，IFRS 账簿过账失败，会导致严重的账实不符。

### 开发逻辑点
- **分布式事务/补偿机制**: 在 AEP 抛送多账簿时，必须使用强一致性事务。如果其中一个账簿写入失败，整个业务单据的财务状态必须回滚为“待入账”。
- **流水号隔离**: 不同账簿的凭证流水号（Voucher Number）必须独立维护，严禁共用。

---

## 5. 开发者 Checklist

- [ ] **多账簿路由配置**: 是否支持根据“业务类型”动态决定需要抛送哪些账簿？
- [ ] **科目映射**: 是否处理了“跨账簿科目体系不一致”的情况？（主账簿用 4 位编码，调整账簿用 6 位编码）。
- [ ] **审计日志**: 每一笔凭证是否都记录了其源业务单据的 `GUID`？
- [ ] **性能压测**: 并行生成 3 套账簿凭证时，数据库的 IOPS 是否在可控范围内？
