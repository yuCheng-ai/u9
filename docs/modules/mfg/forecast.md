# 销售预测与冲销 (Forecast) - 开发者详尽指南

## 概述
预测（Forecast）是制造企业的“望远镜”。开发者必须处理好**不确定性**。预测的核心逻辑不是简单的记录，而是如何通过**冲销（Consumption）**逻辑，确保计划系统（MRP）既不漏算需求，也不重复计算需求。

---

## 1. 预测的多版本与多维度 (Multi-version & Dimension)

### 企业痛点
销售部给的是“乐观预测”，财务部给的是“稳健预测”。开发者如果只设计一个预测表，根本没法做协同。

### 开发逻辑点
- **版本控制**: 
    - 开发者需支持 `Forecast_Version`。
    - **PG 实现建议**: 利用 PostgreSQL 的 **分区表 (Partitioning)** 按版本或日期存储预测数据，提升 MRP 模拟时的查询性能。
- **颗粒度转换**: 
    - 开发者需实现一个“分摊比例引擎”。
    - **PG 实现建议**: 使用 **窗口函数 (Window Functions)** 计算历史销量占比，并结合 **`LATERAL JOIN`** 实时分摊产品族预测到具体料号。

---

## 2. 核心逻辑：预测冲销 (Forecast Consumption)

### 企业痛点
**“有了真实订单，预测还没消失”**。如果预测是 100，实际订单来了 20，若不冲销，MRP 就会按 120 备料。

### 开发算法
- **冲销策略**: 
    - **前/后冲销 (Forward/Backward)**。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`daterange`** 类型存储预测的时间桶，并使用 **`GIST` 索引** 极速查找 SO 交期所在的预测区间。
- **冲销逻辑点**: 
    - 当 SO 审核时，触发冲销。
    - **PG 实现建议**: 使用 **存储过程 (PL/pgSQL)** 将冲销逻辑封装在数据库端。利用 **`FOR UPDATE SKIP LOCKED`** 处理高并发下的预测行锁定，确保冲销不重不漏。
- **反冲销**: 
    - SO 弃审时回退占用。
    - **PG 实现建议**: 利用 **事务保存点 (Savepoints)** 或 **审计触发器 (Audit Triggers)** 记录冲销轨迹，确保反冲销时能精准还原数据。

---

## 3. 预测的滚动管理 (Rolling Forecast)

### 企业痛点
预测是动态的，本周的预测到了下周就变成了历史。

### 开发逻辑点
- **过期自动清理**: 
    - 定时任务标记失效。
    - **PG 实现建议**: 使用 **`pg_cron`** 扩展在数据库层级定期执行过期预测的归档或清理。
- **滑动窗口**: 
    - 界面滑动展示。
    - **PG 实现建议**: 利用 PostgreSQL 的 **交叉表 (Crosstab/Tablefunc)** 插件将行存储的预测数据快速转置为按月/周展示的列格式报表。

---

## 4. 预测准确率分析 (Accuracy Tracking)

### 企业痛点
**“销售总是乱报预测”**。

### 开发逻辑点
- **对账视图**: 
    - 对比 `预测量` vs `实际订单量`。
    - **PG 实现建议**: 使用 **物化视图 (Materialized Views)** 预计算历史预测准确率，为 MRP 计划提供实时的修正因子。

---

## 5. 开发者 Checklist

- [ ] **高精度计算**: 预测分摊和冲销是否统一使用 **`numeric`** 类型？
- [ ] **多租户数据隔离**: 是否启用 **RLS** 确保各事业部的预测数据物理隔离？
- [ ] **并发性能**: 高并发 SO 审核时，是否对预测表使用了索引优化的行锁？
- [ ] **审计追踪**: 是否利用 **`JSONB`** 记录了每次冲销的详细流水（SO号、冲销前、冲销后、冲销策略）？
