# 完工入库与结案 (MO Complete) - 开发者详尽指南

## 概述
完工入库（Completion）是制造流程的“终点线”，也是财务核算的“起跑线”。开发者必须理解：这不仅仅是将库存数量加 1，更涉及**WIP 结转、质量判定、成本差异挤入**以及**需求关闭**的复杂逻辑。

---

## 1. 完工申报与质量判定 (Declaration & Inspection)

### 企业痛点
**“明明还没检完，仓库就给入库了，结果发货发了次品”**。

### 开发逻辑点
- **质量锁 (Quality Gate)**: 
    - 开发者需实现“报检-检验-入库”的严格流水线。
    - **逻辑**: `IF (Item.Is_Inspection_Required == True AND MO_Report.Inspect_Status != 'Qualified') THEN BLOCK_INVENTORY_IN`。
- **自动触发入库**: 
    - 对于免检物料，开发者应提供“一键完工”接口，同时完成汇报与入库事务。
    - **事务处理**: 必须确保 MO 状态更新与库存增加的原子性。

---

## 2. 在制品 (WIP) 结转与清理 (WIP Clearing)

### 企业痛点
“订单入库了，但车间里还剩了 3 个螺丝没用完，账上挂着一笔烂账”。

### 开发逻辑点
- **余料自动退库/核销**: 
    - 在 MO 结案（Close）时，开发者需扫描 `MO_Component_List`。
    - **逻辑**: `Remaining_Qty = Issued_Qty - Standard_Required_Qty`。
    - **处理**: 提示用户进行“余料退库”或自动生成“损耗核销凭证”。
- **WIP 清零算法**: 
    - 开发者需将该 MO 对应的 `WIP_Account` 余额全额结转至 `Finished_Goods_Inventory_Account`。

---

## 3. 生产订单结案逻辑 (MO Closing)

### 企业痛点
**“订单都入库一年了，居然还能往里面领料”**。

### 开发逻辑点
- **硬性结案约束**: 
    - 结案后，开发者必须在所有相关的增删改 API 中增加拦截：`IF (MO.Status == 'Closed') THEN REJECT`。
- **成本结平校验**: 
    - 开发者在执行结案事务前，必须校验：`SUM(Input_Cost) - SUM(Output_Value) ≈ 0`。
    - 如果差异超过阈值，必须强制要求用户录入“差异原因代码”。

---

## 4. 关键绩效指标 (KPI Tracking)

### 企业痛点
“老板想知道这个月的生产合格率和按期完工率，系统算不出来”。

### 开发算法
- **直通率 (FPY)**: `FPY = (一次性合格量 / 总申报量) * 100%`。
- **按期完工率**: `On_Time_Rate = (Actual_Finish_Date <= Plan_Finish_Date ? 1 : 0)`。
- **成本偏差率**: `Cost_Variance = (实际成本 - 标准成本) / 标准成本`。

---

## 5. 开发者 Checklist

- [ ] **多单位处理**: 完工申报单位与入库单位不一致时的浮点数精度处理。
- [ ] **倒冲物料**: 完工入库时，是否成功触发了“拉式（Pull）”物料的自动扣减？
- [ ] **反审核控制**: 如果成品已经销售出库，是否禁止了完工入库单的反审核？
- [ ] **批次/序列号**: 入库时是否强制要求生成或录入生产批次号？
