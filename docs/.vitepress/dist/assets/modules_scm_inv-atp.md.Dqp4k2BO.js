import{_ as i,c as a,o as t,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"动态预留与可用量 (ATP/PAB) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/inv-atp.md","filePath":"modules/scm/inv-atp.md"}'),n={name:"modules/scm/inv-atp.md"};function e(h,s,r,o,p,k){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="动态预留与可用量-atp-pab-开发者详尽指南" tabindex="-1">动态预留与可用量 (ATP/PAB) - 开发者详尽指南 <a class="header-anchor" href="#动态预留与可用量-atp-pab-开发者详尽指南" aria-label="Permalink to &quot;动态预留与可用量 (ATP/PAB) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>库存不是一个简单的数字，而是一条<strong>随时间波动的曲线</strong>。开发者必须理解：ATP（Available To Promise）和 PAB（Projected Available Balance）是 ERP 的“时空引擎”。它回答的核心问题是：<strong>“在未来某个时刻，我到底有多少货可以卖？”</strong></p><hr><h2 id="_1-核心算法-pab-滚动计算-pab-calculation" tabindex="-1">1. 核心算法：PAB 滚动计算 (PAB Calculation) <a class="header-anchor" href="#_1-核心算法-pab-滚动计算-pab-calculation" aria-label="Permalink to &quot;1. 核心算法：PAB 滚动计算 (PAB Calculation)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“明明现在仓库里有 100 个，但系统却告诉我不能卖，因为明天这 100 个就要发给老客户”</strong>。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>供需流水模型</strong>: <ul><li>开发者需构建一个基于时间轴的 <code>Supply_Demand_Timeline</code>。</li><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的<strong>窗口函数 (Window Functions)</strong> 实现滚动 PAB 计算，避免在内存中循环处理。</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 滚动计算 PAB 示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    expected_date,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(change_qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OVER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PARTITION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expected_date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ROWS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> BETWEEN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UNBOUNDED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> PRECEDING</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CURRENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ROW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pab</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> supply_demand_view;</span></span></code></pre></div><ul><li><strong>PAB 公式</strong>: <code>PAB[T] = PAB[T-1] + 预计入库[T] - 预计出库[T]</code>。</li><li><strong>开发注意</strong>: 所有的入库（PO, MO, ASN）和出库（SO, MO_Issue, Transfer）单据都必须带有 <code>Expected_Date</code> 索引。</li></ul></li><li><strong>负库存预警</strong>: <ul><li>开发者需在计算过程中实时监控 <code>IF (PAB[T] &lt; 0) THEN 产生缺料信号</code>。</li><li><strong>PG 实现建议</strong>: 使用 <code>CHECK</code> 约束或 <code>EXCLUDE</code> 约束在数据库层级防止非法库存状态。</li></ul></li></ul><hr><h2 id="_2-动态预留逻辑-reservation-logic" tabindex="-1">2. 动态预留逻辑 (Reservation Logic) <a class="header-anchor" href="#_2-动态预留逻辑-reservation-logic" aria-label="Permalink to &quot;2. 动态预留逻辑 (Reservation Logic)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“大客户的货还没发，被仓库管理员偷偷先发给小客户了”。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>双层预留模型</strong>: <ul><li><strong>硬预留 (Hard Reservation)</strong>: 绑定 <code>Lot_ID</code> 或 <code>Location_ID</code>。</li><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的 <strong>行级锁 (Row-level Locks)</strong> 和 <code>FOR UPDATE SKIP LOCKED</code> 处理高并发预留请求。</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 锁定特定批次进行硬预留</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inventory_lot </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ? </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SKIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LOCKED </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><ul><li><strong>软预留 (Soft Reservation)</strong>: 仅在 ATP 数量上扣减，不锁定实物。</li></ul></li><li><strong>预留自动释放 (TTL Mechanism)</strong>: <ul><li>开发者需实现一个后台 Job，自动清理“逾期未领料”的预留。</li><li><strong>PG 实现建议</strong>: 可以结合 <code>LISTEN/NOTIFY</code> 或 <code>pg_cron</code> 触发超时释放逻辑。</li></ul></li></ul><hr><h2 id="_3-atp-可承诺量-查询逻辑" tabindex="-1">3. ATP（可承诺量）查询逻辑 <a class="header-anchor" href="#_3-atp-可承诺量-查询逻辑" aria-label="Permalink to &quot;3. ATP（可承诺量）查询逻辑&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“销售员在外面谈合同，想知道下周三能不能交货 500 台”</strong>。</p><h3 id="开发算法" tabindex="-1">开发算法 <a class="header-anchor" href="#开发算法" aria-label="Permalink to &quot;开发算法&quot;">​</a></h3><ul><li><strong>ATP 逻辑点</strong>: <ul><li><code>ATP = 现有量 + 预计入库 - 预计出库（直到下一个预计入库发生前）</code>。</li><li><strong>PG 实现建议</strong>: 使用 <strong>物化视图 (Materialized Views)</strong> 定期刷新复杂的 ATP 汇总数据，提升前端查询响应速度。</li></ul></li><li><strong>跨组织可见性</strong>: <ul><li>开发者需支持分布式查询。</li><li><strong>PG 实现建议</strong>: 使用 <code>postgres_fdw</code> (Foreign Data Wrapper) 实现跨库/跨实例的实时库存可见性。</li></ul></li></ul><hr><h2 id="_4-并发控制与性能优化-performance" tabindex="-1">4. 并发控制与性能优化 (Performance) <a class="header-anchor" href="#_4-并发控制与性能优化-performance" aria-label="Permalink to &quot;4. 并发控制与性能优化 (Performance)&quot;">​</a></h2><h3 id="企业痛点-3" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-3" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“双 11 促销，100 个人同时抢 10 个库存，系统崩了，还超卖了”。</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>库存行锁 (Row-level Locking)</strong>: <ul><li>在执行预留时，必须使用 <code>SELECT FOR UPDATE</code> 锁定库存记录。</li></ul></li><li><strong>多租户隔离 (Data Isolation)</strong>: <ul><li><strong>PG 实现建议</strong>: 启用 <strong>行级安全 (RLS)</strong> 确保各租户/组织的库存数据物理隔离。</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_isolation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inventory_balance</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tenant_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_setting(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;app.current_tenant&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div></li><li><strong>高频更新优化</strong>: <ul><li><strong>PG 实现建议</strong>: 对于热点 Item，考虑使用 <code>UNLOGGED TABLE</code> 记录临时 ATP 变动，减少 WAL 日志开销（需权衡数据安全性）。</li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>时间精度</strong>: PAB 计算是按天还是按小时？（推荐按天，支持按小时微调）。</li><li>[ ] <strong>损耗系数</strong>: 预计入库的 MO 数量是否考虑了产出率（Yield Rate）的衰减？</li><li>[ ] <strong>逾期处理</strong>: 昨天应该到货但没到的 PO，在今天的 PAB 计算中是算作“即时供给”还是“无效供给”？</li><li>[ ] <strong>逆向事务</strong>: 销售订单退货时，是否自动恢复了该 Item 的 ATP 额度？</li></ul>`,30)])])}const c=i(n,[["render",e]]);export{g as __pageData,c as default};
