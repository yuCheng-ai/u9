# 销售预测与冲销 (Forecast) - 开发者详尽指南

## 概述
预测（Forecast）是制造企业的“望远镜”。开发者必须处理好**不确定性**。预测的核心逻辑不是简单的记录，而是如何通过**冲销（Consumption）**逻辑，确保计划系统（MRP）既不漏算需求，也不重复计算需求。

---

## 1. 预测的多版本与多维度 (Multi-version & Dimension)

### 企业痛点
销售部给的是“乐观预测”，财务部给的是“稳健预测”。开发者如果只设计一个预测表，根本没法做协同。

### 开发逻辑点
- **版本控制**: 开发者需支持 `Forecast_Version`（如：2023-Q4-V1）。每个版本可以独立运行 MRP 模拟。
- **颗粒度转换**: 
    - 销售可能按“产品族”预测，但生产需要“具体料号”。
    - 开发者需实现一个“分摊比例引擎”，将产品族的预测按历史销量占比分摊到具体料号上。

---

## 2. 核心逻辑：预测冲销 (Forecast Consumption)

### 企业痛点
**“有了真实订单，预测还没消失”**。如果预测是 100，实际订单来了 20，如果开发者不把预测减去 20，MRP 就会按 120 去备料，造成巨大浪费。

### 开发算法
- **冲销策略**: 
    - **前冲销 (Forward)**: 消耗当前及未来期间的预测。
    - **后冲销 (Backward)**: 消耗过去及当前的预测。
- **冲销逻辑点**: 
    - 当销售订单（SO）审核时，开发者需触发一个 `Consume_Forecast` 过程。
    - 寻找匹配的 `Item + Date_Range` 预测行。
    - `更新: Forecast.Consumed_Qty += SO.Qty, Forecast.Remaining_Qty -= SO.Qty`。
- **反冲销**: 当销售订单弃审或作废时，开发者必须精准回退预测占用，否则计划会缩水。

---

## 3. 预测的滚动管理 (Rolling Forecast)

### 企业痛点
预测是动态的，本周的预测到了下周就变成了历史。

### 开发逻辑点
- **过期自动清理**: 开发者需写一个定时任务，将所有 `Date < Today` 且 `Remaining_Qty > 0` 的预测记录标记为“失效”或自动转入“逾期需求池”。
- **滑动窗口**: 界面应支持“滑动显示”，自动根据当前日期展示未来 3-6 个月的需求分布。

---

## 4. 预测准确率分析 (Accuracy Tracking)

### 企业痛点
**“销售总是乱报预测”**。

### 开发逻辑点
- **对账视图**: 开发者需构建一个对比报表，横轴是时间，纵轴展示 `预测量` vs `实际订单量`。
- **计算准确率 (MAPE)**: `1 - ABS(实际-预测)/实际`。通过这个指标，系统可以自动给销售预测打分，并作为下月计划的修正系数。

---

## 5. 开发者 Checklist

- [ ] **性能**: 冲销逻辑发生在 SO 审核的高频时段，必须优化索引，避免全表扫描预测记录。
- [ ] **多组织**: 预测是否区分了“销售组织”和“供应组织”？
- [ ] **计量单位**: 预测通常是大单位（如：吨），订单可能是小单位（如：克），换算逻辑是否严密？
- [ ] **并发**: 多个 SO 同时冲销同一个预测行时，是否使用了 `SELECT FOR UPDATE` 防止超卖？
