# 调拨与形态转换 (Inventory Ops) - 开发者详尽指南

## 概述
库存移动不只是位置的变化，更是**资产权属与价值形态**的流转。开发者必须理解：每一次 `Move` 都可能触发**财务过账、税路切换、甚至组织间的结算**。

---

## 1. 跨组织调拨逻辑 (Inter-Org Transfer)

### 企业痛点
**“总公司调拨给分公司，财务上居然没产生往来账，税局查出大问题”**。

### 开发逻辑点
- **双向事务模型 (Two-Step Transfer)**: 
    - 开发者不应只写一个“修改位置”的 SQL。
    - **PG 实现建议**: 利用 PostgreSQL 的 **两阶段提交 (2PC)** 机制确保跨库调拨事务的原子性，或者使用 **逻辑复制 (Logical Decoding)** 异步驱动接收端的凭证生成。
- **内部结算价格**: 
    - 开发者需支持从 `Inter_Company_Price_List` 读取价格。
    - **PG 实现建议**: 使用 **JSONB** 存储动态的价格调整系数或阶梯结算规则，避免为每种调拨场景创建复杂的关联表。

---

## 2. 形态转换与等级管理 (Transformation)

### 企业痛点
“一堆原材料加工成了边角料，或者 A 等品降级成了 B 等品，账面上对不齐”。

### 开发逻辑点
- **多对多转换模型**: 
    - 开发者需支持 `1:N`（拆分）、`N:1`（组合）、`A:B`（转换）模型。
    - **PG 实现建议**: 使用 **递归 CTE (Recursive CTE)** 追踪多层转换后的物料血缘关系。
- **批次继承**: 
    - 转换后的新料品，开发者需在数据库中记录其 `Source_Lot`（源批次）。
    - **PG 实现建议**: 利用 **LTREE** 插件存储复杂的批次演化树结构，实现极速的质量回溯查询。

---

## 3. 库位管理与路径规划 (Location Control)

### 企业痛点
“仓库太大，员工调拨个货要跑半天，还容易放错位”。

### 开发逻辑点
- **库位策略 (Location Strategy)**: 
    - 开发者需在调拨单据中增加 `Suggested_Location` 逻辑。
    - **PG 实现建议**: 使用 **PostGIS**（如果涉及大型室外库区）或 **GIN 索引** 优化库位搜索效率。
- **库存锁定 (Locking)**: 
    - 调拨中（In-Transit）的库存，开发者需在全局 ATP 计算中将其标记为 `Moving`。
    - **PG 实现建议**: 利用 PostgreSQL 的 **咨询锁 (Advisory Locks)** 在长事务（如：等待出库扫描）期间防止该批次被其他业务误操作，而不会阻塞数据库元数据。

---

## 4. 条码与 PDA 异步处理 (Barcode Integration)

### 企业痛点
**“现场调拨很快，但系统过账很慢，导致库存数据延迟”**。

### 开发逻辑点
- **离线/异步过账**: 
    - 开发者需为 PDA 接口设计 `Job_Queue`。
    - **PG 实现建议**: 使用 **`NOTIFY / LISTEN`** 机制。当 PDA 接口将数据写入 `staging_table` 时，触发 `NOTIFY` 信号，后端处理进程实时 `LISTEN` 并异步执行过账逻辑。
- **高性能写入**:
    - **PG 实现建议**: 对于高频调拨场景，考虑使用 **分区表 (Partitioning)** 按月或按组织存储调拨流水，提高写入速度并简化历史数据归档。

---

## 5. 开发者 Checklist

- [ ] **数据完整性**: 是否使用了 **`numeric(38, 12)`** 确保存换过程中的价值平衡计算不出现精度偏差？
- [ ] **并发控制**: 调拨申请转化为调拨单时，是否对原始申请行使用了 **`SELECT FOR UPDATE`**？
- [ ] **多租户安全**: 是否启用 **RLS** 限制库管员只能操作其权限范围内的调拨单？
- [ ] **自动冲销**: 跨组织调拨完成时，是否自动核销了对应的 `调拨申请单` 数量？
