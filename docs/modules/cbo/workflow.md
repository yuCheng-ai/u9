# 业务流与工作流引擎 (Workflow & Flow) - 开发者详尽指南

## 概述
工作流（Workflow）和业务流（Business Flow）是 ERP 的“血液循环系统”。开发者必须分清两者：**工作流是决策逻辑**（谁审批），**业务流是执行逻辑**（单据怎么变）。如果两者混为一谈，系统架构会变得极度臃肿且难以维护。

---

## 1. 业务流引擎：单据转换逻辑 (Business Flow)

### 企业痛点
**“手工重复录单”**。销售员录了订单，仓库员还要再录一遍出库单。开发者如果只写简单的 CRUD，不实现自动转换，用户会疯掉。

### 开发逻辑点
- **推式 (Push) vs 拉式 (Pull)**:
    - **推式**: 在上游单据 `Audit` 成功后的 Hook 中，自动调用下游单据的 `Create` 接口。
    - **拉式**: 在下游单据录入界面，提供一个“选单”功能，通过 `ReferenceID` 跨表提取数据。
- **转换规则 (Mapping Rules)**: 
    - 开发者需实现一个“元数据映射器”。比如：销售订单的 `Qty` 映射到出库单的 `PlanQty`。
    - **核心逻辑**: 必须支持“一对多”（一笔订单分多次发货）和“多对一”（多笔订单合并发货）的拆分合并逻辑。
- **关联回写**: 下游单据审核后，必须回写上游单据的“已执行数量”。
    - *开发注意*: 必须在同一个数据库事务中完成，防止上游显示“未发货”但下游已经“发货成功”。

---

## 2. 工作流引擎：审批决策 (Approval Workflow)

### 企业痛点
**“找不着人审批”** 或 **“审批规则变了就要改代码”**。开发者绝对不能在代码里写 `if (amount > 5000) { call ManagerApproval() }`。

### 核心模型
- **节点 (Node)**: 开始、审批、分支、合并、结束。
- **执行人规则 (Participant Logic)**:
    - **固定人**: 指定 ID。
    - **汇报关系**: 找发起人的主管（需要查询 `HR_OrgStructure`）。
    - **岗位/角色**: 找所有具有“财务经理”岗位的用户。
- **条件分支**: 开发者需集成一个 **表达式引擎**（如 Spring EL 或 Aviator），允许用户配置 `order.total_amount > 10000` 这样的逻辑。

### 开发逻辑点
- **状态机控制**: 单据必须有一个 `Status` 字段。
    - `0: 草稿` -> `1: 审批中` -> `2: 已审核` -> `3: 被驳回`。
    - **强校验**: 处于“审批中”状态的单据，后端 `Update` 接口必须报错拦截，防止边审批边改数据。
- **代理审批**: 开发者需在 `ParticipantResolver` 中增加逻辑：如果当前审批人设置了 `SubstituteUser` 且在有效期内，自动将待办推给代理人。

---

## 3. 性能与一致性 (Performance & Consistency)

### 企业痛点
当一个集团有上万人在同时点击审批时，系统会变慢。

### 开发逻辑点
- **异步驱动**: 审批通过后的业务逻辑（如更新库存、抛送财务凭证）建议通过 **消息队列 (MQ)** 异步处理。不要让用户在点击“同意”后转圈圈等待 10 秒钟。
- **操作日志 (Audit Trail)**: 每一跳审批必须记录 `OpTime`, `Operator`, `Action`, `Comments`。这不仅是业务需要，更是法律审计（如 SOX）的要求。

---

## 4. 移动端适配逻辑

### 企业痛点
老板在打高尔夫时想审批单据，他不会打开电脑看复杂的明细表。

### 开发逻辑点
- **摘要引擎**: 开发者需实现一个“单据摘要生成器”，将复杂的 50 个字段压缩成 5 个关键指标（如：客户名、总金额、毛利率、付款方式），推送到钉钉/企微。

---

## 5. 开发者 Checklist

- [ ] **幂等性**: 审批接口是否做了幂等处理？（防止用户疯狂连击“同意”导致重复生成下游单据）。
- [ ] **反审核逻辑**: 所有的单据必须支持“弃审”。弃审时，必须检查下游单据是否已生成或已执行，若有则禁止弃审。
- [ ] **循环审批预防**: 流程配置是否可能产生死循环？（如 A 找 B，B 又找 A）。
- [ ] **超时机制**: 是否实现了 `SLA` 逻辑？（超过 24 小时未审批自动提醒或自动跳过）。
