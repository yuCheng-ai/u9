# 采购询比价与价格控制 - 开发者详尽指南

## 概述
采购价格是企业的“利润源泉”。开发者必须理解：价格不是一个静态的字段，而是一个**受供应商、批量、有效期、币种、税率**多维控制的动态模型。

---

## 1. 价格表引擎 (Price List Engine)

### 企业痛点
**“同样的零件，买 10 个和买 1000 个价格不一样，开发者如果只写一个单价字段，业务员就得天天改价格”**。

### 开发逻辑点
- **分级价格模型 (Tiered Pricing)**: 
    - 开发者需支持 `Price_Break` 逻辑。
    - **PG 实现建议**: 使用 **JSONB** 存储分级阶梯价，避免为每个物料创建过多的关联行，并利用 `->>` 操作符进行快速检索。
- **有效期过滤**: 
    - 所有的价格获取接口必须强制传入 `Date` 参数。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`daterange`** 类型和 **`GIST` 索引** 实现极其高效的有效期重叠检查。
    ```sql
    -- 检查价格有效期是否重叠
    ALTER TABLE pur_price_list 
    ADD EXCLUDE USING gist (supplier_id WITH =, item_id WITH =, validity_range WITH &&);
    ```
- **币种与税率转换**: 
    - 开发者需自动处理汇率换算。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`numeric`** 类型进行高精度计算，防止在处理 6-8 位单价小数时出现舍入误差。

---

## 2. 询比价逻辑 (Quotation & Comparison)

### 企业痛点
“我想看过去三年这个零件的价格走势，系统里只能看当前的”。

### 开发逻辑点
- **价格足迹 (Price Trace)**: 
    - 开发者需维护 `Price_History` 表。
    - **PG 实现建议**: 使用 **窗口函数 (Window Functions)** 实现价格走势分析（如：同比、环比、移动平均价）。
- **多维度比价算法**: 
    - 开发者需实现一个“最优选商引擎”。
    - **PG 实现建议**: 使用 **自定义聚合函数 (Custom Aggregates)** 或 **存储过程 (PL/pgSQL)** 将多维评分逻辑封装在数据库端，提高计算响应速度。

---

## 3. 采购合同与框架协议 (Contract Control)

### 企业痛点
**“签了 100 万的框架协议，结果下采购单下了 120 万，系统也没拦截”**。

### 开发逻辑点
- **执行进度监控**: 
    - 开发者需在 `Contract_Header` 维护执行进度。
    - **PG 实现建议**: 利用 PostgreSQL 的 **咨询锁 (Advisory Locks)** 在采购单审核瞬间锁定合同额度，防止高并发下的“超卖/超买”现象。
- **强控逻辑**: 
    - 在采购单（PO）审核 API 中增加拦截。
    - **PG 实现建议**: 使用 **触发器 (Triggers)** 自动更新合同已执行金额，并在超过上限时抛出 `EXCEPTION` 强制事务回滚。

---

## 4. 价格预警与反舞弊 (Price Audit)

### 企业痛点
“采购员私自把价格调高了 10%，财务根本发现不了”。

### 开发逻辑点
- **价格偏离度检查**: 
    - 开发者需在 PO 保存前对比。
    - **PG 实现建议**: 使用 **LATERAL JOIN** 快速获取每个 Item 的最新三笔采购单价并计算平均偏离度。
- **最低价锁定**: 
    - 开发者可配置 `Is_Lowest_Price_Only` 开关。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`CHECK` 约束** 结合自定义函数，在数据库层级强制执行最低价校验。

---

## 5. 开发者 Checklist

- [ ] **多租户隔离**: 是否通过 **RLS** 确保不同事业部的采购价格表物理隔离？
- [ ] **高频查询优化**: 是否对常用的 `(supplier_id, item_id, validity_range)` 组合建立了 **GIST** 或 **BRIN** 索引？
- [ ] **供应商黑名单**: 询价单接口是否自动过滤了黑名单中的供应商？
- [ ] **审计记录**: 是否利用 **`JSONB`** 存储了价格调整的所有原始参数（包含当时的汇率、批量、税率快照）？
