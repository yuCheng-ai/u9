import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const o=JSON.parse('{"title":"销售预测与冲销 (Forecast) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/mfg/forecast.md","filePath":"modules/mfg/forecast.md"}'),l={name:"modules/mfg/forecast.md"};function h(e,s,k,p,r,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="销售预测与冲销-forecast-开发者详尽指南" tabindex="-1">销售预测与冲销 (Forecast) - 开发者详尽指南 <a class="header-anchor" href="#销售预测与冲销-forecast-开发者详尽指南" aria-label="Permalink to &quot;销售预测与冲销 (Forecast) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>预测（Forecast）是制造企业的“望远镜”。开发者必须处理好<strong>不确定性</strong>。预测的核心逻辑不是简单的记录，而是如何通过**冲销（Consumption）**逻辑，确保计划系统（MRP）既不漏算需求，也不重复计算需求。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>需求重复计算</strong>：预测是 100，实际订单（SO）来了 20。若不冲销，MRP 会按 120 备料，导致库存积压。</td><td style="text-align:left;"><strong>预测冲销引擎 (Forecast_Consumption)</strong>：在 SO 审核事务中，自动寻找对应时间桶（Bucket）的预测行进行数量抵扣。</td></tr><tr><td style="text-align:left;"><strong>预测“乐观与稳健”</strong>：销售和财务给的预测版本不一致。</td><td style="text-align:left;"><strong>多版本模拟 (Multi-Version)</strong>：支持多个 Forecast_Version，并允许在运行 MRP 时选择特定的版本快照作为需求源。</td></tr><tr><td style="text-align:left;"><strong>颗粒度断层</strong>：销售只预测产品大类（如：笔记本电脑），生产需要具体型号（如：X1 Carbon）。</td><td style="text-align:left;"><strong>比例分摊引擎 (Pro-rata_Engine)</strong>：利用历史销量比例，将产品族预测自动拆解为具体的 SKU 预测明细。</td></tr><tr><td style="text-align:left;"><strong>过期预测干扰</strong>：上个月没跑完的预测，不应再干扰本月的生产计划。</td><td style="text-align:left;"><strong>自动过期清理 (Auto-Expiration)</strong>：利用 <code>pg_cron</code> 定期清理或归档 <code>valid_to &lt; CURRENT_DATE</code> 且未冲销的预测行。</td></tr></tbody></table><hr><h2 id="_1-核心模型-时间桶与版本化-bucketing" tabindex="-1">1. 核心模型：时间桶与版本化 (Bucketing) <a class="header-anchor" href="#_1-核心模型-时间桶与版本化-bucketing" aria-label="Permalink to &quot;1. 核心模型：时间桶与版本化 (Bucketing)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>预测通常按周（Week）或按月（Month）汇总。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>时间范围存储</strong>: 使用 PostgreSQL 的 <code>daterange</code> 类型。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建带时间范围约束的预测表</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mfg_forecast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">serial</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">24</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  consumed_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">24</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DEFAULT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  valid_period daterange, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- [2024-01-01, 2024-02-01)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  version_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul><hr><h2 id="_2-预测冲销算法-consumption-logic" tabindex="-1">2. 预测冲销算法 (Consumption Logic) <a class="header-anchor" href="#_2-预测冲销算法-consumption-logic" aria-label="Permalink to &quot;2. 预测冲销算法 (Consumption Logic)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>当一个销售订单（SO）交期为 1月15日时，它应该冲销掉 1月份的预测量。</p><h3 id="开发逻辑-前-后冲销策略" tabindex="-1">开发逻辑：前/后冲销策略 <a class="header-anchor" href="#开发逻辑-前-后冲销策略" aria-label="Permalink to &quot;开发逻辑：前/后冲销策略&quot;">​</a></h3><ol><li><strong>匹配桶</strong>: 找到 SO 交期所在的 <code>valid_period</code>。</li><li><strong>原子抵扣</strong>: 使用 <code>UPDATE ... SET consumed_qty = consumed_qty + :so_qty</code>。</li><li><strong>溢出处理</strong>: 如果当前桶不够冲，是否向后一个桶继续冲？（由 <code>consumption_policy</code> 决定）。</li></ol><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>并发控制</strong>: 使用 <code>SELECT ... FOR UPDATE</code> 锁定预测行。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 预测冲销核心逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mfg_forecast </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> consumed_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> consumed_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :so_qty</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :item_id </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> valid_period @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :so_due_date </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- SO 交期落在此区间内</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> consumed_qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :so_qty</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RETURNING id;</span></span></code></pre></div></li></ul><hr><h2 id="_3-比例分摊引擎-allocation-engine" tabindex="-1">3. 比例分摊引擎 (Allocation Engine) <a class="header-anchor" href="#_3-比例分摊引擎-allocation-engine" aria-label="Permalink to &quot;3. 比例分摊引擎 (Allocation Engine)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>将“手机产品族”的 10,000 台预测，按历史销量比例拆分给“黑色 128G”和“白色 256G”。</p><h3 id="技术实现建议-2" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-2" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>窗口函数分摊</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 根据过去 3 个月的销量比例自动分摊预测</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_history </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> history_total </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sal_order_line </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> due_date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CURRENT_DATE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;3 months&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">total_history </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(history_total) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> grand_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_history)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (:family_forecast_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">history_total</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> th</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">grand_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allocated_qty</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sales_history sh, total_history th;</span></span></code></pre></div></li></ul><hr><h2 id="_4-预测准确率分析-accuracy-bias" tabindex="-1">4. 预测准确率分析 (Accuracy &amp; Bias) <a class="header-anchor" href="#_4-预测准确率分析-accuracy-bias" aria-label="Permalink to &quot;4. 预测准确率分析 (Accuracy &amp; Bias)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>对比“月初预测”与“月末实际订单”，识别哪些销售在“乱报”。</p><h3 id="技术实现建议-3" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-3" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>物化视图预计算</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 预测准确率看板</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MATERIALIZED VIEW mv_forecast_accuracy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  item_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> forecast_qty,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(consumed_qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> actual_qty,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(consumed_qty)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULLIF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> accuracy_rate</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mfg_forecast</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id;</span></span></code></pre></div></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>高精度计算</strong>: 冲销和分摊是否统一使用 <code>numeric(24, 12)</code>？</li><li>[ ] <strong>冲销策略</strong>: 系统是否支持“前冲销”、“后冲销”以及“不冲销”的可配置开关？</li><li>[ ] <strong>并发性能</strong>: 订单审核高峰期，冲销逻辑是否通过索引优化（GIST）避免了全表扫描？</li><li>[ ] <strong>反审核处理</strong>: SO 弃审时，是否能正确回退 <code>consumed_qty</code> 并记录反冲销日志？</li><li>[ ] <strong>颗粒度对齐</strong>: 预测是按周录入的，订单是按天录入的，冲销逻辑是否正确处理了日期重叠？</li><li>[ ] <strong>多租户隔离</strong>: 预测数据是否正确应用了 RLS（行级安全）策略？</li><li>[ ] <strong>MRP 引用</strong>: MRP 计划引擎在取需求时，是否使用的是 <code>(qty - consumed_qty)</code> 后的净需求？</li></ul>`,35)])])}const g=i(l,[["render",h]]);export{o as __pageData,g as default};
