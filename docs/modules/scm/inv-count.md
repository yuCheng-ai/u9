# 库存盘点与差异处理 - 开发者详尽指南

## 概述
盘点（Stock Count）是 ERP 系统数据的“校准仪”。开发者必须解决的核心问题是：**如何在不停止业务的情况下，完成实物与账面数据的精准核对**。这涉及到复杂的“静态快照”与“动态差异”平衡。

---

## 1. 静态快照与动态盘点 (Snapshots)

### 企业痛点
**“盘点时不能发货，整个工厂停工等我盘库”**。

### 开发逻辑点
- **账面快照 (Account Snapshot)**: 
    - 开发者需实现“一键冻结账面数”功能。
    - **逻辑**: 在 `Count_Sheet` 生成瞬间，将 `Inventory.On_Hand_Qty` 复制到 `Count_Line.Snapshot_Qty`。
- **差异平衡逻辑**: 
    - 盘点期间发生的收发货记录，开发者不应直接修改快照，而是记录在 `Inventory_Transaction_After_Snapshot` 中。
    - **计算公式**: `实际差异 = (实盘数 + 快照后发货量 - 快照后入库量) - 快照账面数`。

---

## 2. 盘点差异的自动化处理 (Variance Handling)

### 企业痛点
“盘亏了 10 个，我得手动开 10 个出库单，还得写原因，太麻烦”。

### 开发逻辑点
- **自动对冲单据**: 
    - 开发者需提供“差异审批通过后自动记账”接口。
    - **逻辑**: 
        - 盘盈 -> 自动生成 `Inventory_In_Voucher`（入库单），成本价取 `Item.Standard_Cost` 或 `Last_Purchase_Price`。
        - 盘亏 -> 自动生成 `Inventory_Out_Voucher`（出库单），原因代码关联 `Stock_Loss`。
- **财务分录触发**: 
    - 盘点差异必须自动推送至 AEP（核算平台），生成 `待处理财产损溢` 科目凭证。

---

## 3. 周期盘点算法 (Cycle Counting)

### 企业痛点
**“我不知道哪些物料该盘了，全靠仓库管理员心情”**。

### 开发算法
- **ABC 分类驱动**: 
    - A 类（贵重）: 每月盘点。
    - B 类: 每季盘点。
    - C 类: 每年盘点。
- **调度引擎**: 
    - 开发者需编写一个 Job，每天根据 `Item.Last_Count_Date` 和 `ABC_Class` 自动产生 `Suggested_Count_Task`。

---

## 4. 盲盘与实盘逻辑 (Blind Count)

### 企业痛点
“仓库员偷懒，直接按系统显示的数字填盘点表”。

### 开发逻辑点
- **盲盘控制 (Blind Count)**: 
    - 开发者需在 UI 或 PDA 接口中增加 `Is_Blind_Count` 参数。
    - **逻辑**: 如果开启，移动端严禁显示 `Snapshot_Qty`，强制录入人员实地清点。
- **二次复核**: 
    - 当 `ABS(实盘 - 账面) > 阈值` 时，开发者需自动触发 `Re-count_Task`。

---

## 5. 开发者 Checklist

- [ ] **多货位/多批次**: 盘点记录是否能精细到 `Sub_Location` 和 `Lot_Number`？
- [ ] **PDA 集成**: 接口是否支持连续扫描条码并自动累加实盘数量？
- [ ] **事务并发**: 盘点差异过账时，是否对库存行执行了排他锁？
- [ ] **历史追溯**: 是否保存了盘点前的原始快照和盘点后的修正轨迹？
