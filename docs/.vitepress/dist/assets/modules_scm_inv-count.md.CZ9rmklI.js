import{_ as s,c as i,o as n,ae as t}from"./chunks/framework.CDjunVez.js";const u=JSON.parse('{"title":"库存盘点与差异处理 - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/inv-count.md","filePath":"modules/scm/inv-count.md"}'),l={name:"modules/scm/inv-count.md"};function o(e,a,r,h,d,c){return n(),i("div",null,[...a[0]||(a[0]=[t(`<h1 id="库存盘点与差异处理-开发者详尽指南" tabindex="-1">库存盘点与差异处理 - 开发者详尽指南 <a class="header-anchor" href="#库存盘点与差异处理-开发者详尽指南" aria-label="Permalink to &quot;库存盘点与差异处理 - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>盘点（Stock Count）是 ERP 系统数据的“校准仪”。开发者必须解决的核心问题是：<strong>如何在不停止业务的情况下，完成实物与账面数据的精准核对</strong>。这涉及到复杂的“静态快照”与“动态差异”平衡。</p><hr><h2 id="_1-静态快照与动态盘点-snapshots" tabindex="-1">1. 静态快照与动态盘点 (Snapshots) <a class="header-anchor" href="#_1-静态快照与动态盘点-snapshots" aria-label="Permalink to &quot;1. 静态快照与动态盘点 (Snapshots)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“盘点时不能发货，整个工厂停工等我盘库”</strong>。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>账面快照 (Account Snapshot)</strong>: <ul><li>开发者需实现“一键冻结账面数”功能。</li><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的 <strong><code>CREATE TABLE ... AS SELECT</code></strong> 或 <strong><code>INSERT INTO ... SELECT</code></strong> 快速创建静态快照表。对于极大规模数据，可以使用 <strong><code>COPY</code></strong> 命令提高备份效率。</li></ul></li><li><strong>差异平衡逻辑</strong>: <ul><li>盘点期间发生的收发货记录，开发者不应直接修改快照，而是记录在 <code>Inventory_Transaction_After_Snapshot</code> 中。</li><li><strong>PG 实现建议</strong>: 使用 <strong>窗口函数 (Window Functions)</strong> 结合时间戳，自动回溯盘点时刻的精确余额，而无需物理锁定仓库。</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 回溯特定时间点的库存余额</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(change_qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trans_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;2023-10-01 08:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> snapshot_balance</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inventory_transactions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id;</span></span></code></pre></div></li></ul><hr><h2 id="_2-盘点差异的自动化处理-variance-handling" tabindex="-1">2. 盘点差异的自动化处理 (Variance Handling) <a class="header-anchor" href="#_2-盘点差异的自动化处理-variance-handling" aria-label="Permalink to &quot;2. 盘点差异的自动化处理 (Variance Handling)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“盘亏了 10 个，我得手动开 10 个出库单，还得写原因，太麻烦”。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>自动对冲单据</strong>: <ul><li>开发者需提供“差异审批通过后自动记账”接口。</li><li><strong>PG 实现建议</strong>: 将盘点单及其生成的入/出库单据封装在同一个 <strong>数据库事务 (Transaction)</strong> 中，利用 <strong><code>SAVEPOINT</code></strong> 实现复杂的错误回滚逻辑，确保库存与财务单据的一致性。</li></ul></li><li><strong>差异分析扩展</strong>: <ul><li><strong>PG 实现建议</strong>: 使用 <strong>JSONB</strong> 存储盘点过程中的异常记录（如：破损图片路径、现场备注、复核人轨迹），方便后续审计且不增加主表字段压力。</li></ul></li></ul><hr><h2 id="_3-周期盘点算法-cycle-counting" tabindex="-1">3. 周期盘点算法 (Cycle Counting) <a class="header-anchor" href="#_3-周期盘点算法-cycle-counting" aria-label="Permalink to &quot;3. 周期盘点算法 (Cycle Counting)&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“我不知道哪些物料该盘了，全靠仓库管理员心情”</strong>。</p><h3 id="开发算法" tabindex="-1">开发算法 <a class="header-anchor" href="#开发算法" aria-label="Permalink to &quot;开发算法&quot;">​</a></h3><ul><li><strong>ABC 分类驱动</strong>: <ul><li>A 类（贵重）: 每月盘点。</li><li>B 类: 每季盘点。</li><li>C 类: 每年盘点。</li></ul></li><li><strong>调度引擎</strong>: <ul><li>开发者需编写一个 Job，每天根据 <code>Item.Last_Count_Date</code> 和 <code>ABC_Class</code> 自动产生 <code>Suggested_Count_Task</code>。</li><li><strong>PG 实现建议</strong>: 使用 <strong><code>pg_cron</code></strong> 扩展直接在数据库层级调度盘点任务生成逻辑，减少对外部中间件的依赖。</li></ul></li></ul><hr><h2 id="_4-盲盘与实盘逻辑-blind-count" tabindex="-1">4. 盲盘与实盘逻辑 (Blind Count) <a class="header-anchor" href="#_4-盲盘与实盘逻辑-blind-count" aria-label="Permalink to &quot;4. 盲盘与实盘逻辑 (Blind Count)&quot;">​</a></h2><h3 id="企业痛点-3" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-3" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“仓库员偷懒，直接按系统显示的数字填盘点表”。</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>盲盘控制 (Blind Count)</strong>: <ul><li>开发者需在 UI 或 PDA 接口中增加 <code>Is_Blind_Count</code> 参数。</li></ul></li><li><strong>并发安全性</strong>: <ul><li><strong>PG 实现建议</strong>: 在执行差异过账时，使用 <strong><code>SELECT ... FOR UPDATE</code></strong> 锁定 <code>inventory_balance</code> 相关行，防止在记账瞬间发生并行的收发货事务导致数据失准。</li></ul></li><li><strong>审计追踪</strong>: <ul><li><strong>PG 实现建议</strong>: 利用 PostgreSQL 的 <strong><code>Trigger</code></strong> 自动记录盘点单状态变更历史到 <code>audit_log</code> 表中，记录 <code>OLD</code> 和 <code>NEW</code> 值的差异。</li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>多租户数据隔离</strong>: 是否已配置 <strong>RLS (Row-Level Security)</strong> 确保不同组织的盘点单物理隔离？</li><li>[ ] <strong>数值精度</strong>: 盘点差异计算是否统一使用 <strong><code>numeric</code></strong> 类型以避免浮点数精度丢失？</li><li>[ ] <strong>PDA 集成</strong>: 接口是否支持连续扫描条码并自动累加实盘数量？</li><li>[ ] <strong>历史追溯</strong>: 是否保存了盘点前的原始快照和盘点后的修正轨迹？</li></ul>`,30)])])}const p=s(l,[["render",o]]);export{u as __pageData,p as default};
