# 调拨与形态转换 (Inventory Ops) - 开发者详尽指南

## 概述
库存移动不只是位置的变化，更是**资产权属与价值形态**的流转。开发者必须理解：每一次 `Move` 都可能触发**财务过账、税路切换、甚至组织间的结算**。

---

## 1. 跨组织调拨逻辑 (Inter-Org Transfer)

### 企业痛点
**“总公司调拨给分公司，财务上居然没产生往来账，税局查出大问题”**。

### 开发逻辑点
- **双向事务模型 (Two-Step Transfer)**: 
    - 开发者不应只写一个“修改位置”的 SQL。
    - **逻辑**: 
        - 1. 发出组织：执行 `Issue_Out`（资产减少），自动产生“发出商品”凭证。
        - 2. 接收组织：执行 `Receipt_In`（资产增加），自动产生“在途物资”凭证。
- **内部结算价格**: 
    - 开发者需支持从 `Inter_Company_Price_List` 读取价格，而不是强制使用成本价，以满足跨组织利润分配的需求。

---

## 2. 形态转换与等级管理 (Transformation)

### 企业痛点
“一堆原材料加工成了边角料，或者 A 等品降级成了 B 等品，账面上对不齐”。

### 开发逻辑点
- **多对多转换模型**: 
    - 开发者需支持 `1:N`（拆分）、`N:1`（组合）、`A:B`（转换）模型。
    - **逻辑**: `SUM(Input_Value) = SUM(Output_Value)`。
    - **开发注意**: 转换过程中如果产生价值损失，开发者需强制要求选择 `Reason_Code` 并记入 `制造费用 - 转换损耗`。
- **批次继承**: 
    - 转换后的新料品，开发者需在数据库中记录其 `Source_Lot`（源批次），确保质量追溯链条不断。

---

## 3. 库位管理与路径规划 (Location Control)

### 企业痛点
“仓库太大，员工调拨个货要跑半天，还容易放错位”。

### 开发逻辑点
- **库位策略 (Location Strategy)**: 
    - 开发者需在调拨单据中增加 `Suggested_Location` 逻辑。
    - **算法**: 根据 `Item_Category` 匹配 `Zone_Priority`，优先引导员工将物料放在最近的空货位。
- **库存锁定 (Locking)**: 
    - 调拨中（In-Transit）的库存，开发者需在全局 ATP 计算中将其标记为 `Moving`，不可被其他订单占用。

---

## 4. 条码与 PDA 异步处理 (Barcode Integration)

### 企业痛点
**“现场调拨很快，但系统过账很慢，导致库存数据延迟”**。

### 开发逻辑点
- **离线/异步过账**: 
    - 开发者需为 PDA 接口设计 `Job_Queue`。
    - **流程**: 
        - 1. PDA 扫描即刻记录 `Local_Success`。
        - 2. 后端异步队列逐条处理库存扣减和财务过账。
        - 3. 处理失败时，开发者需实现 `Error_Notification` 给仓库主管。

---

## 5. 开发者 Checklist

- [ ] **计量单位**: 调拨时，发货单位（如：箱）与收货单位（如：个）不一致时的换算逻辑。
- [ ] **序列号追溯**: 调拨单是否强制要求扫描每一个 `SN`？
- [ ] **权限隔离**: 调拨单的“发出”与“接收”是否由不同权限的用户操作？
- [ ] **自动冲销**: 跨组织调拨完成时，是否自动核销了对应的 `调拨申请单` 数量？
