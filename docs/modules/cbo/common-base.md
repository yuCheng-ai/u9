# 公共基础 (Common Base) - 开发者详尽指南

## 概述
公共基础模块（CBO-Base）是整个 ERP 系统的“基石”。如果这部分逻辑写错或理解不透，后续所有的销售、采购、生产、财务单据都会出现连锁崩盘。开发者不能将其简单理解为“配置表”，它是**业务合规性**和**计算准确性**的源头。

---

## 1. 币种与汇率 (Currency & Exchange Rate)

### 企业痛点
全球化企业每天都在处理不同币种。痛点在于：**汇率是波动的**。一笔采购单在录入时是 1:7.1，到付款时可能是 1:7.2。如果开发者没处理好“汇率时点”和“本币转外币”的精度，财务账永远对不齐。

### 核心逻辑
- **本位币 (Base Currency)**: 账簿核算的基础币种（如人民币）。
- **交易币 (Transaction Currency)**: 业务发生时的币种（如美元）。
- **汇率类型**: 
    - **固定汇率**: 月初统一设定的核算汇率。
    - **浮动汇率**: 每日从银行接口同步的实时汇率。
- **开发逻辑点**:
    - **金额存储**: 必须同时存储 `Amount_TC` (交易币金额) 和 `Amount_BC` (本位币金额)。
    - **精度陷阱**: 金额字段必须使用 `Decimal` 类型，严禁使用 `Float`。本位币转外币时，舍入规则必须遵循财务准则（四舍五入或去尾）。

---

## 2. 会计日历 (Accounting Calendar)

### 企业痛点
现实业务中，1 月 1 号到 1 月 31 号不一定叫“一个期间”。有些企业按周核算（4-4-5 模式），有些企业需要提前封账。如果开发者直接用数据库的 `DATE_PART` 来取月份，会导致财务报表完全对不上业务周期。

### 核心对象
- **期间 (Period)**: 最小的核算时间片段。
- **状态控制**: 
    - `Open`: 可录入单据。
    - `Closed`: 禁止任何业务改动，已生成的凭证不可删除。
- **开发逻辑点**:
    - **期间判定**: 所有的业务单据必须根据其“业务日期”反查 `CalendarTable` 得到对应的 `PeriodID`。
    - **跨期处理**: 严格限制“倒填单”。开发者需实现校验逻辑，禁止在已关账的期间录入历史日期单据。

---

## 3. 税制与税率 (Taxation)

### 企业痛点
税收是 ERP 中最复杂的部分。痛点在于：同一个物料，卖给内贸是 13% 增值税，卖给外贸是 0% 出口退税；送给客户是“视同销售”。

### 核心对象
- **税码 (Tax Code)**: 组合了税种、税率、计税逻辑的复合对象。
- **含税/不含税价格**: 
    - `不含税价 * (1 + 税率) = 含税价`
    - `含税价 / (1 + 税率) = 不含税价`
- **开发逻辑点**:
    - **计算反推**: 开发者在写单据逻辑时，必须支持“从含税倒推不含税”和“从不含税推导含税”两种模式。
    - **舍入差异**: 
        - 场景：100 元含税，13% 税率。
        - 计算：不含税 = 88.4955...，税额 = 11.5044...
        - **必须处理**: 尾数必须在最后一行自动配平，确保 `不含税 + 税额 = 含税` 绝对成立，否则财务凭证无法平账。

---

## 4. 开发者 Checklist

- [ ] **币种转换**: 是否考虑了汇率失效日期？
- [ ] **期间校验**: 业务操作前是否校验了会计期间的 `Open` 状态？
- [ ] **精度对齐**: 数据库字段是否定义为 `decimal(18, 4)` 或更高？
- [ ] **系统参数**: 是否通过全局缓存获取这些基础配置，而非硬编码？
