import{_ as i,c as a,o as t,ae as e}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"BOM 维护与多版本控制 (BOM) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/mfg/bom-manage.md","filePath":"modules/mfg/bom-manage.md"}'),n={name:"modules/mfg/bom-manage.md"};function l(h,s,r,o,p,k){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="bom-维护与多版本控制-bom-开发者详尽指南" tabindex="-1">BOM 维护与多版本控制 (BOM) - 开发者详尽指南 <a class="header-anchor" href="#bom-维护与多版本控制-bom-开发者详尽指南" aria-label="Permalink to &quot;BOM 维护与多版本控制 (BOM) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>物料清单（BOM）是制造系统的“基因”。在开发视角下，BOM 不是一张静态表，而是一个<strong>具有时间维度的递归图结构</strong>。开发者必须利用 PostgreSQL 的<strong>递归查询能力</strong>、<strong>范围类型约束</strong>和<strong>图路径分析</strong>，确保 BOM 结构的高效检索与逻辑严密性。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>BOM 环路噩梦</strong>：用户不小心把成品设成了零件，导致系统陷入死循环崩溃。</td><td style="text-align:left;"><strong>实时递归环路探测</strong>：在 <code>BeforeSave</code> 事务中，利用向上递归 CTE 探测血缘，发现循环引用立即拦截。</td></tr><tr><td style="text-align:left;"><strong>版本“重叠”</strong>：同一个料品在同一天有两个不同的有效 BOM，MRP 算不准。</td><td style="text-align:left;"><strong>排他性时间约束（EXCLUDE）</strong>：利用数据库 GIST 索引，强制保证同一物料的有效期区间在时间轴上不重叠。</td></tr><tr><td style="text-align:left;"><strong>虚设件穿透难</strong>：研发为了方便看图纸加了虚设件，但生产领料得直接领底层的螺丝。</td><td style="text-align:left;"><strong>逻辑展开引擎</strong>：在展开算法中识别 <code>Phantom</code> 标识，自动实现“穿透”逻辑，直接连接子项。</td></tr><tr><td style="text-align:left;"><strong>替代料分配乱</strong>：主料没货了，替代料怎么领？谁先谁后？</td><td style="text-align:left;"><strong>优先级路由模型</strong>：定义替代组（Substitution Group）与优先级，结合 <code>JSONB</code> 规则引擎自动匹配库存。</td></tr></tbody></table><hr><h2 id="_1-递归存储与高性能环路检测-structure-performance" tabindex="-1">1. 递归存储与高性能环路检测 (Structure &amp; Performance) <a class="header-anchor" href="#_1-递归存储与高性能环路检测-structure-performance" aria-label="Permalink to &quot;1. 递归存储与高性能环路检测 (Structure &amp; Performance)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>一个复杂产品可能有上万个零件，层级极深。开发者必须解决高效展开与<strong>保存时实时环路检测</strong>的问题。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>高效向上探测</strong>: 只需对本次修改的 <code>parent_id</code> 向上递归探测其所有父件，看是否包含本次要加入的 <code>component_id</code>。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 高效向上探测环路</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_trace </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> component_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :new_parent_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_item_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_trace pt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">component_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_item_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_trace </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :new_component_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_2-版本切换与时间轴控制-effectivity" tabindex="-1">2. 版本切换与时间轴控制 (Effectivity) <a class="header-anchor" href="#_2-版本切换与时间轴控制-effectivity" aria-label="Permalink to &quot;2. 版本切换与时间轴控制 (Effectivity)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“新旧更替”。BOM 的变更必须精确到天。</p><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>排除约束</strong>: 利用 PostgreSQL 的 <strong>EXCLUDE CONSTRAINT</strong>。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 在数据库层强制版本时间不重叠</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CONSTRAINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom_time_no_overlap </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXCLUDE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gist (parent_item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, validity_period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp;);</span></span></code></pre></div></li></ul><hr><h2 id="_3-虚设件与替代料逻辑-phantom-substitution" tabindex="-1">3. 虚设件与替代料逻辑 (Phantom &amp; Substitution) <a class="header-anchor" href="#_3-虚设件与替代料逻辑-phantom-substitution" aria-label="Permalink to &quot;3. 虚设件与替代料逻辑 (Phantom &amp; Substitution)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>虚设件（Phantom）需穿透处理，替代料（Substitution）需按优先级自动分配。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>穿透展开</strong>: 在生产领料计算时，遇到虚设件必须自动向下穿透到非虚设子件。</li><li><strong>替代规则</strong>: 替代组内必须定义优先级（Priority）与比例。</li></ul><hr><h2 id="_4-损耗率与精密用量计算-usage-precision" tabindex="-1">4. 损耗率与精密用量计算 (Usage &amp; Precision) <a class="header-anchor" href="#_4-损耗率与精密用量计算-usage-precision" aria-label="Permalink to &quot;4. 损耗率与精密用量计算 (Usage &amp; Precision)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>精密制造要求用量计算极其准确。</p><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>计算公式</strong>: <code>实际需求 = (标准用量 / 基数) * (1 + 损耗率) + 固定损耗</code>。</li><li><strong>精度控制</strong>: 所有的用量、损耗率字段统一使用 <code>numeric(24, 12)</code>。</li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>递归深度</strong>: 递归查询是否设置了 <code>depth</code> 限制以应对极端情况？</li><li>[ ] <strong>低层码 (LLC)</strong>: 是否实现了基于递归 CTE 的 LLC 自动更新算法？（LLC 决定了 MRP 的计算顺序）。</li><li>[ ] <strong>约束严密性</strong>: 是否在数据库层通过 <code>CHECK</code> 约束防止了用量为负数的情况？</li><li>[ ] <strong>性能优化</strong>: 是否对 <code>parent_item_id</code> 和 <code>component_id</code> 建立了复合索引？</li><li>[ ] <strong>状态控制</strong>: 已审核的 BOM 是否锁定了明细行，禁止直接修改（必须走 ECN）？</li><li>[ ] <strong>子项唯一性</strong>: 同一个 BOM 版本下，同一个子项（Component）是否只允许出现一次？</li></ul>`,33)])])}const c=i(n,[["render",l]]);export{g as __pageData,c as default};
