# 采购询比价与价格控制 - 开发者详尽指南

## 概述
采购价格是企业的“利润源泉”。开发者必须理解：价格不是一个静态的字段，而是一个**受供应商、批量、有效期、币种、税率**多维控制的动态模型。

---

## 1. 价格表引擎 (Price List Engine)

### 企业痛点
**“同样的零件，买 10 个和买 1000 个价格不一样，开发者如果只写一个单价字段，业务员就得天天改价格”**。

### 开发逻辑点
- **分级价格模型 (Tiered Pricing)**: 
    - 开发者需支持 `Price_Break` 逻辑。
    - **逻辑**: `IF (Qty >= 1000) THEN Price = 0.8 ELSE Price = 1.0`。
- **有效期过滤**: 
    - 所有的价格获取接口必须强制传入 `Date` 参数。
    - **SQL 逻辑**: `WHERE start_date <= :today AND end_date >= :today`。
- **币种与税率转换**: 
    - 开发者需自动处理汇率换算。
    - **公式**: `含税本币价 = 外币价 * 汇率 * (1 + 税率)`。

---

## 2. 询比价逻辑 (Quotation & Comparison)

### 企业痛点
“我想看过去三年这个零件的价格走势，系统里只能看当前的”。

### 开发逻辑点
- **价格足迹 (Price Trace)**: 
    - 开发者需维护 `Price_History` 表。
    - **逻辑**: 每当一个新的询价单（RFQ）转化为价格表时，自动记录旧价格的失效原因。
- **多维度比价算法**: 
    - 开发者需实现一个“最优选商引擎”。
    - **因子**: `Price (60%) + LeadTime (20%) + QualityScore (20%)`。
    - **输出**: 自动标记出 `Lowest_Price` 和 `Best_Value` 供应商。

---

## 3. 采购合同与框架协议 (Contract Control)

### 企业痛点
**“签了 100 万的框架协议，结果下采购单下了 120 万，系统也没拦截”**。

### 开发逻辑点
- **执行进度监控**: 
    - 开发者需在 `Contract_Header` 维护 `Executed_Amount` 和 `Remaining_Amount`。
- **强控逻辑**: 
    - 在采购单（PO）审核 API 中增加拦截：`IF (PO.Total + Contract.Executed > Contract.Max_Limit) THEN REJECT`。
- **自动冲销**: 
    - PO 审核时扣减合同额度，PO 作废时恢复额度。

---

## 4. 价格预警与反舞弊 (Price Audit)

### 企业痛点
“采购员私自把价格调高了 10%，财务根本发现不了”。

### 开发逻辑点
- **价格偏离度检查**: 
    - 开发者需在 PO 保存前对比 `Item.Standard_Cost` 或 `Item.Last_Purchase_Price`。
    - **逻辑**: `IF (ABS(NewPrice - OldPrice) / OldPrice > Threshold) THEN 强制进入高层审批流`。
- **最低价锁定**: 
    - 开发者可配置 `Is_Lowest_Price_Only` 开关。如果开启，系统严禁采购员选择非最低价供应商，除非填写 `Reason_Code`。

---

## 5. 开发者 Checklist

- [ ] **精密精度**: 采购单价通常需要 6-8 位小数（处理高价值小件）。
- [ ] **分布式缓存**: 价格表查询极其频繁，是否对 `Price_List` 做了热点数据缓存？
- [ ] **供应商黑名单**: 询价单接口是否自动过滤了黑名单中的供应商？
- [ ] **附件安全**: 询价单关联的图纸附件是否实现了权限加密？
