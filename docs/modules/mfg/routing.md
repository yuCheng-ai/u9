# 工艺路线与资源 (Routing) - 开发者详尽指南

## 概述
如果说 BOM 是“配方”，那么工艺路线（Routing）就是“烹饪步骤”。开发者必须理解：工艺路线是**工序、工时、工作中心、设备资源**的四维坐标系。它是生产排产（APS）和工序成本（Costing）的底层骨架。

---

## 1. 工序与时间模型 (Operation & Time Model)

### 企业痛点
**“算出来的生产工期永远不准，不是早了就是晚了”**。

### 开发逻辑点
- **精密工时模型**: 开发者需支持以下四种时间维度的累加：
    - `Setup_Time` (准备时间): 与批量无关（如：洗锅、调机）。
    - `Run_Time` (运行时间): 与批量正相关（如：炒菜）。
    - `Wait_Time` (等待时间): 工序内必须的物理等待（如：冷却、发酵）。
    - `Move_Time` (移动时间): 工序间的转运时间。
- **排程公式**: `Total_Operation_Time = Setup_Time + (Run_Time * Order_Qty) + Wait_Time + Move_Time`。
- **开发注意**: 所有的工时必须支持“秒/分/时”的单位转换，且精度至少保留 4 位小数。

---

## 2. 工作中心与资源能力 (Work Center & Capacity)

### 企业痛点
“明明只有 3 台机器，系统却排了 5 个人的活，导致现场大乱”。

### 开发逻辑点
- **能力建模 (Capacity)**: 
    - 开发者需维护 `Work_Center_Resource` 表。
    - **逻辑**: `Daily_Capacity = 资源数量 * 班次工时 * 效率系数`。
- **有限能力校验 (Finite Capacity)**: 
    - 在排产接口中，开发者需增加“超载拦截”或“自动顺延”逻辑。
    - **算法**: `Next_Available_Start_Date = MAX(Resource_Busy_Until, Material_Ready_Date)`。

---

## 3. 委外工序的逻辑穿透 (Subcontracting Operation)

### 企业痛点
**“中间有一道电镀工序是外协的，系统里就断档了，根本不知道货在哪”**。

### 开发逻辑点
- **逻辑跳变**: 
    - 当工序属性 `Is_Subcontracted == True` 时，开发者需触发“采购逻辑”。
    - **自动触发**: 生产订单下达到该工序时，自动生成 `Subcontract_Purchase_Request`。
- **物流跟踪**: 
    - 开发者需设计 `Operation_Transfer_Out`（发出给委外商）和 `Operation_Transfer_In`（从委外商收回）事务，确保 WIP 价值链不断裂。

---

## 4. 关键工序与移动控制 (Move Control)

### 企业痛点
“前面的工序还没干完，后面的就报工了，导致报表上的在制品数量是负数”。

### 开发逻辑点
- **移动策略 (Move Policy)**: 
    - 开发者需在工序定义中增加 `Move_Point_Flag`。
    - **逻辑**: 只有在 `Qualified_Qty` 产生后，才允许调用 `Operation_Move_API`。
- **关键路径 (Critical Path)**: 
    - 开发者需支持“里程碑汇报”。只有关键工序汇报了，才更新 MO 的整体百分比进度。

---

## 5. 开发者 Checklist

- [ ] **递归路径**: 复杂的工艺路线可能包含分支（并行工序），排程算法是否支持“同步开始”或“同步结束”？
- [ ] **成本中心关联**: 每一个工作中心是否都正确映射到了财务的 `Cost_Center`？
- [ ] **版本切换**: 正在生产的订单是否支持“在线切换”工艺路线？（涉及 WIP 重算）。
- [ ] **效率系数**: 开发者是否预留了“设备稼动率”和“人员熟练度”对工时的修正系数接口？
