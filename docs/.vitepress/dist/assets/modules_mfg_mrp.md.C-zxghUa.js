import{_ as i,c as a,o as l,ae as n}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"MRP/MPS 运算与平衡 - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/mfg/mrp.md","filePath":"modules/mfg/mrp.md"}'),t={name:"modules/mfg/mrp.md"};function e(h,s,r,k,p,o){return l(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="mrp-mps-运算与平衡-开发者详尽指南" tabindex="-1">MRP/MPS 运算与平衡 - 开发者详尽指南 <a class="header-anchor" href="#mrp-mps-运算与平衡-开发者详尽指南" aria-label="Permalink to &quot;MRP/MPS 运算与平衡 - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>MRP（物料需求计划）是 ERP 的“中央处理器”。在开发视角下，MRP 的本质是<strong>基于时间轴的供需矢量对冲</strong>。它的核心逻辑是在正确的时间，准备正确数量的正确物料。开发者必须利用 PostgreSQL 的<strong>递归查询能力</strong>、<strong>窗口函数</strong>和<strong>高性能中间表</strong>，构建一个能够处理海量 BOM 展开与供需平衡的计算引擎。</p><hr><h2 id="_1-核心算法-时序净需求计算-net-requirement" tabindex="-1">1. 核心算法：时序净需求计算 (Net Requirement) <a class="header-anchor" href="#_1-核心算法-时序净需求计算-net-requirement" aria-label="Permalink to &quot;1. 核心算法：时序净需求计算 (Net Requirement)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“算多了是库存，算少了是停工”。净需求必须考虑现有库存、在途供应、已分配需求以及安全库存。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>供需对冲逻辑</strong>: <code>净需求 = (毛需求 + 安全库存) - (现有库存 + 预计入库 - 预计出库)</code>。</li><li><strong>时间归并</strong>: 需求应按天或周归并，并根据物料提前期（Lead Time）向前偏移。</li><li><strong>技术实现建议</strong>: <ul><li><strong>滚动可用量计算</strong>: 利用 PostgreSQL 的 <strong>Window Functions (窗口函数)</strong>，通过 <code>SUM(qty) OVER (PARTITION BY item_id ORDER BY plan_date)</code> 实时计算全时间轴的预计可用量（PAB）。</li><li><strong>逾期处理</strong>: 在 SQL 过滤中增加逻辑，自动将逾期未收货的 PO 或逾期未完工的 MO 标识为“风险供应”，并由 MRP 建议重新排程。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 计算物料 PAB (Projected Available Balance)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_id, plan_date, change_qty,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(change_qty) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OVER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PARTITION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plan_date) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pab</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mrp_supply_demand_details;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_2-产能约束与排产方案-crp-simulation" tabindex="-1">2. 产能约束与排产方案 (CRP &amp; Simulation) <a class="header-anchor" href="#_2-产能约束与排产方案-crp-simulation" aria-label="Permalink to &quot;2. 产能约束与排产方案 (CRP &amp; Simulation)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><ul><li><strong>无限产能 (Infinite Capacity)</strong>: 只考虑物料，假设产能无限。适合计划初期。</li><li><strong>有限产能 (Finite Capacity/CRP)</strong>: 必须考虑工作中心（WC）的实际工时约束。</li><li><strong>逾期供应处理</strong>: 逾期未收货的采购单（PO）或未完工的生产单（MO），系统是假设明天就能到货，还是自动向后推延？</li></ul><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>方案隔离</strong>: 所有计算结果必须关联 <code>Plan_ID</code>。</li><li><strong>逾期自动推延</strong>: 针对逾期单据，MRP 引擎应提供“重排建议”（Reschedule Message），而非盲目假设供应依然有效。</li></ul><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>资源负荷计算</strong>: 将工作中心的日历与可用工时存储为位图（Bitmap）或 <code>JSONB</code> 数组，快速进行“扣减”操作。</li><li><strong>高性能中间存储</strong>: 使用 PostgreSQL 的 <strong>UNLOGGED TABLES</strong> 存储 MRP 计算的中间过程数据。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 检查资源是否超载</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wc_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(required_hours) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> load</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mrp_resource_plan</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wc_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">date</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HAVING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(required_hours) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :max_capacity;</span></span></code></pre></div></li></ul><hr><h2 id="_3-bom-展开与低层码逻辑-llc-explosion" tabindex="-1">3. BOM 展开与低层码逻辑 (LLC &amp; Explosion) <a class="header-anchor" href="#_3-bom-展开与低层码逻辑-llc-explosion" aria-label="Permalink to &quot;3. BOM 展开与低层码逻辑 (LLC &amp; Explosion)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>MRP 必须从最高层父件向最底层子件逐层计算，否则会导致物料需求计算不全。</p><h3 id="开发规范-2" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-2" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>LLC (低层码) 优先</strong>: 必须按照 LLC 从小到大的顺序处理物料。</li><li><strong>批量舍入</strong>: 考虑起订量（MOQ）和包装增量（Lot Size）。</li><li><strong>技术实现建议</strong>: <ul><li><strong>递归 LLC 计算</strong>: 利用 PostgreSQL 的 <strong>Recursive CTE (递归公用表表达式)</strong> 自动计算全库物料的 LLC 码，相比于传统的循环逻辑，效率提升数十倍。</li><li><strong>舍入逻辑封装</strong>: 编写 PL/pgSQL 函数处理复杂的舍入规则（如：<code>CEIL(qty / lot_size) * lot_size</code>），确保计算逻辑在数据库层统一。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 递归计算低层码 (LLC)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> llc_calc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_top_level </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">component_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bom b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> llc_calc lc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAX</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">level</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> llc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> llc_calc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_4-计划输出与例外消息-action-messages" tabindex="-1">4. 计划输出与例外消息 (Action Messages) <a class="header-anchor" href="#_4-计划输出与例外消息-action-messages" aria-label="Permalink to &quot;4. 计划输出与例外消息 (Action Messages)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>MRP 不仅产生建议单，更重要的是产生“例外消息”（如：取消、提前、推迟）。</p><h3 id="开发规范-3" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-3" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>例外识别</strong>: 自动对比现有供应日期与需求日期的偏差。</li><li><strong>建议转正式</strong>: 提供一键将建议单（Planned Order）转化为正式采购单或生产单的接口。</li><li><strong>技术实现建议</strong>: <ul><li><strong>差异分析引擎</strong>: 利用 PostgreSQL 的 <strong>EXCEPT</strong> 或 <strong>INTERSECT</strong> 操作符快速比对本次计算与上次计算的差异，仅向用户推送增量变动消息。</li><li><strong>批量转化</strong>: 使用 <code>INSERT INTO ... SELECT</code> 结构实现建议单到正式单的批量转化，确保数据一致性。</li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>递归深度</strong>: 递归 CTE 是否设置了合理的深度限制，防止 BOM 环路导致死循环？</li><li>[ ] <strong>工厂日历</strong>: 日期偏移计算是否通过数据库函数关联了 <code>Work_Calendar</code>，排除了非工作日？</li><li>[ ] <strong>高精度</strong>: 所有的需求数量计算是否使用了 <code>numeric(24, 12)</code> 以防止多层 BOM 累加产生的精度丢失？</li><li>[ ] <strong>并行计算</strong>: 是否利用了 PostgreSQL 的 <strong>Parallel Query (并行查询)</strong> 特性来加速大规模供需对冲的扫描速度？</li><li>[ ] <strong>事务隔离</strong>: MRP 运行期间是否使用了 <code>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ</code> 确保快照的一致性？</li></ul>`,32)])])}const E=i(t,[["render",e]]);export{g as __pageData,E as default};
