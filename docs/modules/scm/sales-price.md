# 销售价格体系 - 开发者详尽指南

## 概述
销售价格是企业的“盈利边界”。开发者必须理解：销售价格模型是一个**多因子复合逻辑**。它不是从数据库取一个 `Price` 字段那么简单，而是通过一系列**路由规则、优先级、阶梯算法、以及折扣叠加**最终计算出的结果。

---

## 1. 取价引擎算法 (Pricing Search Engine)

### 企业痛点
**“客户抱怨我给他的价格比上个月贵了，销售员说他记错了，系统里也没个自动取价逻辑”**。

### 开发逻辑点
- **瀑布式搜索策略 (Waterfall Search)**: 
    - 开发者需实现一个可配置的搜索链条。
    - **PG 实现建议**: 使用 **CTE (Common Table Expressions)** 构建层级搜索查询，结合 **`UNION ALL`** 和 **`LIMIT 1`** 实现具有优先级的“熔断”取价逻辑。
- **日期与状态校验**: 
    - 接口必须校验价格的有效性。
    - **PG 实现建议**: 使用 **`daterange`** 类型存储价表有效期，并利用 **`GIST` 索引** 实现毫秒级的日期重叠与包含查询。

---

## 2. 阶梯价格与批量计算 (Volume Tiering)

### 企业痛点
“买 1 个和买 1000 个的价格是不一样的，开发者如果处理不好，销售员录单时得手动计算，效率极低”。

### 开发算法
- **区间查找算法**: 
    - 开发者需维护 `Price_Break` 表。
    - **PG 实现建议**: 使用 **`numrange`** 类型存储数量区间，通过 `@>` 操作符直接定位订单数量所在的阶梯。
- **阶梯模式支持**: 
    - **全额阶梯**: 全部按某一单价。
    - **超额阶梯**: 类似个税的分段计算。
    - **PG 实现建议**: 利用 **窗口函数 (Window Functions)** 计算分段累计金额，避免在应用层进行复杂的循环累加逻辑。

---

## 3. 多重折扣叠加逻辑 (Discount Stacking)

### 企业痛点
**“又有节日折扣 9 折，又有会员折扣 95 折，到底是 85 折还是 85.5 折？”**。

### 开发逻辑点
- **折扣类型定义**: 
    - `Additive` (相加)、`Compounded` (相乘)。
- **折扣序列 (Discount Sequence)**: 
    - 开发者需确保计算顺序的一致性。
    - **PG 实现建议**: 使用 **数组聚合 (`array_agg`)** 收集所有生效折扣，并在自定义函数中使用 **PL/pgSQL** 按照业务规则（如：先算加法折扣，再算乘法折扣）进行精确计算。

---

## 4. 价格强控与最低限价 (Price Ceiling/Floor)

### 企业痛点
“销售为了拿提成，故意把价格压得很低，结果公司亏本卖货”。

### 开发逻辑点
- **底线校验**: 
    - 开发者需在 SO 审核 API 中强制接入校验。
    - **PG 实现建议**: 使用 **`CHECK` 约束** 结合自定义函数实现数据库层级的最低价拦截。
- **动态审批流触发**:
    - **PG 实现建议**: 利用 **`NOTIFY / LISTEN`** 机制。当价格偏离度超过阈值时，自动触发异步审批工作流，提高系统吞吐量。

---

## 5. 开发者 Checklist

- [ ] **高精度计算**: 所有的单价、折扣、总额计算是否统一使用 **`numeric`** 类型？
- [ ] **多租户隔离**: 是否通过 **RLS** 确保不同分公司的价格政策物理隔离？
- [ ] **性能优化**: 是否对常用的 `(item_id, customer_id, validity_range)` 组合建立了索引？
- [ ] **审计记录**: 是否利用 **`JSONB`** 记录了每次自动取价的“计算足迹”（即：为何取了 A 价而不是 B 价）？
