# 企业建模 (Organization Modeling) - 开发者详尽指南

## 概述
企业建模（Org Modeling）是 ERP 的“灵魂”。在 U9 中，组织不仅仅是一个 `ID`，它是一组**职能开关**。如果开发者在代码中硬编码了组织判断，或者没有正确处理“组织上下文（Context）”，系统在支持集团化运作时就会彻底崩溃。

---

## 1. 组织的本质：职能 (Org Functions)

### 企业痛点
在单体软件中，公司就是公司。但在集团企业中，一个物理地点可能既是“工厂”又是“仓库”，还可能是“独立核算的子公司”。开发者如果把组织写死成固定的分类，就无法支持这种灵活性。

### 开发逻辑点
- **职能解耦**: 组织对象包含一系列布尔值：`IsSalesOrg`, `IsPurchaseOrg`, `IsInventoryOrg`, `IsMfgOrg`, `IsAccountingOrg`。
- **动态菜单控制**: 开发者在渲染 UI 菜单时，必须根据当前 `Context.OrgID` 的职能进行过滤。例如：当前组织没有“库存职能”，则不应显示“库存调拨”菜单。
- **业务校验**: 在单据保存后端，必须强校验。
    - *示例*: 录入销售订单时，Header 上的 `SalesOrg` 必须具有 `IsSalesOrg = true` 属性。

---

## 2. 组织上下文与多租户隔离 (Context & Isolation)

### 企业痛点
用户在 A 工厂录入单据，绝对不能看到 B 工厂的库存。开发者最容易在写 SQL 时忘记加 `OrgID` 过滤条件，导致严重的数据泄露。

### 开发逻辑点
- **ThreadLocal 上下文**: 每一个 API 请求都应携带 `OrgID`。开发者应通过全局变量（如 `UserContext.CurrentOrg`）获取当前操作组织。
- **SQL 拦截器**: 推荐在持久层（MyBatis/JPA）实现拦截器，自动在所有查询语句后追加 `AND org_id = ?`，防止漏写。
- **跨组织查询**: 对于“集团视图”报表，需显式声明 `IgnoreOrgFilter`，否则会因为自动拦截导致数据不全。

---

## 3. 组织间协同逻辑 (Inter-Org Synergy)

### 企业痛点
**“左手卖给右手”**。总公司卖给分公司，分公司卖给客户。如果分公司录入采购单后，总公司还得人工录入一遍销售单，那要 ERP 干什么？

### 开发逻辑点
- **自动触发器**: 开发者需实现“抛单引擎”。
    - *场景*: 组织 A 审核《内部采购单》。
    - *逻辑*: 钩子函数检测到供应商是“内部组织 B”，自动在组织 B 生成对应的《销售订单》，并建立两者的 `LinkID`。
- **价格对齐**: 内部交易价格通常不同于市场价（可能是成本加成）。开发者需调用 `InternalPriceService` 获取内部协议价，而非通用的价表。

---

## 4. 法人与账簿 (Legal Entity & Ledger)

### 企业痛点
一个法人可能有两套账：一套对税务局，一套对投资人。

### 开发逻辑点
- **1:N 映射**: 一个法人组织可以关联多个账簿（Ledger）。
- **多本位币处理**: 开发者在处理跨国组织时，需支持“双币记录”。即一条凭证同时记录 `LocalAmount` 和 `GroupAmount`。

---

## 5. 开发者 Checklist

- [ ] **职能检查**: 在单据 Service 层是否调用了 `OrgService.ValidateFunction(orgId, functionType)`？
- [ ] **数据越权**: 所有的 `Update` 和 `Delete` 操作是否都包含了 `OrgID` 条件？
- [ ] **级联删除**: 严禁直接删除组织。组织下只要有任何基础资料分配或业务单据，必须报错拦截。
- [ ] **缓存刷新**: 组织职能变更后，必须同步刷新 Redis 中的用户权限缓存。
