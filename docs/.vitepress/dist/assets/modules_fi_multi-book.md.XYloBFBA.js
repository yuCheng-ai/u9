import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const E=JSON.parse('{"title":"多账簿核算体系 (Multi-Book) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/fi/multi-book.md","filePath":"modules/fi/multi-book.md"}'),l={name:"modules/fi/multi-book.md"};function h(e,s,k,p,r,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="多账簿核算体系-multi-book-开发者详尽指南" tabindex="-1">多账簿核算体系 (Multi-Book) - 开发者详尽指南 <a class="header-anchor" href="#多账簿核算体系-multi-book-开发者详尽指南" aria-label="Permalink to &quot;多账簿核算体系 (Multi-Book) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>多账簿（Multi-Book）是解决“财务两张脸”的技术方案。在开发者眼中，这是一种**一写多读（Write Once, Post Multiple）**的架构。它确保了同一笔业务在不同会计准则（CAS, IFRS, US GAAP）下的数据强一致性。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>重复录入</strong>：为了满足不同上市地的准则，财务人员要录入多遍凭证。</td><td style="text-align:left;"><strong>AEP 自动分流引擎 (AEP_Router)</strong>：业务单据进入 AEP 后，利用 JSONB 存储的“路由规则栈”，根据预设准则自动并行生成多套账簿凭证。</td></tr><tr><td style="text-align:left;"><strong>差异难对平</strong>：中国准则和国际准则对研发支出的定义不同，导致资产总额对不上。</td><td style="text-align:left;"><strong>差异账簿模式 (Adjustment Ledger)</strong>：采用“主账簿 + 差异项”模式，报表查询时利用 <code>UNION ALL</code> 动态合并，减少 50% 的冗余存储。</td></tr><tr><td style="text-align:left;"><strong>折算损益（FCTR）计算难</strong>：跨国集团月末按不同汇率折算，借贷不平。</td><td style="text-align:left;"><strong>自动挤平算法 (Rounding_Offset)</strong>：在折算事务末尾自动检测借贷差额，并将其记入指定的“折算差额（FCTR）”科目。</td></tr><tr><td style="text-align:left;"><strong>数据同步断裂</strong>：主账记录改了，副账没改，导致审计失败。</td><td style="text-align:left;"><strong>两阶段提交 (2PC) / 原子事务</strong>：将所有账簿的凭证生成/修改包裹在同一个数据库事务内，确保要么全成功，要么全失败。</td></tr></tbody></table><hr><h2 id="_1-核心模型-主账簿与差异账簿-delta-storage" tabindex="-1">1. 核心模型：主账簿与差异账簿 (Delta Storage) <a class="header-anchor" href="#_1-核心模型-主账簿与差异账簿-delta-storage" aria-label="Permalink to &quot;1. 核心模型：主账簿与差异账簿 (Delta Storage)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>企业在 A 股上市（CAS），同时在香港上市（IFRS）。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>动态视图合并</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- IFRS 账簿 = CAS 账簿数据 + IFRS 专用差异项</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> VIEW</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> v_ifrs_ledger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> account_id, amount, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CAS&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ledger_cas</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> account_id, amount, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;IFRS_DELTA&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ledger_adjustments </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target_gaap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;IFRS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_2-aep-路由与分流逻辑-aep-routing" tabindex="-1">2. AEP 路由与分流逻辑 (AEP Routing) <a class="header-anchor" href="#_2-aep-路由与分流逻辑-aep-routing" aria-label="Permalink to &quot;2. AEP 路由与分流逻辑 (AEP Routing)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>销售发票产生时，系统需自动生成两张凭证：一张入主账，一张入管理账（按内部管理成本）。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>路由规则配置</strong>: 使用 JSONB 存储路由逻辑。<div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Sales_Invoice&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;ledgers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;ledger_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L001&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;rule_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;R_CAS_SALE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;ledger_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L002&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;rule_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;R_MGMT_SALE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><strong>并发锁</strong>: 在生成凭证前，必须使用 <code>SELECT ... FOR UPDATE</code> 锁定源业务单据，防止并发重写。</li></ul><hr><h2 id="_3-fctr-折算差额计算-currency-translation" tabindex="-1">3. FCTR 折算差额计算 (Currency Translation) <a class="header-anchor" href="#_3-fctr-折算差额计算-currency-translation" aria-label="Permalink to &quot;3. FCTR 折算差额计算 (Currency Translation)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>子公司本位币（Functional Currency）是越南盾，总部要求看人民币报表。</p><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>挤平逻辑</strong>: 开发者必须处理折算后由于小数位截断导致的 0.01 差异。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 计算折算后的借贷差异</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> converted_sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dr_local) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_dr, </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cr_local) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_cr </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tmp_voucher_lines</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tmp_voucher_lines (account_id, dr_local)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :fctr_account_id, (total_cr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_dr) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> converted_sum </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_cr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_dr;</span></span></code></pre></div></li></ul><hr><h2 id="_4-严谨性校验-弃审联动-un-approve-sync" tabindex="-1">4. 严谨性校验：弃审联动 (Un-approve Sync) <a class="header-anchor" href="#_4-严谨性校验-弃审联动-un-approve-sync" aria-label="Permalink to &quot;4. 严谨性校验：弃审联动 (Un-approve Sync)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>业务单据（如采购发票）弃审时，所有关联账簿的凭证必须同步回滚。</p><h3 id="技术实现建议-2" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-2" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>反审核拦截</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 检查任一账簿是否已记账（Posted）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gl_voucher </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source_doc_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Posted&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">THEN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  RAISE EXCEPTION </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ERR_UNAPPROVE_FORBIDDEN: 关联的某套账簿凭证已记账，请先冲销凭证&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li><li><strong>同步清理</strong>: 在同一个事务内删除所有账簿的草稿态凭证。</li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>科目映射</strong>: 不同账簿的科目体系可能不同，系统是否实现了 <code>Account_Mapping_Table</code>？</li><li>[ ] <strong>事务原子性</strong>: 并行生成 N 套账簿凭证时，是否包裹在同一个 <code>BEGIN...COMMIT</code> 块内？</li><li>[ ] <strong>审计足迹</strong>: 调整账簿的凭证是否记录了“差异原因”和“原始凭证 ID”？</li><li>[ ] <strong>分区性能</strong>: 凭证表数据量巨大时，是否按 <code>ledger_id</code> 和 <code>fiscal_period</code> 进行了物理分区？</li><li>[ ] <strong>汇率时效</strong>: 资产负债类科目的折算汇率是否严格取自“期间末日”的汇率？</li><li>[ ] <strong>AEP 性能</strong>: 是否支持异步生成副账簿凭证，以减轻主业务操作的响应时间？</li></ul>`,33)])])}const g=i(l,[["render",h]]);export{E as __pageData,g as default};
