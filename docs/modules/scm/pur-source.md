# 货源管理与配额分配 - 开发者详尽指南

## 概述
货源管理（Sourcing）是采购的“导航系统”。开发者必须理解：货源决定了**“向谁买”**以及**“买多少”**。在高并发的 MRP 运算中，货源逻辑必须是**毫秒级自动判定**的。

---

## 1. 货源清单与优先级逻辑 (Approved Vendor List)

### 企业痛点
**“新来的采购员买错了供应商，买到了没通过质量体系认证的小作坊”**。

### 开发逻辑点
- **AVL 强控逻辑 (Approved Vendor List)**: 
    - 开发者需在所有采购类单据的 `Item_Change` 事件中增加拦截。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`CHECK` 约束** 结合自定义函数，或者在单据保存的触发器中执行 AVL 校验，确保数据层面的绝对一致性。
- **有效期管理**: 
    - 货源关系必须有 `StartDate` 和 `EndDate`。
    - **PG 实现建议**: 使用 **`daterange`** 类型存储货源有效期，并利用 **`EXCLUDE` 约束** 防止同一物料在同一时间段内出现冲突的货源策略。

---

## 2. 配额比例分配算法 (Quota Allocation)

### 企业痛点
“我们要培养二供（备份供应商），要求 A 供应商占 70%，B 供应商占 30%，但手动算太麻烦，经常算错”。

### 开发算法
- **自动配额逻辑**: 
    - 开发者需在 MRP 建议转 PO 时，调用 `Quota_Split_Engine`。
    - **PG 实现建议**: 利用 PostgreSQL 的 **窗口函数 (Window Functions)** 和 **`CUME_DIST`** 实现复杂的配额占比计算，避免在应用层进行大规模循环。
- **累计差异补偿**: 
    - 开发者需考虑“历史累计量”。
    - **PG 实现建议**: 使用 **物化视图 (Materialized Views)** 预计算各供应商的累计供应量，并定期通过后台 Job 刷新，以支撑实时的配额补偿算法。

---

## 3. 跨组织货源协同 (Inter-Org Sourcing)

### 企业痛点
**“集团总部定好了供应商，下属工厂还得自己录一遍，效率太低”**。

### 开发逻辑点
- **货源下发机制**: 
    - 开发者需设计“主数据推送”逻辑。
    - **PG 实现建议**: 使用 PostgreSQL 的 **逻辑复制 (Logical Decoding)** 或 **`postgres_fdw`** 实现集团主数据到各工厂库的准实时同步。
- **组织特定偏置**: 
    - 开发者需允许工厂组织在继承集团货源的基础上增加偏置。
    - **PG 实现建议**: 使用 **继承表 (Table Inheritance)** 结构，让工厂表继承集团主表字段，并增加工厂特有的属性字段（如 `Local_Lead_Time`）。

---

## 4. 供应商评分与货源准入 (Supplier Scorecard)

### 企业痛点
“某个供应商最近老是延迟交货，我们想自动减少他的配额”。

### 开发逻辑点
- **动态评级接口**: 
    - 开发者需提供 `Update_Supplier_Rating` API。
    - **PG 实现建议**: 使用 **`NOTIFY / LISTEN`** 机制。当供应商评分更新时，触发信号，自动重算受影响物料的配额分配权重。
- **准入工作流**: 
    - 货源记录的新增必须关联供应商考察单。
    - **PG 实现建议**: 使用 **JSONB** 存储考察报告的结构化数据，方便在货源审批界面直接展示多维度的评估详情。

---

## 5. 开发者 Checklist

- [ ] **多租户隔离**: 是否启用了 **RLS** 确保不同法人的货源清单相互隔离？
- [ ] **高精度占比**: 配额比例计算是否使用了 **`numeric`** 类型以防止 100% 分配不尽的情况？
- [ ] **最小起订量 (MOQ)**: 分配配额时，是否考虑了供应商的 MOQ？
- [ ] **审计记录**: 是否利用 **`JSONB`** 记录了配额调整的完整轨迹和原因？
