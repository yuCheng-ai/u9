import{_ as i,c as a,o as t,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"系统集成方案 (Integration) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/sys/integration.md","filePath":"modules/sys/integration.md"}'),n={name:"modules/sys/integration.md"};function e(r,s,o,h,k,d){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="系统集成方案-integration-开发者详尽指南" tabindex="-1">系统集成方案 (Integration) - 开发者详尽指南 <a class="header-anchor" href="#系统集成方案-integration-开发者详尽指南" aria-label="Permalink to &quot;系统集成方案 (Integration) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>集成（Integration）是 ERP 系统的“血管”。开发者必须理解：集成不是简单的 API 对接，而是<strong>业务状态的同步、数据一致性的维护以及错误补偿机制</strong>。在一个典型的制造企业中，ERP 处于核心地位，上连 PLM（设计），下接 MES（执行）。</p><hr><h2 id="_1-plm-设计集成-研发到制造的桥梁-plm-to-erp" tabindex="-1">1. PLM 设计集成：研发到制造的桥梁 (PLM to ERP) <a class="header-anchor" href="#_1-plm-设计集成-研发到制造的桥梁-plm-to-erp" aria-label="Permalink to &quot;1. PLM 设计集成：研发到制造的桥梁 (PLM to ERP)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“研发改了 BOM，生产还在按旧图纸做，最后成品全报废”</strong>。</p><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>BOM 自动导入引擎</strong>: <ul><li>开发者需实现一个 <code>BOM_Parser</code>，支持 PLM 推送的 XML/JSON 格式数据。</li><li><strong>逻辑</strong>: <ul><li><ol><li>校验料品主档是否存在（不存在则自动创建 <code>Draft</code> 状态料品）。</li></ol></li><li><ol start="2"><li>建立 BOM 层次结构。</li></ol></li><li><ol start="3"><li>触发“成本重算”信号。</li></ol></li></ul></li></ul></li><li><strong>变更同步 (ECN Sync)</strong>: <ul><li>开发者需确保 PLM 的变更单（ECN）核准后，自动在 ERP 生成 <code>Engineering_Change_Order</code>，并触发 WIP（在制品）影响分析。</li></ul></li></ul><h3 id="postgresql-实现建议" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>JSONB 解析与验证</strong>: 利用 PG 的 <code>jsonb_to_recordset</code> 函数高效解析 PLM 推送的批量 BOM 数据，并结合 <code>CHECK</code> 约束和 <code>JSON Schema</code> 验证，确保数据的严谨性。</li><li><strong>递归 CTE 结构校验</strong>: 在导入新 BOM 前，利用递归 CTE 检查是否存在循环嵌套，防止逻辑死循环。</li><li><strong>物化视图预存影响分析</strong>: 针对 ECN 变更，使用物化视图缓存 WIP 影响分析结果，减少实时计算对主流程的阻塞。</li></ul><hr><h2 id="_2-mes-iot-现场集成-执行数据的实时反馈-erp-to-mes" tabindex="-1">2. MES/IoT 现场集成：执行数据的实时反馈 (ERP to MES) <a class="header-anchor" href="#_2-mes-iot-现场集成-执行数据的实时反馈-erp-to-mes" aria-label="Permalink to &quot;2. MES/IoT 现场集成：执行数据的实时反馈 (ERP to MES)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“仓库发了多少料、车间做了多少货，全靠月底人工补单，账面库存永远不准”。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>下发指令接口</strong>: <ul><li>开发者需将 ERP 的生产订单（MO）实时下推到 MES。</li><li><strong>逻辑</strong>: <code>On_MO_Release -&gt; Push_to_MES_Queue</code>。</li></ul></li><li><strong>实时报工与倒冲 (Backflush)</strong>: <ul><li>开发者需提供 <code>Production_Report_API</code> 给 MES。</li><li><strong>逻辑</strong>: MES 扫码报工 -&gt; ERP 自动扣减线边库库存（倒冲） -&gt; 自动增加成品库存。</li></ul></li><li><strong>IoT 边缘接入</strong>: <ul><li>对于自动化设备，开发者可设计 <code>Sensor_Data_Gateway</code>，将设备的“心跳”和“产出计数”直接转化为 ERP 的 <code>Equipment_OEE</code> 统计数据。</li></ul></li></ul><h3 id="postgresql-实现建议-1" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-1" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>LISTEN/NOTIFY 即时下发</strong>: MO 审核后，通过 <code>NOTIFY mes_sync_channel, &#39;MO_ID_XYZ&#39;</code> 立即唤醒集成 Worker，实现秒级的订单下发。</li><li><strong>行级锁与库存原子更新</strong>: 在处理 MES 报工倒冲时，使用 <code>UPDATE ... RETURNING</code> 结合 <code>FOR UPDATE</code>，确保库存扣减的原子性与高并发下的准确性。</li><li><strong>时序数据存储 (TimescaleDB 扩展)</strong>: 对于 IoT 设备产生的大量传感器数据，可以集成 <code>TimescaleDB</code> 插件，利用其自动分区和高效压缩特性，实现对设备状态的长周期监控。</li></ul><hr><h2 id="_3-分布式事务、最终一致性与可视化监控-consistency-monitor" tabindex="-1">3. 分布式事务、最终一致性与可视化监控 (Consistency &amp; Monitor) <a class="header-anchor" href="#_3-分布式事务、最终一致性与可视化监控-consistency-monitor" aria-label="Permalink to &quot;3. 分布式事务、最终一致性与可视化监控 (Consistency &amp; Monitor)&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><ul><li><strong>数据失步</strong>: “MES 报工成功，但 ERP 单据未生成”。</li><li><strong>不可见性</strong>: 开发者不知道哪些集成任务失败了，只能查日志，效率极低。</li></ul><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>本地事务表模式 (Transactional Outbox)</strong>: <ul><li>开发者在 ERP 执行业务逻辑时，同步在 <code>Integration_Task</code> 表插入一条记录。</li></ul></li><li><strong>可视化重试机制 (Manual Retry)</strong>: <ul><li>开发者需提供 <code>Integration_Monitor</code> 界面。</li><li><strong>功能</strong>: 展示任务状态（成功/失败/重试中）、错误堆栈、原始报文。</li><li><strong>操作</strong>: 支持“手动重试”或“一键冲销（Compensate）”。</li></ul></li><li><strong>补偿事务 (Saga Pattern)</strong>: 如果重试多次失败，执行反向冲销逻辑。</li></ul><h3 id="postgresql-实现建议-2" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-2" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>SKIP LOCKED 任务抓取</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> integration_task </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Pending&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> next_retry_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SKIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LOCKED </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> integration_task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Processing&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> integration_task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li><li><strong>JSONB 记录任务全貌</strong>: 存储 <code>Request_Payload</code>、<code>Response_Payload</code> 和 <code>Error_Trace</code>。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 手动重试：将状态重置为 Pending 并更新重试时间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> integration_task </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Pending&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, retry_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> retry_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, next_retry_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :task_id;</span></span></code></pre></div></li></ul><hr><h2 id="_4-开发者-checklist" tabindex="-1">4. 开发者 Checklist <a class="header-anchor" href="#_4-开发者-checklist" aria-label="Permalink to &quot;4. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>接口协议</strong>: 建议统一使用 RESTful + JSON，严禁使用过时的 SOAP/XML（除非对方系统强制要求）。</li><li>[ ] <strong>版本控制</strong>: 接口 URL 必须携带版本号（如 <code>/api/v1/mo/create</code>），防止升级破坏旧系统。</li><li>[ ] <strong>限流保护</strong>: 面对 MES 高频的报工请求，开发者需实现 <code>Buffer_Queue</code> 进行削峰填谷。</li><li>[ ] <strong>数据清洗</strong>: 集成接口必须对传入的 <code>Item_Code</code>、<code>Wh_Code</code> 进行合法性强校验。</li><li>[ ] <strong>可视化监控</strong>: 开发者需提供一个 <code>Integration_Monitor</code> 界面，让运维人员能一眼看到哪些集成任务失败了。</li></ul>`,30)])])}const c=i(n,[["render",e]]);export{g as __pageData,c as default};
