# VMI 业务管理 (VMI) - 开发者详尽指南

## 概述
VMI（Vendor Managed Inventory）在采购端体现为**“先用后付”**。开发者必须理解：这不仅是单据的堆叠，更是对**结算时点、结算价格、差异对账**的精密控制。

---

## 1. VMI 协议与规则定义 (VMI Agreement)

### 企业痛点
**“同样的料，有些供应商要求入库 30 天后必须结算，有些是领用就结，开发者如果写死了逻辑，合同就没法执行”**。

### 开发逻辑点
- **多维结算策略 (Settlement Policy)**: 
    - 开发者需在 VMI 协议中设计 `Trigger_Type` 字段。
    - **策略库**: 
        - `Issue`: 生产领料触发结算。
        - `Sale`: 销售出库触发结算。
        - `Aging`: 到货超过 N 天强制结算。
- **价格快照**: 
    - VMI 结算价格是按“到货时”还是“结算时”？
    - **逻辑**: 开发者需支持 `Price_Snapshot_On_Receipt` 和 `Price_On_Settlement` 两种模式的切换。

---

## 2. 自动消耗与补账引擎 (Consumption Engine)

### 企业痛点
“车间领了 5 个螺丝，我得手动去开采购单、入库单、报账单，一天干几百次，要累死人”。

### 开发逻辑点
- **后台补单任务 (Auto-Fulfillment)**: 
    - 开发者需实现一个监听 `WIP_Issue` 事件的处理器。
    - **逻辑流程**: 
        - 1. 检测物料是否为 `Is_VMI`。
        - 2. 自动匹配对应的 `VMI_Agreement`。
        - 3. 自动生成 `虚拟采购入库单`（为了平衡库存账）。
        - 4. 自动生成 `采购结算单`（为了挂 AP 账）。
- **事务一致性**: 
    - 开发者必须确保领料出库与 VMI 补账在一个大的分布式事务中，防止出现“领了料但没挂账”的财务漏洞。

---

## 3. VMI 对账与红字冲销 (Reconciliation)

### 企业痛点
**“退货时麻烦大了，VMI 已经结过账的货要退回供应商，怎么冲账？”**。

### 开发逻辑点
- **红字关联逻辑**: 
    - 开发者需实现 `VMI_Return_Process`。
    - **逻辑**: 退货单必须强关联原 `VMI 结算单`。
    - **自动处理**: 系统自动生成红字采购入库单，并冲减已挂账的 AP 余额。
- **差异调整**: 
    - 开发者需提供 `VMI_Price_Adjustment` 接口，处理由于协议调价导致的已结算差额补差。

---

## 4. 供应商协同看板 (Supplier Portal)

### 企业痛点
“供应商不知道我用了多少货，天天打电话来问”。

### 开发逻辑点
- **消耗透明化**: 
    - 开发者需为供应商门户（Portal）提供 `Consumption_Query_API`。
    - **展示字段**: `PO_No` (协议号), `Receipt_Date`, `Issue_Date`, `Settled_Qty`, `Unsettled_Qty`。
- **自动对账确认**: 
    - 开发者可设计“供应商电子对账”流程。供应商在门户点击确认后，ERP 内部才正式核准结算单。

---

## 5. 开发者 Checklist

- [ ] **税率处理**: 结算时的税率变动（如国家下调增值税）如何处理？
- [ ] **库存隔离**: 库存查询接口是否正确区分了 VMI 库存与自有库存？
- [ ] **财务接口**: AEP 是否为 VMI 业务配置了专门的“暂估”和“应付”科目映射？
- [ ] **反审核拦截**: 已产生的结算单如果已经传给财务系统，是否禁止了原领料单的反审核？
