# 财务基础 (GL/AR/AP) - 开发者详尽指南

## 概述
财务模块是 ERP 的“真值来源”。在开发者眼中，它是一堆借贷分录；但在业务眼中，它是**合规性、资金链和法律风险**。开发者必须确保业务单据（Sub-ledger）与总账（General Ledger）之间的**绝对同步**。

---

## 1. 总账 (GL) 与自动会计平台 (AEP)

### 企业痛点
**“业务审了，财务没数”**。传统的同步写凭证会导致业务单据保存变慢甚至死锁。

### 开发逻辑点
- **AEP 异步机制**: 业务单据审核后，仅产生一条“待入账”任务存入消息表。开发者需实现一个后台 Job，扫描该表并根据 **入账规则 (Posting Rules)** 生成凭证。
- **入账规则引擎**: 
    - 开发者需实现一个配置化的映射逻辑：`业务科目 = 动态因子(物料分类, 客户类别, 业务类型) + 预设科目库`。
    - **强校验**: 如果规则缺失或科目失效，凭证生成必须报错并标记单据为“入账异常”，绝对不能产生空凭证。

---

## 2. 应收 (AR) 与 应付 (AP) 的核销逻辑 (Clearing)

### 企业痛点
**“客户打了一笔 100 万，抵扣了 5 个订单，还有 2 个是部分抵扣”**。核销（Matching/Clearing）是财务最头疼的。

### 开发逻辑点
- **1:N / N:1 核销算法**: 开发者需设计一个中间表 `Clearing_Relation`，记录收付款单与发票之间的多对多关系。
- **余额回写**: 每核销一笔，必须实时更新发票的 `Remaining_Amount`（未核销金额）。
- **核销撤销**: 这是一个重难点。如果财务核销错了要撤销，开发者必须按**核销顺序的逆序**进行回滚，并恢复所有关联单据的状态。

---

## 3. 跨组织往来 (Inter-Company Clearing)

### 企业痛点
**“A 组织发货，B 组织收钱”**。这涉及到法人之间的资金转移，如果代码没处理好，就是漏缴税或违反金融监管。

### 开发逻辑点
- **自动对冲凭证**: 
    - A 组织（发货方）生成：`借：内部往来-B，贷：收入`。
    - B 组织（收款方）生成：`借：银行存款，贷：内部往来-A`。
- **开发注意**: 所有的内部往来单据必须成对出现。开发者需实现一个“对账监控器”，扫描所有 `Inter-Company` 科目，确保借贷双方余额为零。

---

## 4. 汇兑损益 (Foreign Exchange Variance)

### 企业痛点
月初美元汇率 7.1，月末 7.2。账面上的 10 万美元资产无形中“赚了” 1 万人民币。

### 开发逻辑点
- **期末调汇 Job**: 开发者需编写期末批处理逻辑，扫描所有外币余额账户。
- **计算逻辑**: `汇兑损益 = 外币余额 * (月末汇率 - 记账汇率)`。
- **凭证生成**: 自动生成损益凭证，并更新各账户的本币余额，而不改变其外币余额。

---

## 5. 开发者 Checklist

- [ ] **科目有效性**: 在凭证写入前，必须检查科目是否已禁用、是否允许手工过账。
- [ ] **借贷平衡**: 后端必须实现 `Sum(Debit) == Sum(Credit)` 的强校验，哪怕差 0.01 分钱也禁止保存。
- [ ] **期间校验**: 凭证日期所在的会计期间必须是 `Open` 状态。
- [ ] **防篡改**: 凭证一旦“记账（Posted）”，数据库对应的行记录必须设为只读，任何修改操作必须通过“红字冲销”实现。
