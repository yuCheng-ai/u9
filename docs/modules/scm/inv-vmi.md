# VMI 库存与第三方代管 - 开发者详尽指南

## 概述
VMI（Vendor Managed Inventory）和第三方代管库存是“物理位置”与“所有权”分离的典型场景。开发者必须解决的核心逻辑是：**如何在库存表里区分“谁的货”以及“谁来付钱”**。

---

## 1. 供应商寄售逻辑 (Consignment)

### 企业痛点
**“货在我的仓库里，但我不想要它占我的资金，只有我用掉它的时候才给供应商钱”**。

### 开发逻辑点
- **权属标识 (Ownership)**: 
    - 开发者需在库存记录中增加 `Owner_Type` (Supplier/Self) 和 `Owner_ID`。
    - **逻辑**: VMI 入库时，库存增加，但**不产生应付账款 (AP)**。
- **消耗即结算 (Consumption-to-Pay)**: 
    - 当生产领料（MO_Issue）或销售出库（SO_Issue）涉及到 VMI 库存时，开发者需自动触发一个 `VMI_Consumption_Event`。
    - **自动生成单据**: 
        - 1. 自动生成 `VMI 结算单`。
        - 2. 自动生成 `采购入库单`（补记账）。
        - 3. 产生 `应付凭证`。

---

## 2. 外委加工库存 (Subcontracting Stock)

### 企业痛点
“我把原材料发给了供应商加工，但在系统里这批料就‘丢了’，财务还以为料已经没了”。

### 开发逻辑点
- **委外仓建模 (Subcontracting Warehouse)**: 
    - 开发者需为每一个委外商建立一个虚拟的“外部仓库”。
    - **逻辑**: 发料至委外商是 `Transfer` 而不是 `Issue`。
- **库存可见性**: 
    - 在运行 MRP 时，开发者必须将委外仓的库存计入“可用量”，但需标记为 `Outside_Location`。

---

## 3. VMI 库存的盘点与对账 (Reconciliation)

### 企业痛点
**“供应商说我用了 100 个，系统说我只用了 80 个，对不上账”**。

### 开发逻辑点
- **三方对账视图**: 
    - 开发者需构建 `Supplier_Inventory_Snapshot`。
    - **公式**: `期初 + 入库 - 消耗 = 理论结存`。
- **差异处理接口**: 
    - 开发者需提供 `VMI_Inventory_Adjustment` 接口，处理盘点差异。
    - **逻辑**: 盘亏由我方承担（转采购结算），盘盈退回供应商或挂账。

---

## 4. 结算触发机制的配置 (Trigger Strategy)

### 企业痛点
“有些料是领用就结算，有些料是月底统一结，开发者写死了逻辑，业务没法跑”。

### 开发逻辑点
- **策略引擎**: 
    - 开发者需在 `Supplier_Item_Relation` 表中设计 `Settlement_Trigger` 字段：
        - `On_Issue`: 领料即结。
        - `On_Receipt`: 到货即结（转普通采购）。
        - `On_Period_End`: 月底按消耗量汇总结。
- **开发注意**: 所有的 VMI 消耗事务必须具备**可追溯性**，必须能反查到对应的领料单号。

---

## 5. 开发者 Checklist

- [ ] **成本核算**: VMI 消耗时的单价，是按领料时的最新价还是协议价？
- [ ] **多币种**: 供应商是国外的，消耗结算时的汇率如何取值？
- [ ] **库存分配**: 在自动分配库存时，是否优先消耗 VMI 库存（以节省自有资金）？
- [ ] **反审核**: 如果 VMI 消耗已经结算并产生了发票，对应的领料单是否已被锁定禁止反审核？
