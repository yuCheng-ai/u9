import{_ as i,c as s,o as t,ae as e}from"./chunks/framework.CDjunVez.js";const c=JSON.parse('{"title":"阿米巴经营会计 (Amoeba) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/fi/amoeba.md","filePath":"modules/fi/amoeba.md"}'),l={name:"modules/fi/amoeba.md"};function n(o,a,r,h,d,p){return t(),s("div",null,[...a[0]||(a[0]=[e(`<h1 id="阿米巴经营会计-amoeba-开发者详尽指南" tabindex="-1">阿米巴经营会计 (Amoeba) - 开发者详尽指南 <a class="header-anchor" href="#阿米巴经营会计-amoeba-开发者详尽指南" aria-label="Permalink to &quot;阿米巴经营会计 (Amoeba) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>U9 阿米巴经营会计是基于稻盛和夫经营哲学的落地实践。对于开发者而言，阿米巴系统的核心是将业务活动<strong>多维化、颗粒化</strong>。它通过“管理账簿”在法定财务核算之外，并行运行一套独立的经营损益逻辑。</p><p><strong>开发者的核心目标</strong>：确保每一笔业务单据（领料、入库、销售等）都能在正确的时间、以正确的内部价格、映射到正确的阿米巴单元损益中。</p><hr><h2 id="_1-核心模型与技术对象" tabindex="-1">1. 核心模型与技术对象 <a class="header-anchor" href="#_1-核心模型与技术对象" aria-label="Permalink to &quot;1. 核心模型与技术对象&quot;">​</a></h2><h3 id="_1-1-核算单元-amoeba-unit" tabindex="-1">1.1 核算单元 (Amoeba Unit) <a class="header-anchor" href="#_1-1-核算单元-amoeba-unit" aria-label="Permalink to &quot;1.1 核算单元 (Amoeba Unit)&quot;">​</a></h3><p>在系统底层，阿米巴单元并不是一个简单的“部门”字段，而是一个<strong>多维映射实体</strong>。</p><ul><li><strong>映射关系</strong>: 开发者需要关注 <code>AmoebaOrg</code> 与 <code>BaseOrg</code> (法人组织)、<code>Department</code> (部门)、<code>WorkCenter</code> (工作中心) 的映射表。</li><li><strong>属性</strong>: <ul><li><code>Type</code>: 制造型（利润中心）、销售型（利润中心）、职能型（费用/服务中心）。</li><li><code>Level</code>: 支持树状递归查询，用于损益逐级汇总。</li></ul></li></ul><h3 id="postgresql-实现建议" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>LTREE 层次结构</strong>: 使用 <code>LTREE</code> 扩展来存储阿米巴组织树。这使得查询“某单元及其所有下级”或“某单元的所有上级”变得极其高效且语法简洁。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查询 A 单元及其所有子单元的损益汇总</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(amount) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> amoeba_trading </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Group.Factory1.ShopA&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li><li><strong>JSONB 属性扩展</strong>: 阿米巴单元通常有许多自定义的考核指标。使用 <code>JSONB</code> 存储这些非核心属性，既能保证灵活性，又可以通过 <code>GIN</code> 索引保持高性能检索。</li></ul><h3 id="_1-2-内部交易记录-internal-trading-record" tabindex="-1">1.2 内部交易记录 (Internal Trading Record) <a class="header-anchor" href="#_1-2-内部交易记录-internal-trading-record" aria-label="Permalink to &quot;1.2 内部交易记录 (Internal Trading Record)&quot;">​</a></h3><p>这是阿米巴核算的“灵魂”。每当货物或服务在两个单元间流转，系统需生成一条内部交易记录。</p><ul><li><strong>触发源</strong>: <ul><li>调拨单 (Transfer Order)</li><li>完工入库单 (Production Completion)</li><li>跨部门领料 (Internal Requisition)</li></ul></li><li><strong>核心字段</strong>: <code>Sender_Amoeba</code>, <code>Receiver_Amoeba</code>, <code>Price_Policy_ID</code>, <code>Quantity</code>, <code>Amount</code>.</li></ul><h3 id="postgresql-实现建议-1" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-1" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>分区表 (Partitioning)</strong>: 内部交易记录数据量巨大。建议按月对 <code>amoeba_trading</code> 表进行分区，提高历史数据清理效率和月度结算查询速度。</li><li><strong>物化视图 (Materialized View)</strong>: 对于实时性要求不高但计算复杂的阿米巴损益看板，使用物化视图缓存结果，并在业务低峰期刷新。</li></ul><hr><h2 id="_2-内部定价逻辑-price-determination" tabindex="-1">2. 内部定价逻辑 (Price Determination) <a class="header-anchor" href="#_2-内部定价逻辑-price-determination" aria-label="Permalink to &quot;2. 内部定价逻辑 (Price Determination)&quot;">​</a></h2><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ol><li><strong>协议定价 (Contract Price)</strong>: 检查两个特定阿米巴单元之间是否存在生效的协议价格表。</li><li><strong>标准/市场价 (Standard Price)</strong>: 若无协议价，查找物料主文件或价格库中的“内部参考价”。</li><li><strong>成本加成 (Cost Plus)</strong>: <ul><li><code>公式: 内部结算价 = 实际成本 * (1 + 利润率)</code></li><li>开发者需实时计算前序工序的累积成本。</li></ul></li><li><strong>手动调整 (Manual Adjustment)</strong>: 允许在特定权限下对系统计算的价格进行干预，并记录审计日志。</li></ol><h3 id="postgresql-实现建议-2" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-2" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>时间范围约束 (DATERANGE)</strong>: 价格表使用 <code>daterange</code> 字段配合 <code>GIST</code> 索引的 <code>EXCLUDE</code> 约束，确保任意两个单元间的同一种物料在同一时间内只有一个生效价格。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> internal_price_list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXCLUDE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gist (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  amoeba_pair_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  valid_period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li><li><strong>自定义函数逻辑控制</strong>: 将复杂的定价优先级逻辑（从协议价到成本加成）封装在 <code>PL/pgSQL</code> 函数中，确保在批量生成交易记录时，逻辑的一致性与高性能。</li></ul><hr><h2 id="_3-核心算法与损益计算" tabindex="-1">3. 核心算法与损益计算 <a class="header-anchor" href="#_3-核心算法与损益计算" aria-label="Permalink to &quot;3. 核心算法与损益计算&quot;">​</a></h2><h3 id="_3-1-损益计算公式-p-l-formula" tabindex="-1">3.1 损益计算公式 (P&amp;L Formula) <a class="header-anchor" href="#_3-1-损益计算公式-p-l-formula" aria-label="Permalink to &quot;3.1 损益计算公式 (P&amp;L Formula)&quot;">​</a></h3><p>阿米巴的损益不是简单的“收入 - 成本”，其核心是**“经营利润”**。</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>经营利润 = 内部交易收入 + 外部销售收入 </span></span>
<span class="line"><span>          - 内部交易成本 (买入) </span></span>
<span class="line"><span>          - 直接费用 (差旅、辅料等) </span></span>
<span class="line"><span>          - 共享费用分摊 (房租、折旧等)</span></span></code></pre></div><h3 id="_3-2-费用分摊算法-allocation-logic" tabindex="-1">3.2 费用分摊算法 (Allocation Logic) <a class="header-anchor" href="#_3-2-费用分摊算法-allocation-logic" aria-label="Permalink to &quot;3.2 费用分摊算法 (Allocation Logic)&quot;">​</a></h3><p>开发者需支持以下分摊引擎：</p><ul><li><strong>静态权重</strong>: 按固定比例分摊（如：行政费按各单元人数占比）。</li><li><strong>动态驱动</strong>: <ul><li>按面积分摊（房租）。</li><li>按机器工时分摊（折旧）。</li><li>按收入占比分摊（集团管理费）。</li></ul></li><li><strong>递归分摊</strong>: 职能部门 A 分摊给职能部门 B，再由 B 分摊给业务部门。系统需防止死循环。</li></ul><h3 id="postgresql-实现建议-3" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-3" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>递归 CTE 分摊</strong>: 使用 <code>WITH RECURSIVE</code> 处理多级费用分摊。在 SQL 层直接完成分摊链条的展开，避免在应用层进行多次循环查询。</li><li><strong>窗口函数计算占比</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> amoeba_id, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (headcount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(headcount) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OVER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allocated_amount</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expenses;</span></span></code></pre></div>利用窗口函数一次性完成分母汇总与分子分摊，性能远优于子查询。</li></ul><h3 id="_3-3-单位时间核算-hourly-value" tabindex="-1">3.3 单位时间核算 (Hourly Value) <a class="header-anchor" href="#_3-3-单位时间核算-hourly-value" aria-label="Permalink to &quot;3.3 单位时间核算 (Hourly Value)&quot;">​</a></h3><p>这是衡量阿米巴效率的终极指标。</p><ul><li><code>公式: 单位时间附加值 = (经营利润 +劳务费) / 总劳动时间</code></li></ul><h3 id="postgresql-实现建议-4" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-4" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>跨库查询 (postgres_fdw)</strong>: 如果 HR/考勤系统在独立的数据库中，利用 <code>postgres_fdw</code> 将考勤数据映射为本地表，直接在阿米巴计算 SQL 中关联，无需繁琐的 ETL 过程。</li></ul><hr><h2 id="_4-系统集成与-aep-映射" tabindex="-1">4. 系统集成与 AEP 映射 <a class="header-anchor" href="#_4-系统集成与-aep-映射" aria-label="Permalink to &quot;4. 系统集成与 AEP 映射&quot;">​</a></h2><p>阿米巴数据不是独立录入的，而是通过 <strong>自动会计平台 (AEP)</strong> 从业务流中“截流”出来的。</p><ol><li><strong>业务触发</strong>: 仓储人员审核《领料单》。</li><li><strong>AEP 路由</strong>: <ul><li><strong>路由 A</strong>：映射至法定账簿（CAS），生成：<code>借：生产成本，贷：原材料</code>。</li><li><strong>路由 B</strong>：映射至阿米巴账簿，生成：<code>借：A阿米巴-材料费，贷：B阿米巴-内部收入</code>。</li></ul></li><li><strong>多账簿隔离</strong>: 确保阿米巴的内部结算不影响法定财务报表的利润。</li></ol><hr><h2 id="_5-开发者-checklist-必读" tabindex="-1">5. 开发者 checklist (必读) <a class="header-anchor" href="#_5-开发者-checklist-必读" aria-label="Permalink to &quot;5. 开发者 checklist (必读)&quot;">​</a></h2><ul><li>[ ] <strong>性能优化</strong>: 内部交易触发频率极高，必须采用异步处理或批量计算模式，避免阻塞业务单据过账。</li><li>[ ] <strong>数据回溯</strong>: 当内部价格在月中调整时，系统必须提供“重算”功能，追溯调整已生成的损益记录。</li><li>[ ] <strong>颗粒度控制</strong>: 系统应支持从损益表的“材料费”一键穿透到最底层的“出库单”明细。</li><li>[ ] <strong>异常处理</strong>: 当定价规则缺失时，应有默认处理逻辑（如记录异常、推送到审批流），而非直接报错阻断业务。</li></ul><hr><h2 id="_6-常见业务场景-logic-walkthrough" tabindex="-1">6. 常见业务场景 (Logic Walkthrough) <a class="header-anchor" href="#_6-常见业务场景-logic-walkthrough" aria-label="Permalink to &quot;6. 常见业务场景 (Logic Walkthrough)&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">业务动作</th><th style="text-align:left;">阿米巴逻辑处理</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>内部买卖</strong></td><td style="text-align:left;">车间 A 生产出半成品给车间 B</td><td style="text-align:left;">减少 A 库存，增加 A 内部收入；增加 B 内部成本。</td></tr><tr><td style="text-align:left;"><strong>公共分摊</strong></td><td style="text-align:left;">集团支付了 100 万电费</td><td style="text-align:left;">根据各阿米巴单元上报的用电读数，按比例扣减各单元利润。</td></tr><tr><td style="text-align:left;"><strong>借调人力</strong></td><td style="text-align:left;">销售部借用 IT 部开发一个小工具</td><td style="text-align:left;">销售部记录一笔“服务支出”，IT 部记录一笔“内部劳务收入”。</td></tr></tbody></table><hr><h2 id="_7-相关参考文档" tabindex="-1">7. 相关参考文档 <a class="header-anchor" href="#_7-相关参考文档" aria-label="Permalink to &quot;7. 相关参考文档&quot;">​</a></h2><ul><li>[多账簿体系 (Multi-Book)](file:///Users/dingshaoxiong/yuCheng-ai/u9/docs/modules/fi/multi-book.md)</li><li>[自动会计平台 (AEP) 配置指南](file:///Users/dingshaoxiong/yuCheng-ai/u9/docs/platform/aep.md)</li></ul>`,50)])])}const k=i(l,[["render",n]]);export{c as __pageData,k as default};
