import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"料品主数据 (Item Master) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/cbo/item-master.md","filePath":"modules/cbo/item-master.md"}'),l={name:"modules/cbo/item-master.md"};function e(h,s,r,o,k,p){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="料品主数据-item-master-开发者详尽指南" tabindex="-1">料品主数据 (Item Master) - 开发者详尽指南 <a class="header-anchor" href="#料品主数据-item-master-开发者详尽指南" aria-label="Permalink to &quot;料品主数据 (Item Master) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>料品（Item）是 ERP 系统的“细胞”。在多组织、多工厂环境下，料品不仅包含基础物理属性，还承载了复杂的<strong>计划参数</strong>、<strong>计量规则</strong>和<strong>追溯要求</strong>。开发者必须利用数据库的<strong>全文检索</strong>、<strong>高精度计算</strong>和<strong>文档型存储</strong>特性，确保料品数据的灵活性与严谨性。</p><hr><h2 id="_1-料品检索与多语言主数据-search-multi-language" tabindex="-1">1. 料品检索与多语言主数据 (Search &amp; Multi-language) <a class="header-anchor" href="#_1-料品检索与多语言主数据-search-multi-language" aria-label="Permalink to &quot;1. 料品检索与多语言主数据 (Search &amp; Multi-language)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>制造企业中常有“一物多名”现象，且全球化企业要求料品名称、规格在不同语种（中文、英文、日文）下均有对应存储。开发者需要提供极速检索及多语种动态切换能力。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>多语言存储模型</strong>: 弃用“多列模式”（name_en, name_zh），推荐采用<strong>中间表模式</strong>或 <strong>JSONB 模式</strong>。 <ul><li><strong>中间表模式</strong>: <code>item_master_lang</code> 表存储 <code>item_id</code>, <code>lang_code</code>, <code>field_name</code>, <code>field_value</code>。适合字段极多且需频繁扩展语种的场景。</li><li><strong>JSONB 模式</strong>: 在 <code>item_master</code> 中定义 <code>name_i18n</code> (JSONB) 字段，存储 <code>{&quot;zh&quot;: &quot;钢板&quot;, &quot;en&quot;: &quot;Steel Plate&quot;}</code>。</li></ul></li><li><strong>高性能模糊检索</strong>: <ul><li>针对 <code>JSONB</code> 中的多语种字段，推荐使用 PostgreSQL 的 <strong>GIN 索引</strong> 配合 <code>jsonb_path_ops</code>。</li><li>配合 <code>trgm</code> (trigram) 模块，实现对 JSON 内部文本的高性能模糊匹配。</li></ul></li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用 JSONB 存储多语言名称</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name_i18n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;en&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建索引优化多语言模糊搜索</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_item_name_i18n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gin (name_i18n);</span></span></code></pre></div></li></ul><hr><h2 id="_2-计量单位与变动换算率-uom-variable-conversion" tabindex="-1">2. 计量单位与变动换算率 (UOM &amp; Variable Conversion) <a class="header-anchor" href="#_2-计量单位与变动换算率-uom-variable-conversion" aria-label="Permalink to &quot;2. 计量单位与变动换算率 (UOM &amp; Variable Conversion)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><ul><li><strong>固定换算</strong>: 1 盒 = 10 支（文具行业）。</li><li><strong>变动换算 (Variable Conversion)</strong>: 针对农产品或化工行业，存在“非固定比例双单位换算”。例如：入库时按“件”，出库时按“重量”，但每件的重量由于水分挥发或个体差异并不固定。</li></ul><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>双单位强校验</strong>: 针对设置了“变动换算”的料品，单据录入时必须强制用户同时输入两个单位的数量。</li><li><strong>换算率动态计算</strong>: <code>Rate = Qty1 / Qty2</code>。系统需记录每笔业务发生时的“实际换算率”，而非仅使用主档的“标准换算率”。</li><li><strong>技术实现建议</strong>: <ul><li>换算率必须定义为 <code>numeric(24, 12)</code>。</li><li><strong>库存余额</strong>: <code>inv_onhand</code> 必须同时存储 <code>Qty</code> (主单位) 和 <code>SecondQty</code> (辅助单位)，防止因换算率波动导致的“账实不符”。</li></ul></li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 每一行明细需存储交易时的实际换算率</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_trans_line </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN actual_conversion_rate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">numeric</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">24</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul><hr><h2 id="_3-属性扩展-eav-与-jsonb-的取舍" tabindex="-1">3. 属性扩展：EAV 与 JSONB 的取舍 <a class="header-anchor" href="#_3-属性扩展-eav-与-jsonb-的取舍" aria-label="Permalink to &quot;3. 属性扩展：EAV 与 JSONB 的取舍&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>不同行业的料品属性差异极大。服装行业需要颜色/尺码，化工行业需要纯度/粘度，电子行业需要封装/版本。</p><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>核心属性静态化</strong>: 编码、名称、单位等通用属性应作为表字段。</li><li><strong>行业属性动态化</strong>: 针对行业特有属性，避免频繁修改物理表结构。</li><li><strong>技术实现建议</strong>: <ul><li>弃用性能低下的 EAV 模式（属性-值表），全面转向 <strong>JSONB</strong> 存储扩展属性。</li><li><strong>约束增强</strong>: 利用 PostgreSQL 的 <strong>JSON Schema 校验</strong> 或触发器，确保存入 <code>JSONB</code> 的属性符合行业定义的规范。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用 JSONB 存储行业属性并配置 GIN 索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_item_props</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gin (industry_props);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查询红色且尺码为 XL 的料品</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> industry_props @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;color&quot;: &quot;Red&quot;, &quot;size&quot;: &quot;XL&quot;}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_4-追溯控制-批次与序列号-lot-sn" tabindex="-1">4. 追溯控制：批次与序列号 (Lot &amp; SN) <a class="header-anchor" href="#_4-追溯控制-批次与序列号-lot-sn" aria-label="Permalink to &quot;4. 追溯控制：批次与序列号 (Lot &amp; SN)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>医药、汽车行业要求全生命周期追溯。必须能从一张成品单据穿透到其所有原材料的供应商批次。</p><h3 id="开发规范-2" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-2" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>强控开关</strong>: 料品主档应设置 <code>IsLotControl</code> (批次控制) 和 <code>IsSNControl</code> (序列号控制) 开关。</li><li><strong>先进先出</strong>: 建议库位时应自动匹配最早入库的批次。</li><li><strong>技术实现建议</strong>: <ul><li>批次属性（生产日期、失效日期、质检状态）推荐存储在 <code>JSONB</code> 中。</li><li>利用 PostgreSQL 的 <strong>Recursive CTE (递归公用表表达式)</strong> 实现 BOM 级的追溯查询，快速反查某一有问题原材料影响的所有成品订单。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 递归追溯批次来源</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_trace </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_id, parent_lot_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_genealogy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :target_lot</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lot_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_lot_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_genealogy g</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_trace lt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lot_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_lot_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lot_trace;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>高效检索</strong>: 料品搜索字段（名称、规格）是否配置了 <code>gin_trgm_ops</code> 索引？</li><li>[ ] <strong>精度对齐</strong>: 换算率和单位数量字段是否统一使用 <code>numeric</code> 类型？</li><li>[ ] <strong>动态属性</strong>: 行业扩展属性是否采用了 <code>JSONB</code> 存储，并配置了 GIN 索引以支持属性过滤？</li><li>[ ] <strong>状态校验</strong>: 在单据 Service 层，是否强校验了料品的状态（如：禁止在“停用”状态下录入采购单）？</li><li>[ ] <strong>级联删除</strong>: 料品停用/删除前，是否利用数据库函数快速检查了在途单据（SO/PO/MO）的引用？</li></ul>`,30)])])}const c=i(l,[["render",e]]);export{g as __pageData,c as default};
