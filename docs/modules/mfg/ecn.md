# ECN 工程变更 (ECN) - 开发者详尽指南

## 概述
工程变更（ECN/ECR）是制造企业的“手术刀”。开发者必须意识到：ECN 不只是修改一张表，它是一系列**连锁反应的触发器**。如果逻辑不严密，会导致生产线领错料、库存呆滞或成品报废。

---

## 1. 变更范围与冲突检测 (Impact Analysis)

### 企业痛点
**“改了一个螺丝，结果 100 个订单都要重算”**。开发者如果不能自动识别受影响的范围，用户就得一个一个手动改。

### 开发逻辑点
- **受影响范围扫描**: 
    - 开发者需实现一个“反查引擎”。
    - **PG 实现建议**: 利用 PostgreSQL 的 **递归 CTE (Recursive CTE)** 实现对多层 BOM 的极速反查，快速定位受影响的顶层产成品。
- **冲突检测**: 
    - 系统必须报警日期冲突。
    - **PG 实现建议**: 使用 **`daterange`** 类型存储 ECN 的生效区间，并利用 **`EXCLUDE` 约束** 防止同一 BOM 在同一时间内存在多个冲突的生效版本。

---

## 2. 在制品 (WIP) 的处理策略 (WIP Handling)

### 企业痛点
变更发生时，生产线上还有 50 个半成品。是拆掉重装？还是继续做完？

### 开发逻辑点
- **策略配置**: ECN 必须包含 `WIP_Policy` 字段。
- **自动改单引擎**: 
    - 开发者需编写批处理逻辑。
    - **PG 实现建议**: 使用 **窗口函数 (Window Functions)** 批量对比 MO 现有备料与新 BOM 的差异，并利用 **`INSERT ... ON CONFLICT`** 机制高效更新 MO 的物料需求明细。

---

## 3. 版本断点控制 (Break-point Control)

### 企业痛点
**“我要知道从哪个序列号开始是新版本”**。

### 开发逻辑点
- **断点标记**: 开发者需记录变更发生的 `MOID` 或 `LotNumber`。
- **质量追溯集成**: 
    - 开发者需支持基于 ECN 的过滤。
    - **PG 实现建议**: 使用 **LTREE** 插件存储物料的变更血缘树，实现从产成品批次到 ECN 变更点的秒级路径溯源。

---

## 4. ECN 的事务一致性

### 企业痛点
变更审批通过了，但 BOM 没更新成功，或者只更新了一部分。

### 开发逻辑点
- **原子化执行**: ECN 的生效操作必须包裹在一个数据库事务中。
- **快照保存**: 
    - 开发者必须保存变更前的 BOM 快照。
    - **PG 实现建议**: 利用 PostgreSQL 的 **JSONB** 格式保存 BOM 快照，既能保留完整的树状结构，又方便进行版本间的差异比对（`JSONB_DIFF`）。

---

## 5. 开发者 Checklist

- [ ] **高并发锁定**: 在 ECN 执行期间，是否使用了 **咨询锁 (Advisory Locks)** 锁定相关 BOM，防止并行的 MRP 任务读到中间状态数据？
- [ ] **多租户隔离**: 是否通过 **RLS** 确保不同工厂的 ECN 记录相互独立？
- [ ] **通知引擎**: 是否利用 **`NOTIFY / LISTEN`** 机制异步触发采购和仓库的预警信号？
- [ ] **多级审核**: 复杂的变更是否支持多级流转？
