# VMI 库存与第三方代管 - 开发者详尽指南

## 概述
VMI（Vendor Managed Inventory）和第三方代管库存是“物理位置”与“所有权”分离的典型场景。开发者必须解决的核心逻辑是：**如何在库存表里区分“谁的货”以及“谁来付钱”**。

---

## 1. 供应商寄售逻辑 (Consignment)

### 企业痛点
**“货在我的仓库里，但我不想要它占我的资金，只有我用掉它的时候才给供应商钱”**。

### 开发逻辑点
- **权属标识 (Ownership)**: 
    - 开发者需在库存记录中增加 `Owner_Type` (Supplier/Self) 和 `Owner_ID`。
    - **PG 实现建议**: 使用 **复合主键** 或 **GIN 索引** 优化基于 `owner_id` 的库存检索性能。
- **消耗即结算 (Consumption-to-Pay)**: 
    - 当生产领料或销售出库涉及到 VMI 库存时，开发者需自动触发结算。
    - **PG 实现建议**: 利用 PostgreSQL 的 **触发器 (Triggers)** 或 **逻辑解码 (Logical Decoding)** 捕获库存消耗事件，异步生成下游的结算单据，确保主交易流程的极速响应。

---

## 2. 外委加工库存 (Subcontracting Stock)

### 企业痛点
“我把原材料发给了供应商加工，但在系统里这批料就‘丢了’，财务还以为料已经没了”。

### 开发逻辑点
- **委外仓建模 (Subcontracting Warehouse)**: 
    - 开发者需为每一个委外商建立一个虚拟的“外部仓库”。
    - **PG 实现建议**: 使用 **继承表 (Table Inheritance)** 或 **分区表 (Partitioning)** 来隔离自有仓与委外仓数据，既能保持查询的一致性，又能在物理上分开维护。
- **库存可见性**: 
    - 在运行 MRP 时，开发者必须将委外仓的库存计入“可用量”。
    - **PG 实现建议**: 利用 **物化视图 (Materialized Views)** 预汇总各委外商的库存水位，减少 MRP 计算时的聚合压力。

---

## 3. VMI 库存的盘点与对账 (Reconciliation)

### 企业痛点
**“供应商说我用了 100 个，系统说我只用了 80 个，对不上账”**。

### 开发逻辑点
- **三方对账视图**: 
    - 开发者需构建 `Supplier_Inventory_Snapshot`。
    - **PG 实现建议**: 利用 PostgreSQL 的 **窗口函数 (Window Functions)** 计算“移动加权平均”消耗量，并与供应商提供的 Excel 报表（通过 `file_fdw` 挂载为外部表）进行直接 SQL 比对。
- **差异处理接口**: 
    - 开发者需提供 `VMI_Inventory_Adjustment` 接口。
    - **PG 实现建议**: 使用 **JSONB** 记录每一笔对账差异的原因及协商过程，避免频繁修改核心业务表结构。

---

## 4. 结算触发机制的配置 (Trigger Strategy)

### 企业痛点
“有些料是领用就结算，有些料是月底统一结，开发者写死了逻辑，业务没法跑”。

### 开发逻辑点
- **策略引擎**: 
    - 开发者需在 `Supplier_Item_Relation` 表中设计结算触发字段。
    - **PG 实现建议**: 使用 **ENUM 数组** 或 **JSONB** 存储复杂的结算策略组合（如：金额超过 X 且日期在 Y 之后触发）。
- **开发注意**: 所有的 VMI 消耗事务必须具备**可追溯性**。
    - **PG 实现建议**: 利用 PostgreSQL 的 **`UUID`** 作为全局唯一的消耗事件 ID，并在所有关联单据中建立索引，确保秒级反查。

---

## 5. 开发者 Checklist

- [ ] **高精度计算**: 结算金额计算是否使用了 **`numeric`** 类型？
- [ ] **数据隔离**: VMI 仓库数据是否通过 **RLS** 进行了严格的供应商访问限制（如果支持供应商协同门户）？
- [ ] **库存分配**: 在自动分配库存时，是否优先消耗 VMI 库存？
- [ ] **反审核**: 如果 VMI 消耗已经结算，对应的领料单是否已被锁定禁止反审核？
