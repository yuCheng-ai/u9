import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"调拨与形态转换 (Inventory Ops) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/inv-ops.md","filePath":"modules/scm/inv-ops.md"}'),l={name:"modules/scm/inv-ops.md"};function h(e,s,r,k,p,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="调拨与形态转换-inventory-ops-开发者详尽指南" tabindex="-1">调拨与形态转换 (Inventory Ops) - 开发者详尽指南 <a class="header-anchor" href="#调拨与形态转换-inventory-ops-开发者详尽指南" aria-label="Permalink to &quot;调拨与形态转换 (Inventory Ops) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>库存移动不只是位置的变化，更是<strong>资产权属与价值形态</strong>的流转。开发者必须理解：每一次 <code>Move</code> 都可能触发财务过账、税路切换、甚至组织间的结算。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>跨组织“黑洞”</strong>：总公司发了货，分公司没收到，中间状态没人管。</td><td style="text-align:left;"><strong>在途库存（In-Transit）模型</strong>：发货即减发货方库存，增“在途虚拟仓”，收货后再转正式仓。</td></tr><tr><td style="text-align:left;"><strong>形态转换成本乱</strong>：1 吨原材料拆成 3 种成品，成本只会平均摊，导致高毛利低毛利假象。</td><td style="text-align:left;"><strong>多维价值分摊引擎</strong>：支持按重量、体积、甚至市场价值（Sales Value）比例自动分摊投入成本。</td></tr><tr><td style="text-align:left;"><strong>PDA 扫码卡顿</strong>：仓库作业高峰期，扫码过账事务太重，PDA 经常超时。</td><td style="text-align:left;"><strong>异步过账队列</strong>：PDA 接口只做“数据暂存 + 幂等校验”，后端通过 <code>LISTEN/NOTIFY</code> 异步执行扣减库存事务。</td></tr><tr><td style="text-align:left;"><strong>追溯断层</strong>：转换后的新批次找不到老批次的影子。</td><td style="text-align:left;"><strong>批次血缘链条</strong>：在库存交易明细中记录 <code>Parent_Batch_ID</code>，并使用递归 CTE 实现全链路追溯。</td></tr></tbody></table><hr><h2 id="_1-跨组织调拨逻辑-inter-org-transfer" tabindex="-1">1. 跨组织调拨逻辑 (Inter-Org Transfer) <a class="header-anchor" href="#_1-跨组织调拨逻辑-inter-org-transfer" aria-label="Permalink to &quot;1. 跨组织调拨逻辑 (Inter-Org Transfer)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>总公司调拨给子公司，涉及两个法律实体的账务切换。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>两阶段事务 (Two-Step)</strong>: <ol><li><strong>Step 1 (Ship)</strong>: 发货组织扣库存，借：在途物资，贷：库存商品。</li><li><strong>Step 2 (Receive)</strong>: 接收组织增库存，借：库存商品，贷：应付账款（内部往来）。</li></ol></li><li><strong>内部结算</strong>: 必须从 <code>Inter_Company_Price_List</code> 自动带出结算单价。</li></ul><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>在途管理</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 调拨发货时，将库存转移到“虚拟在途仓”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_stock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bin_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :transit_bin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> batch_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id;</span></span></code></pre></div></li></ul><hr><h2 id="_2-形态转换与价值分摊-transformation-value-allocation" tabindex="-1">2. 形态转换与价值分摊 (Transformation &amp; Value Allocation) <a class="header-anchor" href="#_2-形态转换与价值分摊-transformation-value-allocation" aria-label="Permalink to &quot;2. 形态转换与价值分摊 (Transformation &amp; Value Allocation)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“一堆原材料加工成了边角料，或者 A 等品降级成了 B 等品”。</p><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>价值分摊模型</strong>: <ul><li><strong>按市值分摊</strong>: 适用于食品、电子行业（CPU 降级）。</li></ul></li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 按市场价值比例计算分摊成本</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_market_value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> market_price) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_val </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trans_output_lines </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :trans_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trans_output_lines </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allocated_cost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (:total_input_cost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> market_price) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tmv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">total_val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_market_value tmv</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :trans_id;</span></span></code></pre></div></li></ul><hr><h2 id="_3-批次血缘与质量追溯-batch-lineage" tabindex="-1">3. 批次血缘与质量追溯 (Batch Lineage) <a class="header-anchor" href="#_3-批次血缘与质量追溯-batch-lineage" aria-label="Permalink to &quot;3. 批次血缘与质量追溯 (Batch Lineage)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>发现一批成品质量有问题，需要立刻查出它们是由哪些原材料批次转换而来的。</p><h3 id="技术实现建议-2" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-2" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>递归血缘查询</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 向上追溯源头批次</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lineage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_batch_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_batch_trans </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> child_batch_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :target_batch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_batch_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inv_batch_trans bt </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lineage l </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">child_batch_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> l</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_batch_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lineage;</span></span></code></pre></div></li></ul><hr><h2 id="_4-条码与-pda-异步处理-barcode-integration" tabindex="-1">4. 条码与 PDA 异步处理 (Barcode Integration) <a class="header-anchor" href="#_4-条码与-pda-异步处理-barcode-integration" aria-label="Permalink to &quot;4. 条码与 PDA 异步处理 (Barcode Integration)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>仓库现场作业要求毫秒级响应，不能等待繁重的 ERP 财务过账。</p><h3 id="开发逻辑" tabindex="-1">开发逻辑 <a class="header-anchor" href="#开发逻辑" aria-label="Permalink to &quot;开发逻辑&quot;">​</a></h3><ul><li><strong>前端暂存</strong>: PDA 扫描后将数据写入 <code>stg_scan_log</code>。</li><li><strong>后台异步</strong>: 启用后台进程轮询或监听信号，逐单执行库存扣减。</li></ul><h3 id="技术实现建议-3" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-3" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>LISTEN/NOTIFY</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 数据库端信号触发</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TRIGGER</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> trg_pda_scan</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AFTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INSERT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stg_scan_log</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EACH </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ROW</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXECUTE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notify_inventory_process();</span></span></code></pre></div></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>精度控制</strong>: 价值分摊计算是否使用了 <code>numeric(38, 12)</code> 且保证了分摊后的 <code>Sum(Allocated_Cost) == Total_Input_Cost</code>？</li><li>[ ] <strong>反审核拦截</strong>: 形态转换单对应的输出批次若已发生后续交易（如已销售），是否禁止了该转换单的反审核？</li><li>[ ] <strong>库存锁定</strong>: 调拨出库时是否正确处理了 <code>Reserved_Qty</code>（预留数量）的扣减？</li><li>[ ] <strong>多币种</strong>: 跨组织调拨是否处理了两个组织的本位币汇率转换？</li><li>[ ] <strong>幂等性</strong>: PDA 接口是否通过 <code>Device_ID + Scan_Timestamp</code> 实现了幂等，防止重复过账？</li></ul>`,37)])])}const E=i(l,[["render",h]]);export{g as __pageData,E as default};
