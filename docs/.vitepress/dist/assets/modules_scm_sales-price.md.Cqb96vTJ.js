import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"销售价格体系 - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/scm/sales-price.md","filePath":"modules/scm/sales-price.md"}'),l={name:"modules/scm/sales-price.md"};function e(h,s,k,r,p,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="销售价格体系-开发者详尽指南" tabindex="-1">销售价格体系 - 开发者详尽指南 <a class="header-anchor" href="#销售价格体系-开发者详尽指南" aria-label="Permalink to &quot;销售价格体系 - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>销售价格是企业的“盈利边界”。开发者必须理解：销售价格模型是一个<strong>多因子复合逻辑</strong>。它不是从数据库取一个 <code>Price</code> 字段那么简单，而是通过一系列<strong>路由规则、优先级、阶梯算法、以及折扣叠加</strong>最终计算出的结果。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>价格记忆混乱</strong>：同一个客户，销售员录入的价格每次都不一样，缺乏基准。</td><td style="text-align:left;"><strong>瀑布式取价引擎 (Waterfall Engine)</strong>：实现一套基于优先级（客户特价 &gt; 客户等级价 &gt; 全局标准价）的自动寻价逻辑，利用 <code>UNION ALL</code> + <code>LIMIT 1</code> 确保性能。</td></tr><tr><td style="text-align:left;"><strong>量大从优难以落地</strong>：阶梯价计算复杂，录单员手动算容易出错。</td><td style="text-align:left;"><strong>Range 区间匹配</strong>：利用 PostgreSQL 的 <code>numrange</code> 实现阶梯区间的秒级检索，避免繁琐的 <code>IF-ELSE</code> 逻辑。</td></tr><tr><td style="text-align:left;"><strong>折扣“罗生门”</strong>：多种促销折扣叠加（满减、折上折），财务核算困难。</td><td style="text-align:left;"><strong>折扣栈 (Discount Stack)</strong>：定义严格的计算序列（减法 -&gt; 比例 -&gt; 取整），并利用 JSONB 记录完整的“折扣分摊足迹”。</td></tr><tr><td style="text-align:left;"><strong>亏本卖货风险</strong>：销售为保单随意降价，缺乏底线拦截。</td><td style="text-align:left;"><strong>最低限价硬拦截</strong>：在单据 <code>BeforeSave</code> 钩子中，强制校验 <code>ActualPrice &lt; Cost * (1 + MinMargin)</code>，非授权禁止通过。</td></tr></tbody></table><hr><h2 id="_1-取价引擎算法-waterfall-search" tabindex="-1">1. 取价引擎算法 (Waterfall Search) <a class="header-anchor" href="#_1-取价引擎算法-waterfall-search" aria-label="Permalink to &quot;1. 取价引擎算法 (Waterfall Search)&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>系统需根据“客户、料品、数量、日期、币种”自动从成千上万条价格记录中找到那唯一正确的价格。</p><h3 id="开发逻辑-优先级匹配" tabindex="-1">开发逻辑：优先级匹配 <a class="header-anchor" href="#开发逻辑-优先级匹配" aria-label="Permalink to &quot;开发逻辑：优先级匹配&quot;">​</a></h3><p>开发者需实现一个寻价链条，优先级由高到低：</p><ol><li><strong>特价协议</strong>: <code>Customer_ID + Item_ID</code> 唯一匹配。</li><li><strong>客户等级价</strong>: <code>Customer_Grade + Item_ID</code> 匹配。</li><li><strong>全局基准价</strong>: <code>Item_ID</code> 匹配。</li></ol><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>GIST 索引</strong>: 对于包含有效期的价格表，务必对 <code>(item_id, validity_period)</code> 建立 GIST 索引。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 高效取价逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> price_candidates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 优先级 10：客户特价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unit_price, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> priority FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sal_price_special </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> customer_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :cust </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> validity @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :order_date</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 优先级 20：等级价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unit_price, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> priority FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sal_price_grade </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> grade_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :grade </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> validity @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :order_date</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 优先级 30：基准价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unit_price, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> priority FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sal_price_standard </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> validity @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :order_date</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unit_price </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> price_candidates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> priority ASC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_2-阶梯价格与区间查找-volume-tiering" tabindex="-1">2. 阶梯价格与区间查找 (Volume Tiering) <a class="header-anchor" href="#_2-阶梯价格与区间查找-volume-tiering" aria-label="Permalink to &quot;2. 阶梯价格与区间查找 (Volume Tiering)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>“1-99 个：10元；100-499 个：9.5元；500个以上：9元”。</p><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>避免多行 Join</strong>: 将阶梯区间存储为 <code>numrange</code>。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 利用 @&gt; 操作符秒级匹配数量区间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tiered_price </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sal_price_tier </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> price_list_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> qty_range @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :current_qty; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 例如 [100, 500) @&gt; 250</span></span></code></pre></div></li></ul><hr><h2 id="_3-折扣叠加与足迹追踪-discount-stacking" tabindex="-1">3. 折扣叠加与足迹追踪 (Discount Stacking) <a class="header-anchor" href="#_3-折扣叠加与足迹追踪-discount-stacking" aria-label="Permalink to &quot;3. 折扣叠加与足迹追踪 (Discount Stacking)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>一个订单可能同时应用：渠道折扣（95折）、限时立减（-10元）、新客返利（2%）。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>折扣序列化</strong>: 必须在数据库中定义 <code>discount_sequence</code>（如：10-减法，20-比例）。</li><li><strong>足迹存储</strong>: 在订单行中使用 JSONB 记录应用过程：<code>[{&quot;type&quot;: &quot;minus&quot;, &quot;val&quot;: 10}, {&quot;type&quot;: &quot;ratio&quot;, &quot;val&quot;: 0.95}]</code>。</li><li><strong>精度控制</strong>: 每一层折扣计算后的中间值必须使用 <code>ROUND(val, 4)</code> 或更高精度。</li></ul><hr><h2 id="_4-价格硬拦截与审计-price-guard" tabindex="-1">4. 价格硬拦截与审计 (Price Guard) <a class="header-anchor" href="#_4-价格硬拦截与审计-price-guard" aria-label="Permalink to &quot;4. 价格硬拦截与审计 (Price Guard)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>防止销售人员由于误操作或恶意竞争，以低于成本的价格销售。</p><h3 id="技术实现建议-2" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-2" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>动态底价</strong>: 底价 = <code>最新入库成本 * (1 + 利润率参数)</code>。</li><li><strong>授权重写</strong>: 如果确实需要亏本销售，必须关联一个“特批流程 ID (Workflow_ID)”。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 触发器中的底价校验</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unit_price</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_allowed_price </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_item_cost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">special_approve_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">THEN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RAISE EXCEPTION </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ERR_PRICE_VIOLATION: 成交价低于系统底线且未经过特批&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>数值精度</strong>: 所有的单价、折扣、总额计算是否统一使用 <code>numeric(24, 12)</code>？</li><li>[ ] <strong>寻价性能</strong>: 价格表记录过万时，是否通过 GIST 索引优化了日期范围检索？</li><li>[ ] <strong>重定价触发</strong>: 订单日期、客户、数量发生变化时，是否触发了“自动重新寻价”？</li><li>[ ] <strong>手动改价标记</strong>: 如果用户手动修改了自动取出的价格，是否在 <code>price_source</code> 标记为 <code>Manual</code>？</li><li>[ ] <strong>币种汇率</strong>: 价格表币种与订单币种不一致时，是否正确应用了 <code>TransRate</code> 进行折算？</li><li>[ ] <strong>缓存策略</strong>: 对于频繁读取的全局基准价，是否考虑在应用层缓存或使用 PostgreSQL 的 <code>Materialized View</code>？</li></ul>`,36)])])}const E=i(l,[["render",e]]);export{g as __pageData,E as default};
