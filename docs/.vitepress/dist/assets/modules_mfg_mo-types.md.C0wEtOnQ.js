import{_ as i,c as a,o as t,ae as l}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"生产订单管理 (MO) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/mfg/mo-types.md","filePath":"modules/mfg/mo-types.md"}'),n={name:"modules/mfg/mo-types.md"};function e(h,s,o,r,k,p){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="生产订单管理-mo-开发者详尽指南" tabindex="-1">生产订单管理 (MO) - 开发者详尽指南 <a class="header-anchor" href="#生产订单管理-mo-开发者详尽指南" aria-label="Permalink to &quot;生产订单管理 (MO) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>生产订单（MO）是 ERP 系统的“施工单”。开发者必须理解：MO 是 <strong>BOM + 工艺路线 + 成本中心</strong> 的聚合体。它的核心逻辑在于：将“静态的定义”转化为“动态的执行”，并在这个过程中严格控制<strong>料、工、费</strong>的流向。</p><hr><h2 id="_1-订单类型、版本化与委外损耗管理-mo-types-revision" tabindex="-1">1. 订单类型、版本化与委外损耗管理 (MO Types &amp; Revision) <a class="header-anchor" href="#_1-订单类型、版本化与委外损耗管理-mo-types-revision" aria-label="Permalink to &quot;1. 订单类型、版本化与委外损耗管理 (MO Types &amp; Revision)&quot;">​</a></h2><h3 id="企业痛点" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><ul><li><strong>成本隔离</strong>: “返工领的料全算进了标准成本，导致分析全乱了”。</li><li><strong>变更追溯</strong>: “MO 已经发给车间了，突然改了 BOM，车间却不知道改了什么”。</li></ul><h3 id="开发逻辑点" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>类型路由</strong>: 开发者需通过 <code>MO_Type</code> 驱动逻辑。</li><li><strong>全量版本化 (Full Versioning)</strong>: 生产订单 (MO) 必须支持版本追踪。变更即升版，旧快照存入 <code>mo_history</code>。</li><li><strong>委外损耗与所有权处置</strong>: <ul><li>开发者需提供 <code>Subcontract_Scrap_Report</code> 接口。</li><li><strong>逻辑</strong>: <code>委外商库存 = 发出量 - 完工扣料量 - 报损量</code>。</li><li><strong>所有权处置策略 (Ownership Policy)</strong>: <ul><li><strong>实物退回 (Physical Return)</strong>: 损耗/余料必须实物退回到企业的“委外损耗仓”。</li><li><strong>金额扣减 (Cost Offset)</strong>: 经审批后，损耗直接折算为金额，从支付给委外商的加工费中扣除。</li></ul></li></ul></li><li><strong>成本隔离</strong>: 确保 <code>Cost_Center</code> 和 <code>MO_Type</code> 是核心查询维度。</li></ul><h3 id="postgresql-实现建议" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>JSONB 记录委外属性与快照</strong>: 存储委外商 ID、预计回收率、以及审核时的 <code>mo_history</code> 快照。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 记录 MO 变更历史</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_history (mo_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">snapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, to_jsonb(mo_header.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_header </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id;</span></span></code></pre></div></li></ul><hr><h2 id="_2-备料明细的动态生成-component-list-logic" tabindex="-1">2. 备料明细的动态生成 (Component List Logic) <a class="header-anchor" href="#_2-备料明细的动态生成-component-list-logic" aria-label="Permalink to &quot;2. 备料明细的动态生成 (Component List Logic)&quot;">​</a></h2><h3 id="企业痛点-1" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-1" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“BOM 改了，已经开工的订单没跟着改，结果领错了料”</strong>。</p><h3 id="开发逻辑点-1" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-1" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>快照机制</strong>: <ul><li>当 MO 审核时，开发者需将当前的 BOM 结构<strong>持久化</strong>到 <code>MO_Component_List</code> 表中。</li><li><strong>不要</strong>直接在 UI 上展示主 BOM 关联查询，因为主 BOM 会变，而生产现场必须按“开工那一刻”的版本执行。</li></ul></li><li><strong>同步引擎</strong>: <ul><li>如果用户确实想同步最新 BOM，开发者需提供一个 <code>Update_Component_List</code> 接口。</li><li><strong>开发注意</strong>: 必须检查“已领料量”，如果已领料，则不允许随意删除备料行。</li></ul></li></ul><h3 id="postgresql-实现建议-1" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-1" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>JSONB 存储快照</strong>: 将审核时的完整 BOM 树以 <code>JSONB</code> 格式存储在 <code>mo_header.bom_snapshot</code> 中，既保留了原始结构，又方便进行版本比对。</li><li><strong>触发器保护数据</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check_material_issued</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRIGGER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  IF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_material_issue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> component_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OLD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> issued_qty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">THEN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RAISE EXCEPTION </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Cannot delete component that has already been issued.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  RETURN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OLD;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql;</span></span></code></pre></div></li><li><strong>批量插入优化</strong>: 同步 BOM 时，使用 <code>INSERT INTO ... SELECT</code> 结合 <code>ON CONFLICT</code> 语法，实现高效的增量更新。</li></ul><hr><h2 id="_3-状态机的原子性切换-state-machine" tabindex="-1">3. 状态机的原子性切换 (State Machine) <a class="header-anchor" href="#_3-状态机的原子性切换-state-machine" aria-label="Permalink to &quot;3. 状态机的原子性切换 (State Machine)&quot;">​</a></h2><h3 id="企业痛点-2" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-2" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p>“订单显示已结案，但仓库还在给它发料”。</p><h3 id="开发逻辑点-2" tabindex="-1">开发逻辑点 <a class="header-anchor" href="#开发逻辑点-2" aria-label="Permalink to &quot;开发逻辑点&quot;">​</a></h3><ul><li><strong>硬性约束</strong>: <ul><li>开发者需在领料、报工、完工入库的 API 入口处增加 <code>Status_Check</code>。</li><li><strong>逻辑</strong>: <code>IF (MO.Status NOT IN (&#39;Approved&#39;, &#39;Released&#39;)) THEN REJECT_TRANSACTION</code>。</li></ul></li><li><strong>状态回滚</strong>: <ul><li>结案（Close）是一个复杂的事务，涉及 WIP 结转。开发者必须确保该操作的幂等性，并支持在特定条件下的“反结案”操作。</li></ul></li></ul><h3 id="postgresql-实现建议-2" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-2" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>行级安全策略 (RLS)</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_status_control </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_component_list</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_header </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mo_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Approved&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Released&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li><li><strong>状态变更记录 (Audit Table)</strong>: 使用触发器自动将状态变更记录到 <code>mo_status_history</code> 表中，包含操作人、时间、旧状态、新状态，利用 <code>JSONB</code> 记录变更上下文。</li><li><strong>事务保存点 (SAVEPOINT)</strong>: 在结案等复杂事务中，利用 <code>SAVEPOINT</code> 实现局部回滚，提高系统的容错能力。</li></ul><hr><h2 id="_4-关键指标计算-kpi-calculation" tabindex="-1">4. 关键指标计算 (KPI Calculation) <a class="header-anchor" href="#_4-关键指标计算-kpi-calculation" aria-label="Permalink to &quot;4. 关键指标计算 (KPI Calculation)&quot;">​</a></h2><h3 id="企业痛点-3" tabindex="-1">企业痛点 <a class="header-anchor" href="#企业痛点-3" aria-label="Permalink to &quot;企业痛点&quot;">​</a></h3><p><strong>“经理问我生产进度是多少，我算不出来”</strong>。</p><h3 id="开发算法" tabindex="-1">开发算法 <a class="header-anchor" href="#开发算法" aria-label="Permalink to &quot;开发算法&quot;">​</a></h3><ul><li><strong>进度百分比</strong>: <code>Progress = (已完工入库量 / 订单计划量) * 100%</code>。</li><li><strong>料品齐套率</strong>: <code>Kitting_Rate = (已领料项数 / 总备料项数) * 100%</code>。</li><li><strong>损耗率异常报警</strong>: <code>IF (实际领料 &gt; 标准用量 * (1 + 预设损耗率)) THEN 发送消息通知 QC</code>。</li></ul><h3 id="postgresql-实现建议-3" tabindex="-1">PostgreSQL 实现建议 <a class="header-anchor" href="#postgresql-实现建议-3" aria-label="Permalink to &quot;PostgreSQL 实现建议&quot;">​</a></h3><ul><li><strong>生成列 (Generated Columns)</strong>: 对于简单的进度计算，可以使用存储生成的列：<code>progress NUMERIC GENERATED ALWAYS AS (completed_qty / plan_qty) STORED</code>。</li><li><strong>窗口函数汇总</strong>: 使用 <code>SUM(...) OVER(PARTITION BY ...)</code> 实时计算各车间、各生产线的累计产出与达成率。</li><li><strong>异步报警机制</strong>: 配合 <code>pg_cron</code> 或外部监控工具，定期扫描损耗异常记录，并通过 <code>NOTIFY</code> 触发即时通讯提醒。</li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>多单位换算</strong>: MO 计划单位（件）与库存单位（公斤）不一致时，是否处理了精度丢失问题？</li><li>[ ] <strong>并发锁</strong>: 在执行“下达”操作（占用库存）时，是否对涉及的物料使用了行级锁？</li><li>[ ] <strong>变更记录</strong>: MO 的每一次手动修改（加料、减料、改期）是否都记录了 <code>Change_Log</code>？</li><li>[ ] <strong>自动排产接口</strong>: 接口是否预留了对接 APS（高级排程系统）的字段（如：优先级、排程 ID）？</li></ul>`,38)])])}const E=i(n,[["render",e]]);export{g as __pageData,E as default};
