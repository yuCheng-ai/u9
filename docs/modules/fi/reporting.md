# 财务报表与数据穿透 (Financial Reporting) - 开发者详尽指南

## 概述
财务报表（Reporting）是 ERP 系统的“成绩单”。对于开发者来说，报表不只是 UI 上的表格，而是对**亿级数据量的聚合计算**。其核心挑战在于：如何在保证实时性的前提下，实现从汇总数到原始业务单据的**无缝穿透**。

---

## 1. 报表计算引擎：预汇总与缓存

### 企业痛点
**“点开资产负债表要等 1 分钟”**。如果开发者直接在亿级凭证表上执行 `SUM` 和 `GROUP BY`，系统必崩。

### 开发逻辑点
- **余额表 (Balance Table)**: 开发者需设计一套增量更新的余额表。
    - 每当一笔凭证过账，后台 Job 必须实时/近实时更新 `科目 + 期间 + 维度` 的汇总余额。
- **多维聚合**: 
    - 开发者需支持按 `组织`、`部门`、`项目`、`产品线` 等维度进行 OLAP 聚合计算。
- **性能建议**: 采用列式数据库（如 ClickHouse）或物料化视图来加速报表渲染。

---

## 2. 穿透式溯源 (Drill-down Logic)

### 企业痛点
**“利润表里这笔 100 万差旅费是怎么来的？”**。如果不能查到原始单据，报表就是废纸。

### 开发逻辑点
- **全链路追踪码 (TraceID)**: 
    - 业务单据 (GUID) -> 凭证 (VoucherID) -> 报表项 (ReportItemID)。
- **实现方式**: 
    - 在报表 UI 上，开发者需为每个单元格挂载 `OnClick` 事件。
    - 后端接口需支持按 `AccountID + Period + Dimension` 反查出所有的凭证分录。
    - 再通过凭证的 `SourceID` 路由到具体的业务单据详情页（如：费用报销单）。

---

## 3. 内部往来抵销 (Inter-Company Elimination)

### 企业痛点
集团内 A 卖给 B 100 万。在集团合并报表时，这 100 万收入和 100 万成本必须**抹掉**，否则集团虚增了利润。

### 开发逻辑点
- **对账引擎**: 开发者需实现一个“往来核对表”，自动识别两边不匹配的差额（如：A 已发货，B 未收货）。
- **抵销分录模板**: 
    - 开发者需设计自动化抵销规则。
    - `逻辑: IF (Account == '内部销售收入' && Partner == '成员单位') THEN 生成抵销分录`。

---

## 4. 自定义报表平台 (Report Designer)

### 企业痛点
**“财务想改一个公式，就要找开发写半天代码”**。

### 开发逻辑点
- **公式解析器**: 开发者需实现一套类似 Excel 的语法解析。
    - `QC("1001", "2023-01")` 代表取 1001 科目 1 月份的期初余额。
- **模板引擎**: 允许用户上传 Excel 模板，开发者在后端使用 `POI` 或 `EasyExcel` 进行单元格填充。

---

## 5. 开发者 Checklist

- [ ] **数据快照**: 报表是否记录了“生成时间”？（防止因为历史数据变动导致报表前后不一致）。
- [ ] **权限控制**: 报表是否实现了行级权限？（例如：华东区经理只能看华东区的报表）。
- [ ] **导出性能**: 导出 10 万行报表时，是否采用了流式输出（Streaming Output）防止 OOM？
- [ ] **差异标记**: 报表是否能自动检测并高亮显示“借贷不平”或“业财不符”的异常单元格？
