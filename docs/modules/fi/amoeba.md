# 阿米巴经营会计 (Amoeba) - 开发者详尽指南

## 概述
U9 阿米巴经营会计是基于稻盛和夫经营哲学的落地实践。对于开发者而言，阿米巴系统的核心是将业务活动**多维化、颗粒化**。它通过“管理账簿”在法定财务核算之外，并行运行一套独立的经营损益逻辑。

**开发者的核心目标**：确保每一笔业务单据（领料、入库、销售等）都能在正确的时间、以正确的内部价格、映射到正确的阿米巴单元损益中。

---

## 1. 核心模型与技术对象

### 1.1 核算单元 (Amoeba Unit)
在系统底层，阿米巴单元并不是一个简单的“部门”字段，而是一个**多维映射实体**。
- **映射关系**: 开发者需要关注 `AmoebaOrg` 与 `BaseOrg` (法人组织)、`Department` (部门)、`WorkCenter` (工作中心) 的映射表。
- **属性**:
    - `Type`: 制造型（利润中心）、销售型（利润中心）、职能型（费用/服务中心）。
    - `Level`: 支持树状递归查询，用于损益逐级汇总。

### 1.2 内部交易记录 (Internal Trading Record)
这是阿米巴核算的“灵魂”。每当货物或服务在两个单元间流转，系统需生成一条内部交易记录。
- **触发源**: 
    - 调拨单 (Transfer Order)
    - 完工入库单 (Production Completion)
    - 跨部门领料 (Internal Requisition)
- **核心字段**: `Sender_Amoeba`, `Receiver_Amoeba`, `Price_Policy_ID`, `Quantity`, `Amount`.

---

## 2. 内部定价逻辑 (Price Determination) - 开发逻辑重难点

开发者必须实现的定价优先级逻辑如下：

1.  **协议定价 (Contract Price)**: 检查两个特定阿米巴单元之间是否存在生效的协议价格表。
2.  **标准/市场价 (Standard Price)**: 若无协议价，查找物料主文件或价格库中的“内部参考价”。
3.  **成本加成 (Cost Plus)**: 
    - `公式: 内部结算价 = 实际成本 * (1 + 利润率)`
    - 开发者需实时计算前序工序的累积成本。
4.  **手动调整 (Manual Adjustment)**: 允许在特定权限下对系统计算的价格进行干预，并记录审计日志。

---

## 3. 核心算法与损益计算

### 3.1 损益计算公式 (P&L Formula)
阿米巴的损益不是简单的“收入 - 成本”，其核心是**“经营利润”**。

```text
经营利润 = 内部交易收入 + 外部销售收入 
          - 内部交易成本 (买入) 
          - 直接费用 (差旅、辅料等) 
          - 共享费用分摊 (房租、折旧等)
```

### 3.2 费用分摊算法 (Allocation Logic)
开发者需支持以下分摊引擎：
- **静态权重**: 按固定比例分摊（如：行政费按各单元人数占比）。
- **动态驱动**: 
    - 按面积分摊（房租）。
    - 按机器工时分摊（折旧）。
    - 按收入占比分摊（集团管理费）。
- **递归分摊**: 职能部门 A 分摊给职能部门 B，再由 B 分摊给业务部门。系统需防止死循环。

### 3.3 单位时间核算 (Hourly Value)
这是衡量阿米巴效率的终极指标。
- `公式: 单位时间附加值 = (经营利润 + 劳务费) / 总劳动时间`
- **开发注意**: 需集成 HR 模块或考勤系统获取“总劳动时间”。

---

## 4. 系统集成与 AEP 映射

阿米巴数据不是独立录入的，而是通过 **自动会计平台 (AEP)** 从业务流中“截流”出来的。

1.  **业务触发**: 仓储人员审核《领料单》。
2.  **AEP 路由**: 
    - **路由 A**：映射至法定账簿（CAS），生成：`借：生产成本，贷：原材料`。
    - **路由 B**：映射至阿米巴账簿，生成：`借：A阿米巴-材料费，贷：B阿米巴-内部收入`。
3.  **多账簿隔离**: 确保阿米巴的内部结算不影响法定财务报表的利润。

---

## 5. 开发者 checklist (必读)

- [ ] **性能优化**: 内部交易触发频率极高，必须采用异步处理或批量计算模式，避免阻塞业务单据过账。
- [ ] **数据回溯**: 当内部价格在月中调整时，系统必须提供“重算”功能，追溯调整已生成的损益记录。
- [ ] **颗粒度控制**: 系统应支持从损益表的“材料费”一键穿透到最底层的“出库单”明细。
- [ ] **异常处理**: 当定价规则缺失时，应有默认处理逻辑（如记录异常、推送到审批流），而非直接报错阻断业务。

---

## 6. 常见业务场景 (Logic Walkthrough)

| 场景 | 业务动作 | 阿米巴逻辑处理 |
| :--- | :--- | :--- |
| **内部买卖** | 车间 A 生产出半成品给车间 B | 减少 A 库存，增加 A 内部收入；增加 B 内部成本。 |
| **公共分摊** | 集团支付了 100 万电费 | 根据各阿米巴单元上报的用电读数，按比例扣减各单元利润。 |
| **借调人力** | 销售部借用 IT 部开发一个小工具 | 销售部记录一笔“服务支出”，IT 部记录一笔“内部劳务收入”。 |

---

## 7. 相关参考文档
- [多账簿体系 (Multi-Book)](file:///Users/dingshaoxiong/yuCheng-ai/u9/docs/modules/fi/multi-book.md)
- [自动会计平台 (AEP) 配置指南](file:///Users/dingshaoxiong/yuCheng-ai/u9/docs/platform/aep.md)
