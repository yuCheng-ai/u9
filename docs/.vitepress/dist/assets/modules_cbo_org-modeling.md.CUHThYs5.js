import{_ as i,c as a,o as n,ae as l}from"./chunks/framework.CDjunVez.js";const o=JSON.parse('{"title":"企业建模 (Organization Modeling) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/cbo/org-modeling.md","filePath":"modules/cbo/org-modeling.md"}'),t={name:"modules/cbo/org-modeling.md"};function h(k,s,e,p,r,d){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="企业建模-organization-modeling-开发者详尽指南" tabindex="-1">企业建模 (Organization Modeling) - 开发者详尽指南 <a class="header-anchor" href="#企业建模-organization-modeling-开发者详尽指南" aria-label="Permalink to &quot;企业建模 (Organization Modeling) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>企业建模（Org Modeling）是 ERP 的“灵魂”。在多组织架构下，组织不仅仅是一个 <code>ID</code>，它是一组<strong>职能开关</strong>。开发者必须理解如何处理组织职能的解耦、数据的强隔离以及组织间的业务协同，以确保系统能够支撑复杂的集团化运作。</p><hr><h2 id="_1-职能建模-组织的-基因-定义" tabindex="-1">1. 职能建模：组织的“基因”定义 <a class="header-anchor" href="#_1-职能建模-组织的-基因-定义" aria-label="Permalink to &quot;1. 职能建模：组织的“基因”定义&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>在集团企业中，一个组织（地点）可能同时承担多种角色：它既是生产货物的“工厂”，又是存放货物的“仓库”，还可能是对外开票的“会计主体”。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>职能解耦</strong>: 严禁在代码中硬编码“如果是 A 组织就执行销售逻辑”。应判断“当前组织是否具备销售职能”。</li><li><strong>动态控制</strong>: UI 菜单和业务按钮必须基于 <code>Org.Functions</code> 动态渲染。</li><li><strong>技术实现建议</strong>: <ul><li>推荐使用<strong>枚举数组 (Enum Array)</strong> 存储职能。这种方式比增加几十个布尔字段更易于扩展。</li><li>在数据库层面，可以使用 <code>GIN 索引</code> 确保在成千上万个组织中秒级筛选出具备特定职能（如 <code>Mfg</code>）的实体。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用枚举数组定义职能</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TYPE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> org_func</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ENUM (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Sales&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Mfg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Inv&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Fi&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN functions org_func[];</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建 GIN 索引优化职能检索</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_org_functions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> GIN (functions);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查询具备生产职能的组织</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> functions @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ARRAY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[&#39;Mfg&#39;::org_func];</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_2-数据隔离与-rbac-权限继承-isolation-rbac" tabindex="-1">2. 数据隔离与 RBAC 权限继承 (Isolation &amp; RBAC) <a class="header-anchor" href="#_2-数据隔离与-rbac-权限继承-isolation-rbac" aria-label="Permalink to &quot;2. 数据隔离与 RBAC 权限继承 (Isolation &amp; RBAC)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><ul><li><strong>行级隔离</strong>: 分公司 A 的业务员绝对不能查看到分公司 B 的库存或单据。</li><li><strong>权限继承</strong>: 集团管理员在“集团”维度分配的权限，应能自动下发到所有子公司；但子公司管理员只能管理本公司的权限。</li></ul><h3 id="开发规范-1" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-1" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>权限向下继承</strong>: <ul><li>权限分配表 <code>sys_permission</code> 需包含 <code>org_id</code> 和 <code>is_inherit</code> 标志。</li><li>当 <code>is_inherit = true</code> 时，该权限对当前组织及其所有下级子组织生效。</li></ul></li><li><strong>上下文透明</strong>: 每一个 API 请求都必须携带 <code>OrgID</code>。开发者应通过 <code>Context</code> 对象获取当前操作组织。</li></ul><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>递归权限判定</strong>: 利用 PostgreSQL 的 <strong>Recursive CTE</strong> 向上查找当前用户在当前组织及其父级组织（带继承标志）的所有权限并取并集。</li><li><strong>行级安全 (RLS)</strong>: <ul><li>开发者只需在会话开始时设置 <code>SET LOCAL app.current_org_id = &#39;...&#39;</code>。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 递归查询权限（考虑继承）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RECURSIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_tree </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id, parent_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :current_org</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    UNION ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_master o </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_tree ot </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sys_permission p</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_tree ot </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">org_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">org_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :current_org </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OR</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_inherit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true);</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_3-组织协同-内部交易与-抛单" tabindex="-1">3. 组织协同：内部交易与“抛单” <a class="header-anchor" href="#_3-组织协同-内部交易与-抛单" aria-label="Permalink to &quot;3. 组织协同：内部交易与“抛单”&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p><strong>“左手卖给右手”</strong>。总公司卖给分公司，分公司录入《内部采购单》后，系统应自动在总公司生成《销售订单》，并保持两者价格和状态的同步。</p><h3 id="开发规范-2" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-2" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>协议驱动</strong>: 组织间的交易规则（如内部协议价、自动审核逻辑）应参数化配置。</li><li><strong>异步链路</strong>: 协同单据的生成应避免阻塞主业务流程。</li><li><strong>技术实现建议</strong>: <ul><li>使用 <code>JSONB</code> 字段存储灵活的协同协议参数。</li><li>利用数据库的<strong>逻辑日志 (Logical Decoding)</strong> 或事件总线监听单据状态，实现跨组织的异步单据抛转。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用 JSONB 存储组织协同协议</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org_inter_rules </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source_org </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :src </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target_org </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :dest</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;auto_approve&quot;: true}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_4-严谨性校验-有效期与业务冲突" tabindex="-1">4. 严谨性校验：有效期与业务冲突 <a class="header-anchor" href="#_4-严谨性校验-有效期与业务冲突" aria-label="Permalink to &quot;4. 严谨性校验：有效期与业务冲突&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>一个物料在同一个组织下，不能在同一时间段内有两个不同的“默认供应商”或“核算价格”。</p><h3 id="开发规范-3" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范-3" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>时段闭环</strong>: 所有的分配关系（如物料分配给组织）必须包含有效期（开始日期/结束日期）。</li><li><strong>重叠校验</strong>: 在保存时，必须校验新时段与已有时段是否冲突。</li><li><strong>技术实现建议</strong>: <ul><li>使用 <strong>Range Types (范围类型)</strong> 存储有效期。</li><li>在表结构上应用 <strong>排除约束 (Exclusion Constraints)</strong>。这能确保数据库在物理层面拦截任何时间重叠的错误数据，比在 Java/C# 代码中写循环校验更安全高效。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 使用范围类型和排除约束防止时间重叠</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_org_price </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN validity tstzrange;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_org_price </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CONSTRAINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> price_time_no_overlap </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXCLUDE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gist (item_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, org_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, validity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp;);</span></span></code></pre></div></li></ul></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>职能判断</strong>: 业务逻辑是否基于 <code>Org.Functions</code> 数组判断，而非硬编码 ID？</li><li>[ ] <strong>隔离透传</strong>: 是否在数据库连接初始化时正确设置了组织上下文（如 RLS 上下文）？</li><li>[ ] <strong>性能优化</strong>: 涉及组织职能或 JSON 协议的查询，是否创建了对应的 GIN 索引？</li><li>[ ] <strong>冲突拦截</strong>: 涉及有效期的配置表，是否在 DB 层配置了防止时段重叠的约束？</li><li>[ ] <strong>数据合规</strong>: 所有的更新和删除操作，是否确保无法越权修改非当前组织的数据？</li></ul>`,32)])])}const E=i(t,[["render",h]]);export{o as __pageData,E as default};
