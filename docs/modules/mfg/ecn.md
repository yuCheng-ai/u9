# ECN 工程变更 (ECN) - 开发者详尽指南

## 概述
工程变更（ECN/ECR）是制造企业的“手术刀”。开发者必须意识到：ECN 不只是修改一张表，它是一系列**连锁反应的触发器**。如果逻辑不严密，会导致生产线领错料、库存呆滞或成品报废。

---

## 1. 变更范围与冲突检测 (Impact Analysis)

### 企业痛点
**“改了一个螺丝，结果 100 个订单都要重算”**。开发者如果不能自动识别受影响的范围，用户就得一个一个手动改。

### 开发逻辑点
- **受影响范围扫描**: 
    - 开发者需实现一个“反查引擎”。当某个子件被替换时，自动扫描所有引用该子件的 `BOM`、未结案的 `生产订单 (MO)`、已下达的 `采购订单 (PO)`。
- **冲突检测**: 
    - 如果 ECN 设置的生效日期早于当前正在生产的订单日期，系统必须报警，询问用户是“立即切换”还是“自然切换”。

---

## 2. 在制品 (WIP) 的处理策略 (WIP Handling)

### 企业痛点
变更发生时，生产线上还有 50 个半成品。是拆掉重装？还是继续做完？

### 开发逻辑点
- **策略配置**: ECN 必须包含 `WIP_Policy` 字段：
    - `UseUp`: 旧料用完为止，不影响现有 MO。
    - `Scrap`: 立即报废旧料，现有 MO 必须强制补单发新料。
    - `Rework`: 现有 MO 暂停，退料，重新按新 BOM 备料。
- **自动改单引擎**: 开发者需编写一个批处理逻辑，根据策略自动更新 `MO_Component_List`（生产备料明细），而不是直接改主 BOM。

---

## 3. 版本断点控制 (Break-point Control)

### 企业痛点
**“我要知道从哪个序列号开始是新版本”**。

### 开发逻辑点
- **断点标记**: 开发者需在 `ECN_Execution` 表记录变更发生的 `MOID` 或 `LotNumber`。
- **质量追溯集成**: 开发者在质量模块查询时，必须能根据 `ECN_ID` 过滤出所有变更后的批次。

---

## 4. ECN 的事务一致性

### 企业痛点
变更审批通过了，但 BOM 没更新成功，或者只更新了一部分。

### 开发逻辑点
- **原子化执行**: ECN 的生效操作必须包裹在一个大的数据库事务中。
    - 1. 更新主 BOM 版本。
    - 2. 更新料品主档属性（如有）。
    - 3. 产生变更历史快照。
    - 4. 触发 MRP 重算信号。
- **快照保存**: 开发者必须保存变更前的 BOM 快照，以便在出现质量争议时进行历史溯源。

---

## 5. 开发者 Checklist

- [ ] **附件关联**: ECN 是否强制要求上传变更图纸/技术协议？
- [ ] **权限隔离**: 只有 `Engineering` 角色的用户能发起变更，只有 `Production_Manager` 能决定 WIP 的处理方式。
- [ ] **通知引擎**: 变更生效后，是否通过 MQ 自动通知了采购部（停止买旧料）和仓库（隔离旧料库存）？
- [ ] **多级审核**: 复杂的变更是否支持“技术审批 -> 财务审批 -> 生产审批”的多级流转？
