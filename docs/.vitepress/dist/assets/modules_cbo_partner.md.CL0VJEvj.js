import{_ as i,c as a,o as t,ae as n}from"./chunks/framework.CDjunVez.js";const g=JSON.parse('{"title":"客供档案与信用控制 (Partner & Credit) - 开发者详尽指南","description":"","frontmatter":{},"headers":[],"relativePath":"modules/cbo/partner.md","filePath":"modules/cbo/partner.md"}'),h={name:"modules/cbo/partner.md"};function l(e,s,k,p,r,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="客供档案与信用控制-partner-credit-开发者详尽指南" tabindex="-1">客供档案与信用控制 (Partner &amp; Credit) - 开发者详尽指南 <a class="header-anchor" href="#客供档案与信用控制-partner-credit-开发者详尽指南" aria-label="Permalink to &quot;客供档案与信用控制 (Partner &amp; Credit) - 开发者详尽指南&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>合作伙伴（Partner）是企业价值链的延伸。在开发逻辑中，合作伙伴不仅是“通讯录”，更是<strong>风控引擎</strong>的核心输入。开发者必须处理好“一实体多角色”的业务模型，并利用数据库的<strong>并发控制</strong>和<strong>地理空间特性</strong>，确保信用拦截的严密性与物流计算的准确性。</p><hr><h2 id="业务痛点与开发对策" tabindex="-1">业务痛点与开发对策 <a class="header-anchor" href="#业务痛点与开发对策" aria-label="Permalink to &quot;业务痛点与开发对策&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">业务痛点</th><th style="text-align:left;">技术对策</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>一实体多角色</strong>：既是客户又是供应商，往来款项碎片化。</td><td style="text-align:left;"><strong>实体-角色模型 (Entity-Role)</strong>：底层表按实体（Partner_Main）存储，业务层按角色（Customer/Supplier）通过 JSONB 扩展属性。利用 <code>UNION ALL</code> 视图实现全口径对账。</td></tr><tr><td style="text-align:left;"><strong>信用“超卖”</strong>：高并发下单导致信用额度被击穿。</td><td style="text-align:left;"><strong>行级锁 + 增量控制 (Pessimistic Control)</strong>：使用 <code>FOR UPDATE</code> 锁定信用余额行，并采用 <code>used = used + delta</code> 的增量扣减逻辑，严禁“先读后写”的非原子操作。</td></tr><tr><td style="text-align:left;"><strong>资质过期风险</strong>：供应商证照过期却依然产生了采购订单。</td><td style="text-align:left;"><strong>时效性硬约束</strong>：利用 PostgreSQL 的 <code>daterange</code> 类型对资质有效期进行存储，并在订单保存事务中利用 <code>@&gt;</code> 操作符进行 API 级拦截。</td></tr><tr><td style="text-align:left;"><strong>地址库混乱</strong>：多个收货地址缺乏地理坐标，运费核算不准。</td><td style="text-align:left;"><strong>PostGIS 地理空间索引</strong>：引入 <code>geometry(Point)</code> 存储经纬度，利用 <code>ST_Distance</code> 自动化计算物流半径，支持精准的阶梯运费核算。</td></tr></tbody></table><hr><h2 id="_1-核心模型-一实体多角色与全口径对账" tabindex="-1">1. 核心模型：一实体多角色与全口径对账 <a class="header-anchor" href="#_1-核心模型-一实体多角色与全口径对账" aria-label="Permalink to &quot;1. 核心模型：一实体多角色与全口径对账&quot;">​</a></h2><h3 id="业务场景" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>大型集团通常具有双重身份：既买产品（客户），又卖原材料（供应商）。财务需要“一键抵消”双向往来款。</p><h3 id="技术实现建议" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>统一余额视图</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 实时汇总同一实体在不同角色下的应收/应付</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> VIEW</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> v_partner_net_balance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COALESCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ar_balance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ar_amount, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 应收</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COALESCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ap_balance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ap_amount, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 应付</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">COALESCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ar_balance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> COALESCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ap_balance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> net_amount </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 净往来</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_main p</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> customer_ext c </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partner_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> supplier_ext s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partner_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div></li></ul><hr><h2 id="_2-严密的信用控制引擎-credit-engine" tabindex="-1">2. 严密的信用控制引擎 (Credit Engine) <a class="header-anchor" href="#_2-严密的信用控制引擎-credit-engine" aria-label="Permalink to &quot;2. 严密的信用控制引擎 (Credit Engine)&quot;">​</a></h2><h3 id="业务场景-1" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-1" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>信用控制是 ERP 的安全红线。必须确保在高并发下单（如双十一）时，信用额度不会被击穿。</p><h3 id="开发规范" tabindex="-1">开发规范 <a class="header-anchor" href="#开发规范" aria-label="Permalink to &quot;开发规范&quot;">​</a></h3><ul><li><strong>原子性扣减</strong>: 严禁在应用层做加减法。必须在数据库层通过一个 <code>UPDATE</code> 语句完成。</li><li><strong>示例代码</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 原子性信用扣减（带超限拦截）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_credit </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> used_amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> used_amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :order_amount </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :id </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (credit_limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> used_amount) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :order_amount </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 核心：在 SQL 层做余量校验</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RETURNING used_amount;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 如果执行返回的行数为 0，立即抛出“信用额度不足”异常并回滚事务。</span></span></code></pre></div></li></ul><hr><h2 id="_3-地址库与物流半径计算-postgis-integration" tabindex="-1">3. 地址库与物流半径计算 (PostGIS Integration) <a class="header-anchor" href="#_3-地址库与物流半径计算-postgis-integration" aria-label="Permalink to &quot;3. 地址库与物流半径计算 (PostGIS Integration)&quot;">​</a></h2><h3 id="业务场景-2" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-2" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>根据收货地址的坐标，自动计算工厂到客户的距离，从而匹配不同的运费策略。</p><h3 id="技术实现建议-1" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-1" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>地理坐标存储</strong>: 使用 <code>geometry(Point, 4326)</code>。</li><li><strong>距离计算</strong>:<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 计算工厂（Point A）到收货地址（Point B）的球面距离（单位：米）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ST_Distance(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ST_MakePoint(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">116</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">40</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">39</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">90</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">geography</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 工厂坐标</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  delivery_point::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">geography</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> -- 客户坐标</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> distance_meters</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :address_id;</span></span></code></pre></div></li></ul><hr><h2 id="_4-准入合规与快照审计-audit-trail" tabindex="-1">4. 准入合规与快照审计 (Audit Trail) <a class="header-anchor" href="#_4-准入合规与快照审计-audit-trail" aria-label="Permalink to &quot;4. 准入合规与快照审计 (Audit Trail)&quot;">​</a></h2><h3 id="业务场景-3" tabindex="-1">业务场景 <a class="header-anchor" href="#业务场景-3" aria-label="Permalink to &quot;业务场景&quot;">​</a></h3><p>合作伙伴的关键信息（如信用等级、银行账号）变更必须可追溯。</p><h3 id="技术实现建议-2" tabindex="-1">技术实现建议 <a class="header-anchor" href="#技术实现建议-2" aria-label="Permalink to &quot;技术实现建议&quot;">​</a></h3><ul><li><strong>JSONB 变更审计</strong>: 在 Trigger 中记录变更快照。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 记录合作伙伴档案变更足迹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_audit_log (partner_id, changed_by, old_data, new_data)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NEW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, :current_user, to_jsonb(OLD), to_jsonb(NEW));</span></span></code></pre></div></li><li><strong>资质校验</strong>: 订单保存时拦截。<div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 校验供应商资质是否覆盖订单日期</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_cert </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> partner_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :vendor_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> validity_range @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :order_date;</span></span></code></pre></div></li></ul><hr><h2 id="_5-开发者-checklist" tabindex="-1">5. 开发者 Checklist <a class="header-anchor" href="#_5-开发者-checklist" aria-label="Permalink to &quot;5. 开发者 Checklist&quot;">​</a></h2><ul><li>[ ] <strong>并发安全</strong>: 信用额度预占是否使用了行级锁或原子 <code>UPDATE</code>？</li><li>[ ] <strong>一实体多角色</strong>: 是否通过统一的 <code>partner_id</code> 关联了客户与供应商角色？</li><li>[ ] <strong>资质拦截</strong>: 采购单/销售单的 <code>BeforeSave</code> 是否包含了资质有效期的强制校验？</li><li>[ ] <strong>地址规范</strong>: 是否为每一个收货地址预留了经纬度字段，并考虑了 PostGIS 扩展？</li><li>[ ] <strong>黑名单控制</strong>: 合作伙伴状态为 <code>Blacklisted</code> 时，是否在全局范围（采购/销售/物流）内被拦截？</li><li>[ ] <strong>结算协议</strong>: 是否支持“分期付款”模板，并能自动生成 <code>Payment_Plan</code> 明细？</li><li>[ ] <strong>审计留痕</strong>: 银行账号、纳税人识别号等关键敏感字段的修改是否记录了审计日志？</li></ul>`,33)])])}const o=i(h,[["render",l]]);export{g as __pageData,o as default};
